<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> IMSE Engineering Services Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-y-auto m-4">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                <h2 class="text-2xl font-bold" id="modalTitle">New Transaction</h2>
            </div>
            <form id="transactionForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <select id="txnCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="QUOTATION">Quotation</option>
                            <option value="PO">Purchase Order</option>
                            <option value="INVOICE">Invoice</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Direction</label>
                        <select id="txnDirection" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="Outgoing">Outgoing (To Client)</option>
                            <option value="Incoming">Incoming (From Subcontractor)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party</label>
                        <select id="txnParty" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Party</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Reference</label>
                        <input type="text" id="txnReference" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <select id="txnStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="Draft">Draft</option>
                            <option value="Sent">Sent</option>
                            <option value="Approved">Approved</option>
                            <option value="Completed">Completed</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold">Line Items</h3>
                        <button type="button" onclick="addLineItem()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">+ Add Item</button>
                    </div>
                    
                    <!-- Line Items Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border px-2 py-2 text-left w-12">S.No</th>
                                    <th class="border px-2 py-2 text-left min-w-[200px]">Description</th>
                                    <th class="border px-2 py-2 text-left w-24">HSN Code</th>
                                    <th class="border px-2 py-2 text-left w-20">Qty</th>
                                    <th class="border px-2 py-2 text-left w-24">UOM</th>
                                    <th class="border px-2 py-2 text-left w-28">Cost/Unit</th>
                                    <th class="border px-2 py-2 text-left w-24">Discount%</th>
                                    <th class="border px-2 py-2 text-right w-28">Taxable Amt</th>
                                    <th class="border px-2 py-2 text-left w-20">SGST%</th>
                                    <th class="border px-2 py-2 text-left w-20">CGST%</th>
                                    <th class="border px-2 py-2 text-left w-20">IGST%</th>
                                    <th class="border px-2 py-2 text-right w-28">Total</th>
                                    <th class="border px-2 py-2 text-center w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody id="lineItems">
                                <!-- Line items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="totalSection" class="mt-4 bg-indigo-50 p-4 rounded-lg hidden">
                        <div class="flex justify-end">
                            <div class="space-y-2">
                                <div class="flex justify-between gap-8">
                                    <span class="font-medium">Subtotal (Before Tax):</span>
                                    <span class="font-bold" id="subtotalAmount">₹0.00</span>
                                </div>
                                <div class="flex justify-between gap-8">
                                    <span class="font-medium">Total Tax:</span>
                                    <span class="font-bold" id="taxAmount">₹0.00</span>
                                </div>
                                <div class="flex justify-between gap-8 text-lg border-t-2 pt-2">
                                    <span class="font-bold">Grand Total:</span>
                                    <span class="font-bold text-indigo-900" id="totalAmount">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t">
                    <button type="button" onclick="closeTransactionModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Party Modal -->
    <div id="partyModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <h2 class="text-2xl font-bold" id="partyModalTitle">New Party</h2>
            </div>
            <form id="partyForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party Name *</label>
                        <input type="text" id="partyName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party Type *</label>
                        <select id="partyType" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="Client">Client</option>
                            <option value="SubContractor">SubContractor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">GST Number</label>
                        <input type="text" id="partyGST" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">PAN Number</label>
                        <input type="text" id="partyPAN" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contact Person</label>
                        <input type="text" id="partyContact" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                        <input type="email" id="partyEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Mobile</label>
                        <input type="tel" id="partyMobile" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                </div>
                <div class="flex gap-3 justify-end mt-6 pt-4 border-t">
                    <button type="button" onclick="closePartyModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION - REPLACE WITH YOUR CREDENTIALS =====
        const CLIENT_ID = '807569986194-feca4li2k0t96tbbutlpu2ko64obe95k.apps.googleusercontent.com';
        // ==========================================================

        const DISCOVERY_DOCS = [
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            "https://sheets.googleapis.com/$discovery/rest?version=v4"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        const APP_FOLDER_NAME = 'EngineeringServicesApp';

        let tokenClient;
        let accessToken = null;
        let appFolderId = null;
        let transactions = [];  // Initialize as empty array
        let parties = [];       // Initialize as empty array
        let settings = {};      // Initialize as empty object
        let currentView = 'dashboard';
        let currentTransaction = null;
        let currentParty = null;
        let lineItemCounter = 0;

        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: DISCOVERY_DOCS,
                });
                renderLoginScreen();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (response) => {
                    if (response.error) {
                        console.error('Token error:', response);
                        alert('Failed to authenticate. Please try again.');
                        return;
                    }
                    
                    if (response.access_token) {
                        accessToken = response.access_token;
                        gapi.client.setToken({ access_token: accessToken });
                        console.log('Access token received, loading data...');
                        await loadDataFromDrive();
                    }
                },
            });
        }

        function handleSignIn() {
            // Request access token with prompt to ensure user sees permission screen
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignOut() {
            const token = accessToken;
            accessToken = null;
            gapi.client.setToken(null);
            
            // Try to revoke token, but don't crash if it fails
            if (token) {
                google.accounts.oauth2.revoke(token, (done) => {
                    console.log('Access revoked:', done);
                });
            }
            
            // Reset data
            transactions = [];
            parties = [];
            settings = {};
            
            renderLoginScreen();
        }

        // Google Drive Functions
        async function getOrCreateAppFolder() {
            if (appFolderId) return appFolderId;

            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    appFolderId = response.result.files[0].id;
                    return appFolderId;
                }

                const folderMetadata = {
                    name: APP_FOLDER_NAME,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                appFolderId = folder.result.id;
                return appFolderId;
            } catch (error) {
                console.error('Error creating folder:', error);
                throw error;
            }
        }

        async function saveFileToDrive(fileName, content) {
            try {
                console.log(`Attempting to save ${fileName}...`);
                console.log('Access token present:', !!accessToken);
                
                const folderId = await getOrCreateAppFolder();
                console.log('Folder ID:', folderId);
                
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id)',
                    spaces: 'drive'
                });

                console.log('Existing files found:', searchResponse.result.files.length);

                const fileContent = JSON.stringify(content);
                const blob = new Blob([fileContent], { type: 'application/json' });

                let result;
                if (searchResponse.result.files.length > 0) {
                    // Update existing file - DON'T include parents field
                    const fileId = searchResponse.result.files[0].id;
                    console.log('Updating existing file:', fileId);
                    
                    const fileMetadata = {
                        name: fileName
                        // parents field is NOT allowed in updates
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                    form.append('file', blob);

                    result = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: form
                    });
                } else {
                    // Create new file - include parents field
                    console.log('Creating new file');
                    
                    const fileMetadata = {
                        name: fileName,
                        parents: [folderId]  // parents is only for creation
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                    form.append('file', blob);

                    result = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: form
                    });
                }

                if (!result.ok) {
                    const errorData = await result.json();
                    console.error('Drive API error:', errorData);
                    throw new Error(`Drive API error: ${errorData.error?.message || result.statusText}`);
                }

                const resultData = await result.json();
                console.log('Save successful:', resultData);
                return resultData;
            } catch (error) {
                console.error('Error saving to Drive:', error);
                console.error('Error details:', {
                    message: error.message,
                    name: error.name
                });
                throw error;
            }
        }

        async function loadFileFromDrive(fileName) {
            try {
                const folderId = await getOrCreateAppFolder();
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id)',
                    spaces: 'drive'
                });

                if (response.result.files.length === 0) return null;

                const fileId = response.result.files[0].id;
                const fileContent = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                return fileContent.result;
            } catch (error) {
                console.error('Error loading from Drive:', error);
                return null;
            }
        }

        async function loadDataFromDrive() {
            try {
                const [txnData, partyData, settingsData] = await Promise.all([
                    loadFileFromDrive('transactions.json'),
                    loadFileFromDrive('parties.json'),
                    loadFileFromDrive('settings.json')
                ]);

                // Ensure data is properly formatted
                if (txnData) {
                    transactions = Array.isArray(txnData) ? txnData : [];
                    console.log('Loaded transactions:', transactions.length);
                }
                if (partyData) {
                    parties = Array.isArray(partyData) ? partyData : [];
                    console.log('Loaded parties:', parties.length);
                }
                if (settingsData) {
                    settings = (typeof settingsData === 'object' && !Array.isArray(settingsData)) ? settingsData : {};
                    console.log('Loaded settings:', settings);
                }

                renderApp();
            } catch (error) {
                console.error('Error loading data:', error);
                // Even if loading fails, initialize with empty data
                transactions = [];
                parties = [];
                settings = {};
                renderApp();
            }
        }

        async function saveData(type, data) {
            try {
                // Check if we have a valid token
                if (!accessToken) {
                    alert('Session expired. Please sign in again.');
                    handleSignOut();
                    return;
                }
                
                await saveFileToDrive(`${type}.json`, data);
                console.log(`Successfully saved ${type}`);
            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                
                // If it's a 401 or 403, token might be expired - try to refresh
                if (error.status === 401 || error.status === 403) {
                    console.log('Token expired, requesting new token...');
                    
                    // Try to get a new token
                    try {
                        await new Promise((resolve, reject) => {
                            tokenClient.requestAccessToken({
                                prompt: '', // Don't show consent screen again
                                callback: async (response) => {
                                    if (response.error) {
                                        reject(response.error);
                                        return;
                                    }
                                    
                                    if (response.access_token) {
                                        accessToken = response.access_token;
                                        gapi.client.setToken({ access_token: accessToken });
                                        console.log('New token received, retrying save...');
                                        
                                        // Retry the save
                                        try {
                                            await saveFileToDrive(`${type}.json`, data);
                                            console.log(`Successfully saved ${type} after token refresh`);
                                            resolve();
                                        } catch (retryError) {
                                            console.error('Retry failed:', retryError);
                                            alert('Failed to save. Please try again or sign in again.');
                                            reject(retryError);
                                        }
                                    }
                                }
                            });
                        });
                    } catch (refreshError) {
                        console.error('Token refresh failed:', refreshError);
                        alert('Session expired. Please sign in again.');
                        handleSignOut();
                    }
                } else {
                    alert(`Failed to save ${type}. Error: ${error.message || 'Unknown error'}. Please try again.`);
                }
            }
        }

        // Transaction Functions
        function generateTxnID(category) {
            const year = new Date().getFullYear(); // Full year: 2026
            const categoryPrefix = category === 'QUOTATION' ? 'QTE' : 
                                  category === 'PO' ? 'PO' : 
                                  category === 'INVOICE' ? 'INV' : 'TXN';
            const existingTxns = transactions.filter(t => t.txnCategory === category);
            const nextNum = (existingTxns.length + 1).toString().padStart(3, '0');
            return `${categoryPrefix}${year}${nextNum}`;
        }

        function calculateTotals(items) {
            let subtotal = 0, totalTax = 0;
            items.forEach(item => {
                const itemTotal = item.qty * item.rate;
                const discount = (itemTotal * (item.discountPct || 0)) / 100;
                const afterDiscount = itemTotal - discount;
                const sgst = (afterDiscount * (item.sgstPct || 0)) / 100;
                const cgst = (afterDiscount * (item.cgstPct || 0)) / 100;
                const igst = (afterDiscount * (item.igstPct || 0)) / 100;
                subtotal += afterDiscount;
                totalTax += sgst + cgst + igst;
            });
            return {
                subtotal: subtotal.toFixed(2),
                tax: totalTax.toFixed(2),
                total: (subtotal + totalTax).toFixed(2)
            };
        }

        // PDF Export Function
        async function exportTransactionToPDF(txn) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Company details
                const companyName = settings.companyName || 'Engineering Services Company';
                const companyGST = settings.gstNumber || '';
                
                // Header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(companyName, 105, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                if (companyGST) {
                    doc.text(`GST: ${companyGST}`, 105, 22, { align: 'center' });
                }
                
                // Document title
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                const docTitle = txn.txnCategory === 'QUOTATION' ? 'QUOTATION' : 
                                txn.txnCategory === 'PO' ? 'PURCHASE ORDER' : 'INVOICE';
                doc.text(docTitle, 105, 35, { align: 'center' });
                
                // Transaction details
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${docTitle} No: ${txn.txnID}`, 14, 45);
                doc.text(`Date: ${txn.txnDate}`, 14, 52);
                doc.text(`Status: ${txn.status}`, 14, 59);
                if (txn.reference) {
                    doc.text(`Reference: ${txn.reference}`, 14, 66);
                }
                
                // Party details
                doc.setFont(undefined, 'bold');
                doc.text(`${txn.txnDirection === 'Outgoing' ? 'To:' : 'From:'}`, 14, 75);
                doc.setFont(undefined, 'normal');
                doc.text(txn.partyName, 14, 82);
                
                // Line items table
                const tableData = txn.items.map((item, idx) => {
                    const itemTotal = item.qty * item.rate;
                    const discount = (itemTotal * (item.discountPct || 0)) / 100;
                    const taxableAmt = itemTotal - discount;
                    const sgst = (taxableAmt * (item.sgstPct || 0)) / 100;
                    const cgst = (taxableAmt * (item.cgstPct || 0)) / 100;
                    const igst = (taxableAmt * (item.igstPct || 0)) / 100;
                    const total = taxableAmt + sgst + cgst + igst;
                    
                    return [
                        idx + 1,
                        item.description,
                        item.hsnCode || '',
                        item.qty,
                        item.uom || 'NOS',
                        `₹${item.rate.toFixed(2)}`,
                        `${item.discountPct || 0}%`,
                        `₹${taxableAmt.toFixed(2)}`,
                        `${item.sgstPct || 0}%`,
                        `${item.cgstPct || 0}%`,
                        `${item.igstPct || 0}%`,
                        `₹${total.toFixed(2)}`
                    ];
                });
                
                doc.autoTable({
                    startY: 95,
                    head: [['#', 'Description', 'HSN', 'Qty', 'UOM', 'Rate', 'Disc%', 'Taxable', 'SGST%', 'CGST%', 'IGST%', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229], fontSize: 8 },
                    bodyStyles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 8 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 12 },
                        4: { cellWidth: 12 },
                        5: { cellWidth: 20, halign: 'right' },
                        6: { cellWidth: 12 },
                        7: { cellWidth: 22, halign: 'right' },
                        8: { cellWidth: 12 },
                        9: { cellWidth: 12 },
                        10: { cellWidth: 12 },
                        11: { cellWidth: 22, halign: 'right' }
                    }
                });
                
                // Calculate totals
                const totals = calculateTotals(txn.items);
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Totals section
                doc.setFont(undefined, 'bold');
                doc.text('Subtotal:', 140, finalY);
                doc.text(`₹${totals.subtotal}`, 195, finalY, { align: 'right' });
                
                doc.text('Total Tax:', 140, finalY + 7);
                doc.text(`₹${totals.tax}`, 195, finalY + 7, { align: 'right' });
                
                doc.setFontSize(12);
                doc.text('Grand Total:', 140, finalY + 17);
                doc.text(`₹${totals.total}`, 195, finalY + 17, { align: 'right' });
                
                // Footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text('Thank you for your business!', 105, 280, { align: 'center' });
                
                // Save PDF
                doc.save(`${txn.txnID}_${txn.partyName}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }
        }

        // Google Sheets Sync Function
        async function syncToGoogleSheets() {
            try {
                if (!accessToken) {
                    alert('Please sign in first');
                    return;
                }
                
                // Show progress
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Syncing...';
                btn.disabled = true;
                
                // Check if spreadsheet exists, if not create one
                let spreadsheetId = settings.spreadsheetId;
                
                if (!spreadsheetId) {
                    // Create new spreadsheet
                    const createResponse = await gapi.client.sheets.spreadsheets.create({
                        properties: {
                            title: 'Engineering Services Data'
                        },
                        sheets: [
                            { properties: { title: 'Transactions' } },
                            { properties: { title: 'Parties' } },
                            { properties: { title: 'Settings' } }
                        ]
                    });
                    
                    spreadsheetId = createResponse.result.spreadsheetId;
                    settings.spreadsheetId = spreadsheetId;
                    await saveData('settings', settings);
                    
                    console.log('Created new spreadsheet:', spreadsheetId);
                }
                
                // Prepare transaction data
                const txnRows = [
                    ['Txn ID', 'Category', 'Direction', 'Party', 'Date', 'Reference', 'Status', 'Subtotal', 'Tax', 'Total']
                ];
                
                transactions.forEach(txn => {
                    const totals = calculateTotals(txn.items || []);
                    txnRows.push([
                        txn.txnID,
                        txn.txnCategory,
                        txn.txnDirection,
                        txn.partyName,
                        txn.txnDate,
                        txn.reference || '',
                        txn.status,
                        totals.subtotal,
                        totals.tax,
                        totals.total
                    ]);
                });
                
                // Prepare parties data
                const partyRows = [
                    ['Party ID', 'Name', 'Type', 'GST', 'PAN', 'Contact Person', 'Email', 'Mobile']
                ];
                
                parties.forEach(p => {
                    partyRows.push([
                        p.partyID,
                        p.partyName,
                        p.partyType,
                        p.gstNumber || '',
                        p.panNumber || '',
                        p.contactPerson || '',
                        p.email || '',
                        p.mobile || ''
                    ]);
                });
                
                // Update spreadsheet
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        valueInputOption: 'RAW',
                        data: [
                            {
                                range: 'Transactions!A1',
                                values: txnRows
                            },
                            {
                                range: 'Parties!A1',
                                values: partyRows
                            }
                        ]
                    }
                });
                
                btn.textContent = originalText;
                btn.disabled = false;
                
                alert(`Successfully synced to Google Sheets!\n\nView at: https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
                
            } catch (error) {
                console.error('Error syncing to Sheets:', error);
                alert('Failed to sync to Google Sheets. Error: ' + (error.message || 'Unknown error'));
                
                const btn = event.target;
                if (btn) {
                    btn.textContent = 'Sync to Google Sheets';
                    btn.disabled = false;
                }
            }
        }

        // UI Rendering
        function renderLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <svg class="text-white" width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Engineering Services</h1>
                        <p class="text-gray-600 mb-8">Management System</p>
                        <button onclick="handleSignIn()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl px-6 py-4 hover:bg-gray-50 transition-colors font-medium text-gray-700">
                            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                            Sign in with Google
                        </button>
                        <p class="text-xs text-gray-500 mt-6">Using Modern Google Identity Services</p>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const userEmail = gapi.client.getToken() ? 'user@example.com' : 'Unknown';

            document.getElementById('app').innerHTML = `
                <nav class="bg-white shadow-lg border-b">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center">
                                    <svg class="text-white" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Engineering Services</h1>
                                    <p class="text-xs text-gray-600">Management System</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="px-4 py-2 bg-green-100 rounded-lg text-sm">
                                    <span class="text-green-700 font-medium">✓ Connected to Google Drive</span>
                                </div>
                                <button onclick="handleSignOut()" class="p-2 hover:bg-gray-100 rounded-lg">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="switchView('dashboard')" class="px-4 py-2 rounded-lg ${currentView === 'dashboard' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Dashboard</button>
                            <button onclick="switchView('transactions')" class="px-4 py-2 rounded-lg ${currentView === 'transactions' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Transactions</button>
                            <button onclick="switchView('parties')" class="px-4 py-2 rounded-lg ${currentView === 'parties' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Parties</button>
                            <button onclick="switchView('settings')" class="px-4 py-2 rounded-lg ${currentView === 'settings' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Settings</button>
                        </div>
                    </div>
                </nav>
                <main class="max-w-7xl mx-auto px-6 py-8" id="mainContent"></main>
            `;

            renderView();
        }

        function switchView(view) {
            currentView = view;
            renderView();
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            if (!content) {
                console.error('mainContent element not found');
                return;
            }
            
            if (currentView === 'dashboard') renderDashboard(content);
            else if (currentView === 'transactions') renderTransactions(content);
            else if (currentView === 'parties') renderParties(content);
            else if (currentView === 'settings') renderSettings(content);
        }

        function renderDashboard(content) {
            const outgoingQuotations = transactions.filter(t => t.txnCategory === 'QUOTATION' && t.txnDirection === 'Outgoing');
            const outgoingPOs = transactions.filter(t => t.txnCategory === 'PO' && t.txnDirection === 'Outgoing');
            const outgoingInvoices = transactions.filter(t => t.txnCategory === 'INVOICE' && t.txnDirection === 'Outgoing');
            const incomingPOs = transactions.filter(t => t.txnCategory === 'PO' && t.txnDirection === 'Incoming');

            content.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingQuotations.length}</div>
                        <div class="text-blue-100 text-sm">Quotations Issued</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingPOs.length}</div>
                        <div class="text-green-100 text-sm">POs Received</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingInvoices.length}</div>
                        <div class="text-purple-100 text-sm">Invoices Raised</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${incomingPOs.length}</div>
                        <div class="text-orange-100 text-sm">POs to SubContractors</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                    ${transactions.length === 0 ? '<p class="text-gray-500 text-center py-8">No transactions yet. Click "+ New Transaction" to get started!</p>' : 
                        transactions.slice(-5).reverse().map(t => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                                <div>
                                    <div class="font-semibold">${t.txnID}</div>
                                    <div class="text-sm text-gray-600">${t.partyName}</div>
                                </div>
                                <span class="text-xs px-3 py-1 rounded-full ${
                                    t.status === 'Draft' ? 'bg-gray-100' : t.status === 'Sent' ? 'bg-blue-100' : 'bg-green-100'
                                }">${t.status}</span>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        function renderTransactions(content) {
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Transactions</h2>
                    <div class="flex gap-3">
                        <button onclick="syncToGoogleSheets()" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 flex items-center gap-2">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M9,17H7v-7h2V17z M13,17h-2V7h2V17z M17,17h-2v-4h2V17z"/>
                            </svg>
                            Sync to Google Sheets
                        </button>
                        <button onclick="openTransactionModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">+ New Transaction</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    ${transactions.length === 0 ? '<p class="text-gray-500 text-center py-12">No transactions. Create your first one!</p>' : `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold">Category</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold">Party</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold">Status</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactions.map(t => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3 font-medium">${t.txnID}</td>
                                            <td class="px-4 py-3">${t.txnCategory}</td>
                                            <td class="px-4 py-3">${t.partyName}</td>
                                            <td class="px-4 py-3 text-sm">${t.txnDate}</td>
                                            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${t.status}</span></td>
                                            <td class="px-4 py-3 text-right whitespace-nowrap">
                                                <button onclick='exportTransactionToPDF(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-800 mr-2" title="Export PDF">
                                                    <svg class="inline" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                                    </svg>
                                                </button>
                                                <button onclick='editTransaction(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="text-indigo-600 hover:text-indigo-800 mr-2">Edit</button>
                                                <button onclick="deleteTransaction('${t.txnID}')" class="text-red-600 hover:text-red-800">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        function renderParties(content) {
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Parties</h2>
                    <button onclick="openPartyModal()" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700">+ New Party</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${parties.map(p => `
                        <div class="bg-white rounded-xl p-5 border shadow hover:shadow-md">
                            <div class="flex justify-between mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${p.partyName}</h3>
                                    <span class="text-xs px-2 py-1 rounded-full ${p.partyType === 'Client' ? 'bg-blue-100' : 'bg-orange-100'}">${p.partyType}</span>
                                </div>
                                <div>
                                    <button onclick='editParty(${JSON.stringify(p).replace(/'/g, "&apos;")})' class="text-purple-600 mr-1">Edit</button>
                                    <button onclick="deleteParty('${p.partyID}')" class="text-red-600">Del</button>
                                </div>
                            </div>
                            ${p.contactPerson ? `<div class="text-sm">${p.contactPerson}</div>` : ''}
                            ${p.email ? `<div class="text-sm text-gray-600">${p.email}</div>` : ''}
                        </div>
                    `).join('')}
                    ${parties.length === 0 ? '<p class="col-span-3 text-gray-500 text-center py-12">No parties yet. Add your first client or subcontractor!</p>' : ''}
                </div>
            `;
        }

        function renderSettings(content) {
            content.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Settings</h2>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <form onsubmit="saveSettings(event)" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Company Name</label>
                            <input type="text" id="companyName" value="${settings.companyName || ''}" class="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">GST Number</label>
                            <input type="text" id="companyGST" value="${settings.gstNumber || ''}" class="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div class="col-span-2">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">Save</button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Modal Functions
        function openTransactionModal(txn = null) {
            currentTransaction = txn;
            lineItemCounter = 0;
            document.getElementById('modalTitle').textContent = txn ? 'Edit Transaction' : 'New Transaction';
            document.getElementById('lineItems').innerHTML = '';
            document.getElementById('totalSection').classList.add('hidden');
            
            updatePartyDropdown();
            
            if (txn) {
                document.getElementById('txnCategory').value = txn.txnCategory;
                document.getElementById('txnDirection').value = txn.txnDirection;
                document.getElementById('txnParty').value = txn.partyName;
                document.getElementById('txnReference').value = txn.reference || '';
                document.getElementById('txnStatus').value = txn.status;
                (txn.items || []).forEach(item => addLineItem(item));
            }
            
            document.getElementById('transactionModal').classList.add('show');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('show');
        }

        function updatePartyDropdown() {
            const direction = document.getElementById('txnDirection').value;
            const partySelect = document.getElementById('txnParty');
            const filteredParties = parties.filter(p => 
                direction === 'Outgoing' ? p.partyType === 'Client' : p.partyType === 'SubContractor'
            );
            
            partySelect.innerHTML = '<option value="">Select Party</option>' + 
                filteredParties.map(p => `<option value="${p.partyName}">${p.partyName}</option>`).join('');
        }

        function addLineItem(item = null) {
            lineItemCounter++;
            const id = item?.itemID || `item-${lineItemCounter}`;
            const rowNum = document.getElementById('lineItems').children.length + 1;
            
            const tr = document.createElement('tr');
            tr.id = `line-${id}`;
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="border px-2 py-2 text-center">${rowNum}</td>
                <td class="border px-2 py-2">
                    <input type="text" placeholder="Description" value="${item?.description || ''}" 
                        class="item-desc w-full px-2 py-1 border rounded text-sm" required />
                </td>
                <td class="border px-2 py-2">
                    <input type="text" placeholder="HSN" value="${item?.hsnCode || ''}" 
                        class="item-hsn w-full px-2 py-1 border rounded text-sm" />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.qty || 1}" 
                        class="item-qty w-full px-2 py-1 border rounded text-sm" min="0" step="0.01" required />
                </td>
                <td class="border px-2 py-2">
                    <select class="item-uom w-full px-2 py-1 border rounded text-sm">
                        <option value="NOS" ${item?.uom === 'NOS' ? 'selected' : ''}>NOS</option>
                        <option value="KG" ${item?.uom === 'KG' ? 'selected' : ''}>KG</option>
                        <option value="MTR" ${item?.uom === 'MTR' ? 'selected' : ''}>MTR</option>
                        <option value="LTR" ${item?.uom === 'LTR' ? 'selected' : ''}>LTR</option>
                        <option value="BOX" ${item?.uom === 'BOX' ? 'selected' : ''}>BOX</option>
                        <option value="SET" ${item?.uom === 'SET' ? 'selected' : ''}>SET</option>
                        <option value="PKT" ${item?.uom === 'PKT' ? 'selected' : ''}>PKT</option>
                        <option value="HRS" ${item?.uom === 'HRS' ? 'selected' : ''}>HRS</option>
                    </select>
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0.00" value="${item?.rate || 0}" 
                        class="item-rate w-full px-2 py-1 border rounded text-sm" min="0" step="0.01" required />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.discountPct || 0}" 
                        class="item-discount w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" />
                </td>
                <td class="border px-2 py-2 text-right">
                    <span class="item-taxable font-medium text-sm">₹0.00</span>
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.sgstPct || 9}" 
                        class="item-sgst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.cgstPct || 9}" 
                        class="item-cgst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.igstPct || 0}" 
                        class="item-igst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" />
                </td>
                <td class="border px-2 py-2 text-right">
                    <span class="item-total font-bold text-sm">₹0.00</span>
                </td>
                <td class="border px-2 py-2 text-center">
                    <button type="button" onclick="removeLineItem('${id}')" 
                        class="text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>
                </td>
            `;
            
            document.getElementById('lineItems').appendChild(tr);
            document.getElementById('totalSection').classList.remove('hidden');
            
            // Add event listeners to all input fields
            tr.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', updateTotals);
                input.addEventListener('change', updateTotals);
            });
            
            updateTotals();
        }

        function removeLineItem(id) {
            document.getElementById(`line-${id}`).remove();
            if (document.getElementById('lineItems').children.length === 0) {
                document.getElementById('totalSection').classList.add('hidden');
            }
            updateTotals();
        }

        function updateTotals() {
            const rows = Array.from(document.getElementById('lineItems').children);
            let grandSubtotal = 0;
            let grandTax = 0;
            let grandTotal = 0;
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate')?.value) || 0;
                const discountPct = parseFloat(row.querySelector('.item-discount')?.value) || 0;
                const sgstPct = parseFloat(row.querySelector('.item-sgst')?.value) || 0;
                const cgstPct = parseFloat(row.querySelector('.item-cgst')?.value) || 0;
                const igstPct = parseFloat(row.querySelector('.item-igst')?.value) || 0;
                
                // Calculate item total
                const itemTotal = qty * rate;
                const discountAmount = (itemTotal * discountPct) / 100;
                const taxableAmount = itemTotal - discountAmount;
                
                const sgst = (taxableAmount * sgstPct) / 100;
                const cgst = (taxableAmount * cgstPct) / 100;
                const igst = (taxableAmount * igstPct) / 100;
                const totalTax = sgst + cgst + igst;
                const lineTotal = taxableAmount + totalTax;
                
                // Update row display
                const taxableSpan = row.querySelector('.item-taxable');
                const totalSpan = row.querySelector('.item-total');
                if (taxableSpan) taxableSpan.textContent = `₹${taxableAmount.toFixed(2)}`;
                if (totalSpan) totalSpan.textContent = `₹${lineTotal.toFixed(2)}`;
                
                // Add to grand totals
                grandSubtotal += taxableAmount;
                grandTax += totalTax;
                grandTotal += lineTotal;
            });
            
            // Update grand total display
            document.getElementById('subtotalAmount').textContent = `₹${grandSubtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `₹${grandTax.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `₹${grandTotal.toFixed(2)}`;
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const items = Array.from(document.getElementById('lineItems').children).map((row, idx) => ({
                    itemID: `item-${idx + 1}`,
                    description: row.querySelector('.item-desc').value,
                    hsnCode: row.querySelector('.item-hsn').value,
                    qty: parseFloat(row.querySelector('.item-qty').value) || 0,
                    uom: row.querySelector('.item-uom').value,
                    rate: parseFloat(row.querySelector('.item-rate').value) || 0,
                    discountPct: parseFloat(row.querySelector('.item-discount').value) || 0,
                    sgstPct: parseFloat(row.querySelector('.item-sgst').value) || 0,
                    cgstPct: parseFloat(row.querySelector('.item-cgst').value) || 0,
                    igstPct: parseFloat(row.querySelector('.item-igst').value) || 0
                }));
                
                const txnData = {
                    txnID: currentTransaction?.txnID || generateTxnID(document.getElementById('txnCategory').value),
                    txnCategory: document.getElementById('txnCategory').value,
                    txnDirection: document.getElementById('txnDirection').value,
                    partyName: document.getElementById('txnParty').value,
                    reference: document.getElementById('txnReference').value,
                    status: document.getElementById('txnStatus').value,
                    txnDate: currentTransaction?.txnDate || new Date().toISOString().split('T')[0],
                    currency: 'INR',
                    items: items
                };
                
                if (currentTransaction) {
                    const index = transactions.findIndex(t => t.txnID === currentTransaction.txnID);
                    transactions[index] = txnData;
                } else {
                    transactions.push(txnData);
                }
                
                // Show saving message
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                
                await saveData('transactions', transactions);
                
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                closeTransactionModal();
                renderView();
            } catch (error) {
                console.error('Error in form submission:', error);
                // Re-enable button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Save';
                    submitBtn.disabled = false;
                }
            }
        });

        function editTransaction(txn) {
            openTransactionModal(txn);
        }

        async function deleteTransaction(txnID) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.txnID !== txnID);
                await saveData('transactions', transactions);
                renderView();
            }
        }

        // Party Modal
        function openPartyModal(party = null) {
            currentParty = party;
            document.getElementById('partyModalTitle').textContent = party ? 'Edit Party' : 'New Party';
            
            if (party) {
                document.getElementById('partyName').value = party.partyName;
                document.getElementById('partyType').value = party.partyType;
                document.getElementById('partyGST').value = party.gstNumber || '';
                document.getElementById('partyPAN').value = party.panNumber || '';
                document.getElementById('partyContact').value = party.contactPerson || '';
                document.getElementById('partyEmail').value = party.email || '';
                document.getElementById('partyMobile').value = party.mobile || '';
            }
            
            document.getElementById('partyModal').classList.add('show');
        }

        function closePartyModal() {
            document.getElementById('partyModal').classList.remove('show');
            document.getElementById('partyForm').reset();
        }

        document.getElementById('partyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const partyData = {
                partyID: currentParty?.partyID || Date.now().toString(36),
                partyName: document.getElementById('partyName').value,
                partyType: document.getElementById('partyType').value,
                gstNumber: document.getElementById('partyGST').value,
                panNumber: document.getElementById('partyPAN').value,
                contactPerson: document.getElementById('partyContact').value,
                email: document.getElementById('partyEmail').value,
                mobile: document.getElementById('partyMobile').value
            };
            
            if (currentParty) {
                const index = parties.findIndex(p => p.partyID === currentParty.partyID);
                parties[index] = partyData;
            } else {
                parties.push(partyData);
            }
            
            await saveData('parties', parties);
            closePartyModal();
            renderView();
        });

        function editParty(party) {
            openPartyModal(party);
        }

        async function deleteParty(partyID) {
            if (confirm('Delete this party?')) {
                parties = parties.filter(p => p.partyID !== partyID);
                await saveData('parties', parties);
                renderView();
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            
            try {
                settings = {
                    companyName: document.getElementById('companyName').value,
                    gstNumber: document.getElementById('companyGST').value
                };
                
                console.log('Saving settings:', settings);
                await saveData('settings', settings);
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error in saveSettings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }

        // Initialize
        window.onload = () => {
            gapiLoaded();
            gisLoaded();
        };
    </script>
</body>
</html>
