<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Engineering Services Management</title>

<!-- Tailwind (OK for now) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div id="app" class="text-center"></div>

<script>
/* ================= CONFIG ================= */

const CLIENT_ID = "807569986194-feca4li2k0t96tbbutlpu2ko64obe95k.apps.googleusercontent.com";

const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.file";

const APP_FOLDER_NAME = "EngineeringServicesApp";

/* ================= GLOBALS ================= */

let tokenClient;
let accessToken = null;
let appFolderId = null;

/* ================= GOOGLE INIT ================= */

function gapiLoaded() {
    gapi.load("client", async () => {
        await gapi.client.init({
            discoveryDocs: DISCOVERY_DOCS,
        });
    });
}

function initGIS() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            accessToken = resp.access_token;
            gapi.client.setToken({ access_token: accessToken });
            showDashboard();
        },
    });
}

/* ================= LOGIN UI ================= */

function showLogin() {
    document.getElementById("app").innerHTML = `
    <div class="bg-white p-10 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold mb-6">Engineering Services App</h1>

        <button onclick="tokenClient.requestAccessToken()"
            class="bg-indigo-600 text-white px-6 py-3 rounded-lg">
            Sign in with Google
        </button>
    </div>`;
}

/* ================= DASHBOARD ================= */

function showDashboard() {
    document.getElementById("app").innerHTML = `
    <div class="bg-white p-8 rounded-xl shadow-lg space-y-4">
        <h2 class="text-2xl font-bold text-green-600">
            ✅ Connected to Google Drive
        </h2>

        <button onclick="createFolder()"
            class="bg-purple-600 text-white px-6 py-3 rounded-lg w-full">
            Create App Folder
        </button>

        <button onclick="saveData()"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg w-full">
            Save Sample Data
        </button>

        <button onclick="loadData()"
            class="bg-green-600 text-white px-6 py-3 rounded-lg w-full">
            Load Data
        </button>
    </div>`;
}

/* ================= DRIVE FUNCTIONS ================= */

async function getOrCreateFolder() {
    if (appFolderId) return appFolderId;

    const res = await gapi.client.drive.files.list({
        q: `name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: "files(id,name)"
    });

    if (res.result.files.length > 0) {
        appFolderId = res.result.files[0].id;
        return appFolderId;
    }

    const folder = await gapi.client.drive.files.create({
        resource: {
            name: APP_FOLDER_NAME,
            mimeType: "application/vnd.google-apps.folder"
        },
        fields: "id"
    });

    appFolderId = folder.result.id;
    return appFolderId;
}

async function createFolder() {
    await getOrCreateFolder();
    alert("✅ Folder ready in Drive");
}

async function saveData() {
    const folderId = await getOrCreateFolder();

    const data = {
        date: new Date(),
        message: "Hello from Engineering App"
    };

    const boundary = "foo_bar_baz";

    const metadata = {
        name: "data.json",
        mimeType: "application/json",
        parents: [folderId]
    };

    const body =
        `--${boundary}\r\n` +
        "Content-Type: application/json\r\n\r\n" +
        JSON.stringify(metadata) + "\r\n" +
        `--${boundary}\r\n` +
        "Content-Type: application/json\r\n\r\n" +
        JSON.stringify(data) + "\r\n" +
        `--${boundary}--`;

    await gapi.client.request({
        path: "/upload/drive/v3/files",
        method: "POST",
        params: { uploadType: "multipart" },
        headers: {
            "Content-Type": `multipart/related; boundary=${boundary}`
        },
        body: body
    });

    alert("✅ Data saved");
}

async function loadData() {
    const folderId = await getOrCreateFolder();

    const res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and name='data.json'`,
        fields: "files(id)"
    });

    if (!res.result.files.length) {
        alert("No data found");
        return;
    }

    const fileId = res.result.files[0].id;

    const file = await gapi.client.drive.files.get({
        fileId: fileId,
        alt: "media"
    });

    alert("Loaded:\n" + JSON.stringify(file.result, null, 2));
}

/* ================= START ================= */

window.onload = () => {
    gapiLoaded();
    initGIS();
    showLogin();
};
</script>

</body>
</html>
