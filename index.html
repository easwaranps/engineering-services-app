<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engineering Services Management System</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client"></script>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
<div id="app"></div>

<script>
const CLIENT_ID = "784901480574-689pm46oisagmiuffvlh7tjuilkc8cst.apps.googleusercontent.com";
const API_KEY = "AIzaSyA54gHOHXSI_lCuuSLE6td8PblTZwDY538";

const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const APP_FOLDER_NAME = "EngineeringServicesApp";

let tokenClient;
let accessToken = null;

let transactions = [];
let parties = [];
let settings = {};
let currentView = "dashboard";
let appFolderId = null;

// ---------------- INIT ----------------

gapi.load("client", async () => {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: DISCOVERY_DOCS
  });
});

tokenClient = google.accounts.oauth2.initTokenClient({
  client_id: CLIENT_ID,
  scope: SCOPES,
  callback: (resp) => {
    accessToken = resp.access_token;
    gapi.client.setToken({ access_token: accessToken });
    loadDataFromDrive();
  }
});

// ---------------- LOGIN UI ----------------

function renderLoginScreen(){
  document.getElementById("app").innerHTML = `
  <div class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-10 rounded-2xl shadow-xl text-center">
      <h1 class="text-2xl font-bold mb-6">Engineering Services</h1>
      <button onclick="handleSignIn()"
        class="px-6 py-3 bg-indigo-600 text-white rounded-xl">
        Sign in with Google
      </button>
    </div>
  </div>`;
}

function handleSignIn(){
  tokenClient.requestAccessToken({prompt:"consent"});
}

renderLoginScreen();

// ---------------- DRIVE ----------------

async function getOrCreateAppFolder(){
  if(appFolderId) return appFolderId;

  const res = await gapi.client.drive.files.list({
    q:`name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    fields:"files(id)"
  });

  if(res.result.files.length){
    appFolderId = res.result.files[0].id;
    return appFolderId;
  }

  const folder = await gapi.client.drive.files.create({
    resource:{name:APP_FOLDER_NAME,mimeType:"application/vnd.google-apps.folder"},
    fields:"id"
  });

  appFolderId = folder.result.id;
  return appFolderId;
}

async function saveFile(name,data){
  const folderId = await getOrCreateAppFolder();

  const meta={
    name:name,
    parents:[folderId],
    mimeType:"application/json"
  };

  const boundary="foo_bar_baz";
  const body=
`--${boundary}
Content-Type: application/json

${JSON.stringify(meta)}
--${boundary}
Content-Type: application/json

${JSON.stringify(data)}
--${boundary}--`;

  await gapi.client.request({
    path:"/upload/drive/v3/files",
    method:"POST",
    params:{uploadType:"multipart"},
    headers:{"Content-Type":`multipart/related; boundary=${boundary}`},
    body:body
  });
}

async function loadFile(name){
  const folderId=await getOrCreateAppFolder();

  const res=await gapi.client.drive.files.list({
    q:`name='${name}' and '${folderId}' in parents and trashed=false`,
    fields:"files(id)"
  });

  if(!res.result.files.length) return null;

  const file=await gapi.client.drive.files.get({
    fileId:res.result.files[0].id,
    alt:"media"
  });

  return file.result;
}

// ---------------- DATA LOAD ----------------

async function loadDataFromDrive(){
  transactions = await loadFile("transactions.json") || [];
  parties = await loadFile("parties.json") || [];
  settings = await loadFile("settings.json") || {};
  renderApp();
}

// ---------------- MAIN APP ----------------

function renderApp(){
  document.getElementById("app").innerHTML=`
  <div class="p-8">
    <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
    <button onclick="saveDemo()" class="px-4 py-2 bg-green-600 text-white rounded">
      Save Demo Data
    </button>
  </div>`;
}

async function saveDemo(){
  transactions.push({id:Date.now(),demo:true});
  await saveFile("transactions.json",transactions);
  alert("Saved to Drive!");
}
</script>
</body>
</html>
