<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Services Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>



    <!-- Bank Account Modal -->
    <div id="bankAccountModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg m-4 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 text-white">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold" id="bankAccountModalTitle">Add Bank Account</h2>
                    <button onclick="closeBankAccountModal()" class="text-white hover:text-blue-200 text-2xl font-bold">âœ•</button>
                </div>
            </div>
            <form id="bankAccountForm" onsubmit="saveBankAccount(event)" class="p-6">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Account Name <span class="text-red-500">*</span></label>
                        <input type="text" id="baAccountName" placeholder="e.g. HDFC Bank INR Account" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Bank Name <span class="text-red-500">*</span></label>
                        <input type="text" id="baBankName" placeholder="e.g. HDFC Bank, SBI Bank" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Currency <span class="text-red-500">*</span></label>
                            <select id="baCurrency" class="w-full px-3 py-2 border rounded-lg text-sm" required>
                                <option value="INR">INR</option>
                                <option value="USD">USD</option>
                                <option value="GBP">GBP</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Type <span class="text-red-500">*</span></label>
                            <select id="baType" class="w-full px-3 py-2 border rounded-lg text-sm" required>
                                <option value="Income">Income (Receivables)</option>
                                <option value="Expense">Expense (Payables)</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Account Number</label>
                        <input type="text" id="baAccountNo" placeholder="Optional" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">IFSC Code</label>
                            <input type="text" id="baIFSC" placeholder="Optional" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                            <select id="baActive" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Branch Address</label>
                        <textarea id="baBranchAddress" rows="2" placeholder="Optional" class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 justify-end mt-6">
                    <button type="button" onclick="closeBankAccountModal()" class="px-5 py-2 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold">Save Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[92vh] overflow-y-auto m-4">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 p-5 text-white sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold" id="expenseModalTitle">New Expense / Bill</h2>
                    <button onclick="closeExpenseModal()" class="text-white hover:text-orange-200 text-2xl font-bold">âœ•</button>
                </div>
            </div>
            <form id="expenseForm" onsubmit="saveExpense(event)" class="p-6">
                <!-- Row 1: Voucher / Bill info -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Voucher No</label>
                        <input type="text" id="expVoucherNo" placeholder="Auto / Manual" class="w-full px-3 py-2 border rounded-lg text-sm" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Supporting / Bill No</label>
                        <input type="text" id="expBillNo" placeholder="Bill / Invoice No" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Bill Date <span class="text-red-500">*</span></label>
                        <input type="date" id="expBillDate" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Company / Vendor Name <span class="text-red-500">*</span></label>
                        <input type="text" id="expCompanyName" placeholder="Vendor / Supplier" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                </div>

                <!-- Row 2: Description + Currency + Amounts -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Description <span class="text-red-500">*</span></label>
                        <input type="text" id="expDescription" placeholder="Nature of expense" class="w-full px-3 py-2 border rounded-lg text-sm" required/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Currency</label>
                        <select id="expCurrency" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="calcExpAmounts()">
                            <option value="INR">INR</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="SGD">SGD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Exchange Rate</label>
                        <input type="number" id="expExchRate" value="1" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Bill Amount <span class="text-red-500">*</span></label>
                        <input type="number" id="expBillAmount" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()" required/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Bill Amount in INR</label>
                        <input type="number" id="expBillAmtINR" placeholder="Auto" class="w-full px-3 py-2 border rounded-lg bg-gray-50 text-sm" readonly/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">CGST Amount</label>
                        <input type="number" id="expCGST" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">SGST Amount</label>
                        <input type="number" id="expSGST" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">IGST Amount</label>
                        <input type="number" id="expIGST" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Credit Note / Discount</label>
                        <input type="number" id="expCreditNote" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Credit Note / Discount Details</label>
                        <input type="text" id="expCreditNoteDetails" placeholder="Reference / description of credit note" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                    </div>
                </div>

                <!-- TDS Section -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="expTDSApplicable" onchange="calcExpAmounts()" class="w-4 h-4 accent-yellow-600"/>
                            <span class="text-sm font-semibold text-yellow-800">TDS Applicable</span>
                        </label>
                    </div>
                    <div id="expTDSFields" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Taxable Amount</label>
                            <input type="number" id="expTaxableAmt" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">TDS %</label>
                            <select id="expTDSPct" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="calcExpAmounts()">
                                <option value="1">1%</option>
                                <option value="2" selected>2%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">TDS Amount</label>
                            <input type="number" id="expTDSAmt" placeholder="Auto" class="w-full px-3 py-2 border rounded-lg bg-gray-50 text-sm" readonly/>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Net Amount (after TDS)</label>
                            <input type="number" id="expNetAmt" placeholder="Auto" class="w-full px-3 py-2 border rounded-lg bg-gray-50 text-sm" readonly/>
                        </div>
                    </div>
                </div>

                <!-- Advance + Payment -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Advance Paid Amount</label>
                        <input type="number" id="expAdvanceAmt" placeholder="0.00" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" oninput="calcExpAmounts()"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Advance Paid Date</label>
                        <input type="date" id="expAdvanceDate" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Balance to Pay</label>
                        <input type="number" id="expBalanceAmt" placeholder="Auto" class="w-full px-3 py-2 border rounded-lg bg-gray-50 text-sm" readonly/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Payment Status <span class="text-red-500">*</span></label>
                        <select id="expPayStatus" class="w-full px-3 py-2 border rounded-lg text-sm" required>
                            <option value="Pending">Pending</option>
                            <option value="Partial">Partial</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>

                <!-- Payment Mode -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Payment Mode</label>
                        <select id="expPayMode" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="toggleChequeFields()">
                            <option value="">-- Select --</option>
                            <option value="Cash">Cash</option>
                            <option value="Cheque">Cheque</option>
                            <option value="NEFT">NEFT</option>
                            <option value="RTGS">RTGS</option>
                            <option value="IMPS">IMPS</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                    <div id="chequeNoField">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Cheque No</label>
                        <input type="text" id="expChequeNo" placeholder="Cheque number" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Cheque / Online Paid Date</label>
                        <input type="date" id="expPayDate" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Paid From Bank Account</label>
                        <select id="expBankAccount" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">-- Select Account --</option>
                        </select>
                    </div>
                </div>

                <!-- Remark + Bill Photo -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Remark</label>
                        <textarea id="expRemark" rows="2" placeholder="Additional notes..." class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Bill Photo / Attachment</label>
                        <input type="file" id="expBillPhoto" accept="image/*,application/pdf" class="w-full px-3 py-2 border rounded-lg text-sm"/>
                        <p class="text-xs text-gray-400 mt-1">Image or PDF, max 2MB</p>
                        <div id="expPhotoPreview" class="mt-2 hidden">
                            <img id="expPhotoImg" src="" alt="Bill photo" class="max-h-24 rounded border"/>
                            <span id="expPhotoName" class="text-xs text-gray-500 block"></span>
                        </div>
                    </div>
                </div>

                <!-- Computed totals summary -->
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div><span class="text-gray-500 block text-xs">Bill Amount (INR)</span><span id="sumBillINR" class="font-bold text-orange-700">â€”</span></div>
                    <div><span class="text-gray-500 block text-xs">Total Tax</span><span id="sumTax" class="font-bold text-orange-700">â€”</span></div>
                    <div><span class="text-gray-500 block text-xs">TDS Deducted</span><span id="sumTDS" class="font-bold text-orange-700">â€”</span></div>
                    <div><span class="text-gray-500 block text-xs">Net Payable</span><span id="sumNet" class="font-bold text-orange-800 text-base">â€”</span></div>
                </div>

                <div class="flex gap-3 justify-end">
                    <button type="button" onclick="closeExpenseModal()" class="px-5 py-2 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-xl hover:bg-orange-700 font-semibold">Save Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Unlock Modal -->
    <div id="unlockModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm m-4 overflow-hidden">
            <div class="bg-gradient-to-r from-red-600 to-orange-600 p-5 text-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center text-xl">ðŸ”“</div>
                    <div>
                        <h3 class="text-lg font-bold">Admin Override</h3>
                        <p class="text-red-100 text-xs">Enter PIN to unlock this locked record</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div id="unlockTxnInfo" class="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-4 text-sm text-orange-800"></div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Admin PIN</label>
                <input type="password" id="unlockPinInput" maxlength="8"
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-center text-2xl tracking-widest focus:outline-none focus:border-red-400"
                       placeholder="â€¢â€¢â€¢â€¢" oninput="clearUnlockError()" onkeydown="if(event.key==='Enter') confirmUnlock()"/>
                <p id="unlockError" class="text-red-600 text-xs mt-2 hidden">Incorrect PIN. Please try again.</p>
                <p class="text-xs text-gray-400 mt-2">PIN is set in Settings â†’ Admin PIN.</p>
                <div class="flex gap-3 mt-5">
                    <button onclick="closeUnlockModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-xl hover:bg-gray-50">Cancel</button>
                    <button onclick="confirmUnlock()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 font-semibold">Unlock & Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-y-auto m-4">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                <h2 class="text-2xl font-bold" id="modalTitle">New Transaction</h2>
            </div>
            <form id="transactionForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                        <select id="txnCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="QUOTATION">Quotation</option>
                            <option value="PROFORMA_INVOICE">Proforma Invoice</option>
                            <option value="PO">Purchase Order</option>
                            <option value="INVOICE">Invoice</option>
                            <option value="CREDIT_NOTE">Credit Note</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Direction *</label>
                        <select id="txnDirection" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="Outgoing">Outgoing (To Client)</option>
                            <option value="Incoming">Incoming (From Subcontractor)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party *</label>
                        <select id="txnParty" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Party</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Currency *</label>
                        <select id="txnCurrency" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="INR" data-symbol="â‚¹">INR (â‚¹)</option>
                            <option value="USD" data-symbol="$">USD ($)</option>
                            <option value="GBP" data-symbol="Â£">GBP (Â£)</option>
                            <option value="SGD" data-symbol="S$">SGD (S$)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Reference</label>
                        <select id="txnReferenceType" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-1" onchange="updateReferenceField()">
                            <option value="">-- Select Reference Type --</option>
                        </select>
                        <input type="text" id="txnReference" placeholder="Enter reference details" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <select id="txnStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="Draft">Draft</option>
                            <option value="Sent">Sent</option>
                            <option value="Approved">Approved</option>
                            <option value="Completed">Completed</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold">Line Items</h3>
                        <button type="button" onclick="addLineItem()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">+ Add Item</button>
                    </div>
                    
                    <!-- Line Items Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border px-2 py-2 text-left w-12">S.No</th>
                                    <th class="border px-2 py-2 text-left min-w-[200px]">Description</th>
                                    <th class="border px-2 py-2 text-left w-24">HSN Code</th>
                                    <th class="border px-2 py-2 text-left w-20">Qty</th>
                                    <th class="border px-2 py-2 text-left w-24">UOM</th>
                                    <th class="border px-2 py-2 text-left w-28">Cost/Unit</th>
                                    <th class="border px-2 py-2 text-left w-24">Discount%</th>
                                    <th class="border px-2 py-2 text-right w-28">Taxable Amt</th>
                                    <th class="border px-2 py-2 text-left w-20">SGST%</th>
                                    <th class="border px-2 py-2 text-left w-20">CGST%</th>
                                    <th class="border px-2 py-2 text-left w-20">IGST%</th>
                                    <th class="border px-2 py-2 text-right w-28">Total</th>
                                    <th class="border px-2 py-2 text-center w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody id="lineItems">
                                <!-- Line items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="totalSection" class="mt-4 bg-indigo-50 p-4 rounded-lg hidden">
                        <div class="flex justify-end">
                            <div class="space-y-2">
                                <div class="flex justify-between gap-8">
                                    <span class="font-medium">Subtotal (Before Tax):</span>
                                    <span class="font-bold" id="subtotalAmount">â‚¹0.00</span>
                                </div>
                                <div class="flex justify-between gap-8">
                                    <span class="font-medium">Total Tax:</span>
                                    <span class="font-bold" id="taxAmount">â‚¹0.00</span>
                                </div>
                                <div class="flex justify-between gap-8 text-lg border-t-2 pt-2">
                                    <span class="font-bold">Grand Total:</span>
                                    <span class="font-bold text-indigo-900" id="totalAmount">â‚¹0.00</span>
                                </div>
                                <div class="text-right mt-1">
                                    <span class="text-xs text-indigo-600 italic font-medium" id="totalAmountWords"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bank Account Selection (Invoice/Proforma only) -->
                <div id="txnBankSection" class="mt-4 pt-4 border-t hidden">
                    <label class="block text-sm font-semibold mb-2">ðŸ’° Deposit to Bank Account</label>
                    <select id="txnBankAccount" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Select Income Account --</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Select which bank account will receive payment for this invoice</p>
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t">
                    <button type="button" onclick="closeTransactionModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>

                <!-- Supporting Documents Section (Invoice/PO only, Generated/Approved status) -->
                <div id="supportingDocsSection" class="hidden mt-6 pt-6 border-t-2 border-dashed border-indigo-200">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <svg width="18" height="18" fill="none" stroke="#4f46e5" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="15" y2="15"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-indigo-800">Supporting Documents</h3>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full" id="docEligibilityBadge"></span>
                    </div>
                    <!-- Auto-populated transaction summary for attachments -->
                    <div id="docTxnSummary" class="hidden mb-3 bg-indigo-50 border border-indigo-200 rounded-xl p-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div><span class="text-xs text-gray-500 block">Transaction</span><span class="font-semibold text-indigo-800" id="docSummaryID">â€”</span></div>
                        <div><span class="text-xs text-gray-500 block">Party</span><span class="font-semibold text-gray-800" id="docSummaryParty">â€”</span></div>
                        <div><span class="text-xs text-gray-500 block">Date</span><span class="font-semibold text-gray-800" id="docSummaryDate">â€”</span></div>
                        <div><span class="text-xs text-gray-500 block">Status</span><span class="font-semibold text-gray-800" id="docSummaryStatus">â€”</span></div>
                    </div>

                    <!-- Upload Area -->
                    <div id="uploadDropZone"
                         class="border-2 border-dashed border-indigo-300 rounded-xl p-6 text-center cursor-pointer hover:bg-indigo-50 transition-colors mb-4"
                         onclick="document.getElementById('docFileInput').click()"
                         ondragover="event.preventDefault(); this.classList.add('bg-indigo-50')"
                         ondragleave="this.classList.remove('bg-indigo-50')"
                         ondrop="handleDocDrop(event)">
                        <svg class="mx-auto mb-2" width="40" height="40" fill="none" stroke="#6366f1" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p class="text-indigo-700 font-medium">Click or drag files here to attach</p>
                        <p class="text-xs text-gray-500 mt-1">PDF, Word, Excel, Images â€” Max 10 MB per file</p>
                        <input type="file" id="docFileInput" class="hidden" multiple
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif"
                               onchange="handleDocFileSelect(event)" />
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="hidden mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm text-blue-700 font-medium" id="uploadProgressText">Uploading...</span>
                        </div>
                        <div class="mt-2 bg-blue-200 rounded-full h-2">
                            <div id="uploadProgressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width:0%"></div>
                        </div>
                    </div>

                    <!-- Attached Documents List -->
                    <div id="attachedDocsList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sync Success Modal â€” no popup blocker issues -->
    <div id="syncSuccessModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md m-4 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-white text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg width="36" height="36" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold">Synced Successfully!</h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                    <div class="bg-green-50 rounded-xl p-3">
                        <div class="text-2xl font-bold text-green-700" id="syncCountApproved">0</div>
                        <div class="text-xs text-gray-500 mt-1">Approved</div>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-3">
                        <div class="text-2xl font-bold text-blue-700" id="syncCountAll">0</div>
                        <div class="text-xs text-gray-500 mt-1">Transactions</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-3">
                        <div class="text-2xl font-bold text-purple-700" id="syncCountParties">0</div>
                        <div class="text-xs text-gray-500 mt-1">Parties</div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 text-center mb-4">Your data has been saved to Google Sheets.</p>
                <a id="syncModalSheetLink" href="#" target="_blank"
                   class="block w-full text-center px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold mb-3">
                    ðŸ“Š Open Google Spreadsheet
                </a>
                <button onclick="document.getElementById('syncSuccessModal').classList.remove('show')"
                        class="block w-full text-center px-6 py-3 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>
    <div id="partyModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <h2 class="text-2xl font-bold" id="partyModalTitle">New Party</h2>
            </div>
            <form id="partyForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party Name *</label>
                        <input type="text" id="partyName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Party Type *</label>
                        <select id="partyType" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="Client">Client</option>
                            <option value="SubContractor">SubContractor</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
                        <textarea id="partyAddress" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">GST Number</label>
                        <input type="text" id="partyGST" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">PAN Number</label>
                        <input type="text" id="partyPAN" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contact Person</label>
                        <input type="text" id="partyContact" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                        <input type="email" id="partyEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Mobile</label>
                        <input type="tel" id="partyMobile" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
                    </div>
                </div>
                <div class="flex gap-3 justify-end mt-6 pt-4 border-t">
                    <button type="button" onclick="closePartyModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION - REPLACE WITH YOUR CREDENTIALS =====
        const CLIENT_ID = '807569986194-feca4li2k0t96tbbutlpu2ko64obe95k.apps.googleusercontent.com';
        // Default company logo (IMSE) â€” used if no logo has been uploaded in Settings
        const DEFAULT_LOGO = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCABCAJoDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD4Hor9l/8AiHt+Cf8A0MHxM/8ABlZ//IlH/EPb8E/+hg+Jn/gys/8A5Er9+/12yzvL7j+df9RM17R+8/Giiv2X/wCIe34J4/5GD4mf+DKz/wDkSj/iHt+Cf/QwfEz/AMGVn/8AIlH+u+Wd5fcH+oma9o/efjRRX7Lj/g3t+CZb/kYPiWB6/wBpWfH/AJKVyXgr/ghN8IviH4guLvT9b+IUXhO0ea1juX1G0a41K4jk8p9g+yjy44pI5kJZSZDtKkKuXpcaZa02m9PIiXA+aJpWjr5n5K0V+y//ABD3fBP/AKD/AMS//BlZ/wDyJXiP7UP/AAT8/Y+/Y78TaVo/jnx78VbLU9VVZkt7V4Lp4ICWXz5NlngRhlI4y57KRk1pQ4uwNafs6SlJ9lFmeI4NzChD2lZxiu7kj81qK/ZOz/4N+PgffWkU8XiL4lvFMiyI39pWeGUjIP8Ax6elSf8AEPb8E/8AoYPiX/4MrP8A+RKxfG2WJ2bl9xuuBM1aulH7z8aKK/Zf/iHt+Cf/AEMHxM/8GVn/APIlH/EPb8E/+hg+Jn/gys//AJEo/wBd8s7y+4P9RM17R+8/Giiv2XP/AAb2/BP/AKGD4l/+DKz/APkSj/iHu+Cf/QwfEz/wZWf/AMiUf67ZZ3l9wf6iZr2j95+NFFfr78Sv+CDnwR+H3w38ReIH134kumg6XdakwbU7MKwhheQg/wCi9PlrI/Z1/wCCGfwe+MP7PfgHxff618Q7a+8WeG9N1q4hg1C1WKKW5tIpnVA1sSFDOQMknGOTWn+uOXez9peVr22M/wDUnM/aeytG9r79D8maK/Zcf8G9vwTP/MwfEv8A8GVn/wDIlcr4i/4ISfCPwZ4vtIr/AFD4mXGgarLHbRahb6lYg6bO5EaR3Ctb7mSSRkVHjDYaTDKqjzKmHGmWydk39xU+B80irtRt6n5JUV+zH/EPb8Ewf+Rg+JZ/7iVn/wDIlH/EPd8E/wDoP/Ez/wAGVn/8iVP+u2Wd5fcV/qJmvaP3n3ZSZrX8FWcV94ghjmjWSNuCrDIPIr0V/BulBT/oFsP+AV+JVK6g7M/daVBzV0eSZ4oz9a6v4V6Naau959qgjn2Km3eM4znNdg3g3S8H/Qbf/vgUp4hRfK0VDDOS5kfOnxF1S417V7HwnptwYLnVENxqc8UzJNYaeDtZl2fMsszfuozlCB50isWg2npIIbHwpoSRoLXT9N023CqMiOG2hjX16KqqPoAK2vjdpHhf4NwX3jHUb7SfDdjcrDb6jf392lrbrtLLCGeRgigmRgBkZL9ya/NH/gop/wAFsNM8EareeB/hdFoXi1Zraez1nVpmM9ltliUKLWSKQCRhvfcxyoKgDPJHt5ZgK2YyjSw8W118u+v5Hg5rmNDLYSq4mST6Lv20PsvSv25/gprrlbX4u/DWZwxTYPElnv64yFMmSM9DjB7Gvy2+NFr8J/gl/wAFbNM8TeM/Fmn/ABT+HesyXniLVJGSPV4beSdL0QWjKjSCVIZhb4UjGwKCm3g+T/8ABLT9hGf/AIKBftU6d4UuZLy08K6VC2qeIr22BEkNomAI0Y8LJLIVjU9VBd9rbCK/d6L/AIJQfs3pAiD4N+BcIAB/xL1J9Op5r6TGVMBkGIlQ55Tc42aVla+2u9z5fCQzDiHDKvyQgoSvFu7vbfTa3RnznoP/AAWX/Zu1MxQ/8LB+wEgKq3Gh6girjsWEBUfnivafgz+0/wDDv9ogSjwP4z8PeKJYP9bBY3avPEPVouHUcHkrjiqn7RX/AATA/Z88Mfs+eOdS0/4ReCLO/wBO8Pahc208enqHhlS2kZXB7EEAivgL/gh//wAEdPBv7Vfwul+K/wAV7K71jQptQktNB0Vbl7e2vhDlJbidoyJGUTbkVAyjMT7gysBXkQo5TWwdXFwlOHI0rOzu3e1rW7dWezKtnFDG0sHOMJ86burqyVr3vfv0R+odyDZwvJKrRxxqWZmGAoHJOT2rg/2fv2nfAX7VPhm71n4feJLTxPpthdvZXE1vFLF5cyhWK7ZEVjw6kEDBDAgkV6V4G/YD+C/wy077NoXw38K6XABtKw2gXdyTyTyeSevrW837LHw3b73g/QD9bcGvnvrWG5WrSb6PS3zWv5n0n1XFcybcUuq1/B6fkcqsLscBHJ/3TQ8TxY3oyZ9RjNb+s/sb/CnxNpr2d74F8N3drJgvFJaqytjpxXlfjL/gnV4Y+C+g+IvFHwI0PTPA3xBbT5vs8ESu+k61IBvS3ubYuEUM6jEkRjkU4O4ruRilXoTfK20/TT566fcwq0cRBc8UmlvZ6/LTX70cv+3z4gPhj9iH4uXiuY3/AOEQ1OBGDbSrS2skSkHIwcuMY7jvjBp/8E6tVGrfsHfB+T94fL8Jadb/AD9f3UCxep4+Tj2x0rw3/gj5+2z4j/4KgeKPiN4K+LPhvwZf+HbPRIZDZ2+nSxCfzJijJKJJZMjAHAA9/QfpB4K+C/hT4b+E9P0LQtA03StH0uFbe0tLeIJFbxjoqjsBXp5m3gIvL6y99SUrp6WcTy8qSzCazKhL3HFxs1rdSPOM/X8qpeIdAsvFWiXem6jbRXlhfRNBcQSruSVGGGUj0wa9o/4Q3Sv+fG2/74FL/wAIZpf/AD4W/wD3wK8NYtJ3se88E3oz54+HGr3lndXvhrVZ7i71PQ1jaO8mTDanaPuEM5bJUyfI8cmMEyRl9iJJGK6uuz+K2heHvBXhXUfElxpttE+lWUgku1jG61t2aNpXJ7IoRXb2jz1FcXuPofzrpVVVffSscsqTo+43c3Ph7/yNEH1H8xXqMzBFYsQABkkngV5d8P8AjxPb9uR/MV6dfRGW0mUclkIHvxXBifjR6GG0ptnkH7KPx18D/GaXWR4N8a+D/FzWCQNdDQ9attRNsH37DJ5LtsDbWxuxnacdDXV/HD9o7wX+zhYaPe+N/EeleG7LW9QTS7Sa9mEYnuXBKRqOp6Ek9FAJJABNfmH/AMGxPg3Uvh18SPj34e1i0lsdW0Q6XYXtvIMNDNFJeo6n6MDXe/8AB0YgP7Kfw4GAQfF5BGM5/wBCuK+kqZFSlniy1Tbi7a+sbnzFLiCssilmbglKN9PSVj79/aX+BelftQfs/wDi7wBrH7uw8WaXNYGYIJGtHdf3c6qeC8UmyRc8bkFfy2/GT4T638Bvit4i8G+JLV7HXfDF9LYXsTKVG9GxvXI5jYYdWHDIykEggn+gP/ghx+2ef2u/2KNKttX1GO98Z+ASuh6wrPmeSNR/olwwLFj5kKgFz9+SKbHQ1W/bt/4JJeF/2tf2tvhb8Qf7JtUt7DVy/jbbN5b6xZxW4a2VwQdwEkEcLbSG2Tt6bl9ThzOHkWMrYLGfDr96Wj/7eX6HlcS5Ms/wdDHYP4tPub1X/br/AFKf/BBj9jC4/ZV/Yttda1u1e28VfEqRNevI5Ytk1nalMWlu3fIQtKQcFWuHUjjn6F8c/tV6P4U/a18CfCKBo7nxJ4ssb3WbqPqbGxt42CucEYaSbCrnPEUvA4Ndn8WPiv4c+Afwy1jxd4q1O10Tw34etjdXt3NkJDGMAAAcsxJCqqgszMqgEkA/jZ/wSw/ad1b9sT/gulqPxA1S4upU1qx1b+z4Z8KbKxSLbbQBASqbYgu4AnLlmJJJJ8ihhK2bSxWZV9oqUvnbRfJfku57NfGUcojhMrofFNxj8r6v5v8AM/X/APaq/wCTYfiN/wBivqf/AKSS186f8ED7uK5/4JYfDYRurmKXVEfB+6w1K64P5j8xX0X+1V/ybD8Rv+xX1P8A9JJa/Ev/AIJDfts/Hb9jjw39j0j4VeNfiF8I/EN619J/Z/h+7u5LaUfupZLOVMREtsCujHbujyCh37qyrLamMyqvCk0nGcHq0r6S0166k5vmdPBZvh6lVNxcJrRXtrHXTofdX/BbX/gm98YP26tb8FXnw31/Tl0rRLae3v8ARb/VJbKJpWcMlygCsjtgFDuwRhcZycfn7ff8G+/7U9rclE0rw7dKOkkPiaMI3037T+lfoz4u/wCDgL4WfDC9s7Txt8PPjb4Ivb6PzYbfXPDMdpJImcF1BuMsoPGVzzVA/wDByL+zqD/q/H3/AIJU/wDjtexleM4hwmGjQw+HUorZ8t/xTPFzTB8N4zEyxGIxLjN7rmt+DWh8mfsR/wDBMT9sH9hj9oLSvH+l+ENH8QJpkVxHc6K/jKG2h1RJIJIwjnJHysyyDcCMxjp1H1D8ef8Agp5+1X+zZ4Sudf8AFX7J8EWiWKmS6vNP8VLqUdqgGS8n2eNyiADl2AUdyK7r4Pf8F9P2d/jH8QtJ8Nwav4j0S+1u7isLOXVNIaO3eaVwkas6FwgZmA3PhRnJIAJr7TnhWSIqQpDcEHoa8zNM1xP1iM81wkb26qUXby1t+DPUynKcK8NKGUYyVr9HGST89L/ifjF/wbGamNb/AGm/i/erDHbrd6RBMIo/uxbrtjtHsM4/Cv0k/wCCoPwt8cfGr9hbx14Y+G6XcnjXVFsRpq21+tjKSl/bSSbZmdAv7pJOrDIyOc4Pxb/wRq+Glp8HP+CrX7VPhnTrOHTtN0i6ljsrWGPy47e2a/d4UVcDAEbJjAxjpxiv0K/ay/aU0H9kH9n/AMQfEbxNbapd6H4bEDXMOnRJLcv51xFbrsV3RT88qk5YcZ78U+JMRKedRr0I3b9m4ru7JpfoHDOHjDI50MRKyXtFJrortN/qfiJ/w6o/bqI/48fF59f+K7tcf+ldH/Dqj9ur/nx8Xf8Ahd2v/wAl19zf8RNvwDX/AJln4q8H/oFWX/yXS/8AETf8BP8AoWfir/4K7L/5Lr6T+1eIv+gKP/gD/wAz5ZZVwz/0Gy/8DX/yJ6p+xN8B/iB8LP2GPCvhb4pRX6a9FbXlpq8dzqaXsjCa7uGUNIrurZhdO5wOO2K8xH/BRG7+Gg/4RzXfhp431vW/D/8AxLdQ1GxsQbW/uIf3cs0WTny3dWZc9mFfTPwk/a58Nftifs9aF408MWmtWeleIDJLbR6lDHFOoimlgbeEkcD5o2Iwx4x9KnMSEnIGa+QjipKrUeKprmcndbWd9T7V4WLo01hKj5VFWe91ZWPhz/gnt/wW01H9qn9qHQvBc/w2sdDj1JlBvI9ee4aPMsafcNugP38/e7Y71+p91N5FpLJjJRC31wK/mR8Nf8FR/jt4P1aO/wBL8cQWF5F9yaHw5pSunOeD9l9q64/8Fwf2qCpB+Ll+QR/0A9K/+Ra+wzfgSviaynhFGnG23NJ6/cfE5P4g0cNQdPFuVSV97RX4XP0v/wCCI/7Y+l/tt/Gf4t+MIPh/Y+B9aOm6PBqUtpqRu11bDXhjkkBhjxIoJXfyWXYOiKK53/g6KYN+yr8Nx/1N5/H/AEK4r80vA/8AwVt/aF+GrXDaB8Q/7JN0FE32bw/pSeaFztz/AKL2yfzqfxt/wV+/aN+I9lDba78SH1W3t382OO50DSnVHwRuA+y9cH9a7qPCWLpZtHMKfKoxtaPNJ7K29jgqcYYWrlE8uq8znK95WSWrvsmW/wDgkZ+2rcfsS/tmeH9XublIfCfieSPQfEYlYJFHazSKFuGLHC+RJtkLf3BIP4q/pRVxJCGBDBhwRyCK/mA/4eQfGbr/AMJZY9f+hb0r/wCRq7iz/wCC2/7Umn2cUEPxa1BIYUCIv9iaUdqgYAybWnxLwliszrRxFPlhJKz1bv2+z0/yDhbjHC5VQlh6nNON7rRK3fqfXv8AwctfttT33iXQ/gVoV2gs7KKLXvEzQyBmedt32W1cA5XYn78qw5823YdOfn3/AIN3cL/wU10IYx/xItT7/wDTEV4vr/8AwVA+OnirWZ9R1Lxvb319dNulnm8PaW8khxjJJtvTFT+Ev+CqPx78Cayuo6N47h029RWRZoPDulK4BGCM/Ze9eph8ixNDKJZZTjG8otN8z1b6/D/SPKr8QYatnEc0qSlaMk1Gy0S2W5/Rl+1U/wDxjD8Rv+xX1P8A9JJa+S/+Ddb4xaX8RP8AgnTpXh22dU1XwJqt7p1/AXUuRNO93FKFBJCMk+wFgMtDJjpX5T33/BbX9qPVLKW2uPixeywTxtFIjaFpRV1IwQf9F6EVznhL/gqz+0B4DupJ9E+Ib6RNMAJGs9D0yHzADkBttsNwz2Oa+YpcCY2OCnhZyjeUlJO70smu3W59RV4/wUsdTxcYytGMotWWt2nffyP33/bN/wCCcvwq/b3t9H/4WJo95eXnh8SpYXtlfS2lxAku3emUO11JRTh1bBHGMnPgJ/4Nw/2bP+fTxv8A+D1v/iK/Li2/4Lr/ALVMEQU/FN5SP4n8P6Xn9LYU8f8ABd39qgf81OH/AIT+mf8AyPSw3CXEWHgqVDEKMV0UpW/IeJ4w4cxFR1a+GcpPq4xv+Z+tPwf/AOCCH7Ofwa+ImleJrPw/r+raholzHe2aanrEs1vHNG25HaNdofDAHa+5TjkEZFfY+q6nb6Npk93dTw2traRtLNNK4SOFFBLMzHhVABJJ6AV/OdL/AMF2/wBqiSJlHxQKFhgMvh/TMj3/AOPc1h+I/wDgs1+034tspbbUfitqF1a3CGOWBtH01YpVPVWQWwVh7EVliOBs5xU1LF14yt3cn+hvhuPclwkHHB0HG/ZJffqffv8AwRS+LNt8cv8AgqJ+1D4vsp1ubDXpnubOVX3iS2+3OsJByQR5apgg49OK/TH4x/Bvwz+0F8N9S8IeMdIttd8N6uIxeWM5YRziOVJUyVIPDojcHqtfzfeCv+Cs/wC0J8OLqabQviCulS3KhJXtvD2lIXUHIB/0X1roz/wXD/apPT4uagP+4HpX/wAi11ZrwTmGJxSr0ZRjZRS1d1ypK97eRx5Rx3gMLhXh60JTbcm9FZ8zbta/mftR/wAOZf2Yv+iQ+Hf+/wBc/wDx2l/4czfsxf8ARIfDv/f+6/8Ajtfir/w/C/aq/wCiu6h/4ItK/wDkaj/h+F+1V/0V3UP/AARaV/8AI1Z/6n8Qf9BX/k8/8jb/AF04e/6BP/JIH7weNPhx4O/Yy/ZG8Tz+D/CtlaaR4A8PalqthpcU0iRkxRTXRj3sWKhpN3PON3TtX5Rj/g5C1gjP/CntMPv/AMJQ/P8A5K1866n/AMFsP2oda0y4s7v4r3k9rdxNDNE+haUVkRgQykfZehBIriD/AMFH/jKT/wAjVZH/ALlvSf8A5Gr0Mp4Mq0VN4+Masm735pL16HmZvxxTrOCwEpUopWa5Yv06nh9FFFfpR+YhRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH/9k=';
        // ==========================================================

        const DISCOVERY_DOCS = [
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';
        const APP_FOLDER_NAME = 'Engineering Service App';  // Must match exact folder name on Drive

        // Currency symbols
        const CURRENCY_SYMBOLS = {
            'INR': 'â‚¹',
            'USD': '$',
            'GBP': 'Â£',
            'SGD': 'S$'
        };

        let tokenClient;
        let accessToken = null;
        let appFolderId = null;
        let transactions = [];
        let parties = [];
        let settings = {};
        let expenses = [];        // Expense & Bills module
        let bankAccounts = [];    // Bank accounts for income & expense tracking
        let currentView = 'dashboard';
        let currentTransaction = null;
        let settingsUnlocked = false;  // Password protection for Settings
        let currentParty = null;
        let lineItemCounter = 0;

        // Utility Functions
        function formatNumber(num) {
            // Format number with 2 decimal places - no apostrophe/quote prefix
            if (isNaN(num) || num === null || num === undefined) return '0.00';
            const fixed = parseFloat(num).toFixed(2);
            // Manual Indian comma format: last 3 digits, then groups of 2
            const parts = fixed.split('.');
            let intPart = parts[0];
            const decPart = parts[1];
            const isNegative = intPart.startsWith('-');
            if (isNegative) intPart = intPart.slice(1);
            let result = '';
            if (intPart.length > 3) {
                result = intPart.slice(-3);
                intPart = intPart.slice(0, -3);
                while (intPart.length > 2) {
                    result = intPart.slice(-2) + ',' + result;
                    intPart = intPart.slice(0, -2);
                }
                result = intPart + ',' + result;
            } else {
                result = intPart;
            }
            return (isNegative ? '-' : '') + result + '.' + decPart;
        }

        function getCurrencySymbol() {
            const select = document.getElementById('txnCurrency');
            if (!select) return 'â‚¹';
            return CURRENCY_SYMBOLS[select.value] || 'â‚¹';
        }

        function getStateFromGST(gstNumber) {
            if (!gstNumber || gstNumber.length < 2) return null;
            return gstNumber.substring(0, 2);
        }

        function shouldUseIGST(companyGST, partyGST) {
            // If either party doesn't have GST, use IGST
            if (!companyGST || !partyGST) return true;
            
            // If states are different, use IGST
            const companyState = getStateFromGST(companyGST);
            const partyState = getStateFromGST(partyGST);
            
            return companyState !== partyState;
        }

        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: DISCOVERY_DOCS,
                });
                renderLoginScreen();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (response) => {
                    if (response.error) {
                        console.error('Token error:', response);
                        alert('Failed to authenticate. Please try again.');
                        return;
                    }
                    
                    if (response.access_token) {
                        accessToken = response.access_token;
                        gapi.client.setToken({ access_token: accessToken });
                        console.log('Access token received, loading data...');
                        await loadDataFromDrive();
                    }
                },
            });
        }

        function handleSignIn() {
            tokenClient.requestAccessToken({ prompt: 'consent', enable_granular_consent: false });
        }

        function handleSignOut() {
            const token = accessToken;
            accessToken = null;
            gapi.client.setToken(null);
            
            if (token) {
                google.accounts.oauth2.revoke(token, (done) => {
                    console.log('Access revoked:', done);
                });
            }
            
            transactions = [];
            parties = [];
            settings = {};
            expenses = [];
            bankAccounts = [];
            appFolderId = null;   // Reset so next login re-searches Drive
            settingsUnlocked = false;  // Lock settings on signout
            
            renderLoginScreen();
        }

        // Google Drive Functions
        async function getOrCreateAppFolder() {
            if (appFolderId) return appFolderId;

            // All known folder name variants (handles renames / typos)
            const namesToTry = [
                'Engineering Service App',
                'Engineering Services App',
                'EngineeringServicesApp',
                APP_FOLDER_NAME
            ];

            try {
                for (const folderName of namesToTry) {
                    const resp = await fetch(
                        `https://www.googleapis.com/drive/v3/files?` +
                        `q=${encodeURIComponent(`name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`)}` +
                        `&fields=files(id,name)&spaces=drive&orderBy=createdTime`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.files && data.files.length > 0) {
                            appFolderId = data.files[0].id;
                            console.log('âœ… Found folder "' + data.files[0].name + '" id:', appFolderId);
                            return appFolderId;
                        }
                    }
                }

                // Not found â€” create fresh
                console.log('Creating new folder:', APP_FOLDER_NAME);
                const createResp = await fetch(
                    'https://www.googleapis.com/drive/v3/files',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: APP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' })
                    }
                );
                const folder = await createResp.json();
                appFolderId = folder.id;
                console.log('âœ… Created folder:', appFolderId);
                return appFolderId;

            } catch (error) {
                console.error('âŒ Folder error:', error);
                throw error;
            }
        }

        async function saveFileToDrive(fileName, fileData) {
            const folderId = await getOrCreateAppFolder();
            const jsonStr  = JSON.stringify(fileData);
            const blob     = new Blob([jsonStr], { type: 'application/json' });
            const authHdr  = { 'Authorization': `Bearer ${accessToken}` };

            // Check if file already exists in folder
            const q = encodeURIComponent(`name='${fileName}' and '${folderId}' in parents and trashed=false`);
            const listRes = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)&spaces=drive`,
                { headers: authHdr }
            );
            const listData = await listRes.json();
            const existingId = listData.files && listData.files.length > 0 ? listData.files[0].id : null;

            const form = new FormData();
            form.append('metadata', new Blob(
                [JSON.stringify(existingId ? { name: fileName } : { name: fileName, parents: [folderId] })],
                { type: 'application/json' }
            ));
            form.append('file', blob);

            const uploadRes = existingId
                ? await fetch(`https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart`,
                    { method: 'PATCH', headers: authHdr, body: form })
                : await fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`,
                    { method: 'POST', headers: authHdr, body: form });

            if (!uploadRes.ok) {
                const err = await uploadRes.json().catch(() => ({}));
                throw new Error(`Drive save failed for ${fileName}: ${err.error?.message || uploadRes.statusText}`);
            }
            const saved = await uploadRes.json();
            console.log(`âœ… Saved ${fileName} (${saved.id})`);
            return saved;
        }

        async function loadFileFromDrive(fileName) {
            try {
                const folderId = await getOrCreateAppFolder();

                // Step 1: Find the file ID inside the app folder
                const q = encodeURIComponent(
                    `name='${fileName}' and '${folderId}' in parents and trashed=false`
                );
                const listRes = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)&spaces=drive&orderBy=modifiedTime+desc`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                if (!listRes.ok) {
                    console.warn(`List failed for ${fileName}:`, listRes.status);
                    return null;
                }
                const listData = await listRes.json();
                if (!listData.files || listData.files.length === 0) {
                    console.log(`${fileName} not found in folder â€” will be created on first save`);
                    return null;
                }

                // Step 2: Download file content
                const fileId = listData.files[0].id;
                console.log(`ðŸ“„ Downloading ${fileName} (${fileId})...`);
                const dlRes = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                if (!dlRes.ok) {
                    console.warn(`Download failed for ${fileName}:`, dlRes.status);
                    return null;
                }
                const text = await dlRes.text();
                if (!text || text.trim() === '') {
                    console.warn(`${fileName} is empty`);
                    return null;
                }
                const parsed = JSON.parse(text);
                console.log(`âœ… ${fileName} loaded`);
                return parsed;

            } catch (error) {
                console.error(`âŒ Error loading ${fileName}:`, error);
                return null;
            }
        }

        async function loadDataFromDrive() {
            // Show loading indicator
            const appEl = document.getElementById('app');
            if (appEl) {
                appEl.innerHTML = `<div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-gray-600 font-medium">Loading your data from Drive...</p>
                        <p class="text-gray-400 text-xs mt-1" id="loadStatus">Connecting to folder...</p>
                    </div>
                </div>`;
            }

            try {
                const setStatus = (msg) => {
                    const el = document.getElementById('loadStatus');
                    if (el) el.textContent = msg;
                };

                setStatus('Finding app folder...');
                // Load all 4 files â€” each individually so one failure doesn't kill others
                const [txnData, partyData, settingsData, expData, bankData] = await Promise.all([
                    loadFileFromDrive('transactions.json'),
                    loadFileFromDrive('parties.json'),
                    loadFileFromDrive('settings.json'),
                    loadFileFromDrive('expenses.json'),
                    loadFileFromDrive('bankAccounts.json')
                ]);

                setStatus('Processing data...');
                transactions = Array.isArray(txnData)        ? txnData      : [];
                parties      = Array.isArray(partyData)      ? partyData    : [];
                settings     = (settingsData && typeof settingsData === 'object' && !Array.isArray(settingsData))
                                ? settingsData : {};
                expenses     = Array.isArray(expData)        ? expData      : [];
                bankAccounts = Array.isArray(bankData)       ? bankData     : getDefaultBankAccounts();

                console.log('âœ… Data loaded â€” transactions:', transactions.length,
                    '| parties:', parties.length,
                    '| settings keys:', Object.keys(settings).length,
                    '| expenses:', expenses.length);

                renderApp();

            } catch (error) {
                console.error('âŒ Error loading data from Drive:', error);
                const appEl2 = document.getElementById('app');
                if (appEl2) {
                    appEl2.innerHTML = `<div class="min-h-screen flex items-center justify-center p-8">
                        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md text-center">
                            <div class="text-5xl mb-4">âš ï¸</div>
                            <h2 class="text-xl font-bold text-red-700 mb-2">Could not load your data</h2>
                            <p class="text-gray-600 text-sm mb-1">${error.message || 'Drive connection failed.'}</p>
                            <p class="text-gray-400 text-xs mb-6">Check your internet connection and try signing in again.</p>
                            <button onclick="handleSignOut()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-medium">â†© Sign Out &amp; Retry</button>
                        </div>
                    </div>`;
                }
            }
        }

        async function saveData(type, data) {
            try {
                if (!accessToken) {
                    alert('Session expired. Please sign in again.');
                    handleSignOut();
                    return;
                }
                
                await saveFileToDrive(`${type}.json`, data);
                console.log(`Successfully saved ${type}`);
            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                
                if (error.status === 401 || error.status === 403) {
                    console.log('Token expired, requesting new token...');
                    
                    try {
                        await new Promise((resolve, reject) => {
                            tokenClient.requestAccessToken({
                                prompt: 'none',
                                callback: async (response) => {
                                    if (response.error) {
                                        reject(response.error);
                                        return;
                                    }
                                    
                                    if (response.access_token) {
                                        accessToken = response.access_token;
                                        gapi.client.setToken({ access_token: accessToken });
                                        console.log('New token received, retrying save...');
                                        
                                        try {
                                            await saveFileToDrive(`${type}.json`, data);
                                            console.log(`Successfully saved ${type} after token refresh`);
                                            resolve();
                                        } catch (retryError) {
                                            console.error('Retry failed:', retryError);
                                            alert('Failed to save. Please try again or sign in again.');
                                            reject(retryError);
                                        }
                                    }
                                }
                            });
                        });
                    } catch (refreshError) {
                        console.error('Token refresh failed:', refreshError);
                        alert('Session expired. Please sign in again.');
                        handleSignOut();
                    }
                } else {
                    alert(`Failed to save ${type}. Error: ${error.message || 'Unknown error'}. Please try again.`);
                }
            }
        }

        // Transaction Functions

        // Returns Indian Financial Year 4-char code  e.g. Apr-2025â†’Mar-2026 = "2526"

        // â”€â”€ Default Bank Accounts (created on first load) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getDefaultBankAccounts() {
            return [
                {
                    id: 'BA001',
                    bankName: 'HDFC Bank',
                    accountName: 'HDFC Bank INR Account',
                    currency: 'INR',
                    accountNo: '',
                    ifscCode: '',
                    branchAddress: '',
                    isActive: true,
                    type: 'Income'  // Income or Expense
                },
                {
                    id: 'BA002',
                    bankName: 'HDFC Bank',
                    accountName: 'HDFC Bank USD Account',
                    currency: 'USD',
                    accountNo: '',
                    ifscCode: '',
                    branchAddress: '',
                    isActive: true,
                    type: 'Income'
                },
                {
                    id: 'BA003',
                    bankName: 'SBI Bank',
                    accountName: 'SBI Bank Expense Account',
                    currency: 'INR',
                    accountNo: '',
                    ifscCode: '',
                    branchAddress: '',
                    isActive: true,
                    type: 'Expense'
                },
                {
                    id: 'BA004',
                    bankName: 'HDFC Bank',
                    accountName: 'HDFC Bank Expense Account',
                    currency: 'INR',
                    accountNo: '',
                    ifscCode: '',
                    branchAddress: '',
                    isActive: true,
                    type: 'Expense'
                }
            ];
        }

        function getFinancialYearCode(date) {
            const d       = date || new Date();
            const month   = d.getMonth();      // 0=Jan â€¦ 3=Apr â€¦ 11=Dec
            const year    = d.getFullYear();
            // Janâ€“Mar â†’ still in FY that started previous April
            const fyStart = (month < 3) ? year - 1 : year;
            const fyEnd   = fyStart + 1;
            const sy      = String(fyStart).slice(-2);
            const ey      = String(fyEnd).slice(-2);
            return sy + ey;                    // "2526", "2627", etc.
        }

        function generateTxnID(category) {
            const fyCode = getFinancialYearCode(new Date());
            const prefix = category === 'QUOTATION'         ? 'QTE'
                         : category === 'PROFORMA_INVOICE'  ? 'PI'
                         : category === 'PO'                ? 'PO'
                         : category === 'INVOICE'           ? 'INV'
                         : category === 'CREDIT_NOTE'       ? 'CN' : 'TXN';

            // Count only same-category transactions in the CURRENT financial year
            const fyTxns = transactions.filter(t => {
                if (t.txnCategory !== category) return false;
                // Match FY code embedded in the existing ID (4 digits before the serial)
                const match = t.txnID.match(/[A-Z]+(\d{4})\d{3,}$/);
                return match ? match[1] === fyCode : false;
            });
            const nextNum = (fyTxns.length + 1).toString().padStart(3, '0');
            return prefix + fyCode + nextNum;
        }

        function calculateTotals(items) {
            let subtotal = 0, totalTax = 0;
            items.forEach(item => {
                const itemTotal = item.qty * item.rate;
                const discount = (itemTotal * (item.discountPct || 0)) / 100;
                const afterDiscount = itemTotal - discount;
                const sgst = (afterDiscount * (item.sgstPct || 0)) / 100;
                const cgst = (afterDiscount * (item.cgstPct || 0)) / 100;
                const igst = (afterDiscount * (item.igstPct || 0)) / 100;
                subtotal += afterDiscount;
                totalTax += sgst + cgst + igst;
            });
            return {
                subtotal: subtotal.toFixed(2),
                tax: totalTax.toFixed(2),
                total: (subtotal + totalTax).toFixed(2)
            };
        }

        // PDF Export Function with A4 sizing and header on all pages

        // â”€â”€ Indian Number to Words â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function numberToWords(amount) {
            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN',
                          'EIGHT', 'NINE', 'TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN',
                          'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY',
                          'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];

            function twoDigits(n) {
                if (n < 20) return ones[n];
                return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            }
            function threeDigits(n) {
                if (n >= 100)
                    return ones[Math.floor(n / 100)] + ' HUNDRED' +
                           (n % 100 ? ' ' + twoDigits(n % 100) : '');
                return twoDigits(n);
            }

            if (!amount || isNaN(amount)) return 'ZERO';
            amount = Math.round(parseFloat(amount) * 100) / 100; // round to 2dp

            const rupees = Math.floor(amount);
            const paise  = Math.round((amount - rupees) * 100);

            if (rupees === 0 && paise === 0) return 'ZERO';

            let words = '';
            // Indian system: crore, lakh, thousand, hundred
            if (rupees >= 10000000) {
                words += threeDigits(Math.floor(rupees / 10000000)) + ' CRORE ';
            }
            if (rupees % 10000000 >= 100000) {
                words += twoDigits(Math.floor((rupees % 10000000) / 100000)) + ' LAKH ';
            }
            if (rupees % 100000 >= 1000) {
                words += twoDigits(Math.floor((rupees % 100000) / 1000)) + ' THOUSAND ';
            }
            if (rupees % 1000 >= 100) {
                words += ones[Math.floor((rupees % 1000) / 100)] + ' HUNDRED ';
            }
            if (rupees % 100 > 0) {
                words += twoDigits(rupees % 100) + ' ';
            }
            words = words.trim();
            if (paise > 0) {
                words += ' AND ' + twoDigits(paise) + ' PAISE';
            }
            return words.trim() + ' ONLY';
        }
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function exportTransactionToPDF(txn) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                const companyName    = settings.companyName    || 'Engineering Services Company';
                const companyAddress = settings.companyAddress || '';
                const companyGST     = settings.gstNumber      || '';
                const bankName       = settings.bankName       || '';
                const beneficiary    = settings.beneficiary    || '';
                const accountNo      = settings.accountNo      || '';
                const ifscCode       = settings.ifscCode       || '';
                const branchAddress  = settings.branchAddress  || '';

                const currencySymbol = CURRENCY_SYMBOLS[txn.currency] || 'â‚¹';

                // PDF-safe currency prefix â€” jsPDF default font (Helvetica) cannot render
                // â‚¹ or Â£ or S$ correctly â€” they print as apostrophe + broken spacing.
                // Use plain text labels inside PDF only.
                const PDF_CURRENCY = {
                    'INR': 'INR ',
                    'USD': 'USD ',
                    'GBP': 'GBP ',
                    'SGD': 'SGD '
                };
                const pdfCurrency = PDF_CURRENCY[txn.currency] || 'INR ';

                // Safe number formatter â€” never produces leading apostrophe
                function fmt(n) {
                    const num = parseFloat(n) || 0;
                    const fixed = num.toFixed(2);
                    const [intPart, decPart] = fixed.split('.');
                    const isNeg = intPart.startsWith('-');
                    let digits = isNeg ? intPart.slice(1) : intPart;
                    let result = '';
                    if (digits.length > 3) {
                        result = digits.slice(-3);
                        digits = digits.slice(0, -3);
                        while (digits.length > 2) {
                            result = digits.slice(-2) + ',' + result;
                            digits = digits.slice(0, -2);
                        }
                        result = digits + ',' + result;
                    } else {
                        result = digits;
                    }
                    return (isNeg ? '-' : '') + result + '.' + decPart;
                }

                function fmtAmt(n) {
                    return pdfCurrency + fmt(n);
                }

                // Header drawn on every page
                const logoData   = settings.logoData || DEFAULT_LOGO;
                const companyMSME = settings.msmeNumber || '';

                function addHeader(doc, pageNum) {
                    const pageW  = 210;
                    const margin = 14;

                    // â”€â”€ Logo: natural aspect ratio, fixed height 16mm â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    const logoH  = 16;
                    const logoW  = 26;  // approx 16:10 ratio for IMSE logo
                    const logoX  = margin;
                    const logoY  = 9;

                    if (logoData) {
                        try {
                            const ext = logoData.includes('image/png') ? 'PNG'
                                      : logoData.includes('image/svg') ? 'SVG' : 'JPEG';
                            doc.addImage(logoData, ext, logoX, logoY, logoW, logoH);
                        } catch(e) { console.warn('Logo render failed', e); }
                    }

                    // â”€â”€ Company name â€” FULL PAGE CENTERED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(25, 40, 110);
                    const nameUC = companyName.toUpperCase();
                    // Auto-fit: start at 13pt charSpace 1.5, shrink to fit full 182mm
                    // Larger font, tighter letter spacing â€” reduce only if doesn't fit
                    let sz = 16, sp = 0.8;
                    const fits = (s, p) => {
                        doc.setFontSize(s); doc.setCharSpace(p);
                        return (doc.getTextWidth(nameUC) + p * nameUC.length * 0.352) <= 182;
                    };
                    while (!fits(sz, sp)) {
                        if (sp > 0.1) sp -= 0.1; else { sz -= 0.5; sp = 0.1; }
                        if (sz < 8) { sp = 0; break; }
                    }
                    doc.setFontSize(sz); doc.setCharSpace(sp);
                    doc.text(nameUC, 105, logoY + 6, { align: 'center' });
                    doc.setCharSpace(0);
                    doc.setTextColor(0, 0, 0);

                    // â”€â”€ GST + MSME â€” right-aligned below name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(40, 40, 100);
                    let ryY = logoY + 12;
                    if (companyGST) {
                        doc.text('GST: ' + companyGST, pageW - margin, ryY, { align: 'right' });
                        ryY += 4;
                    }
                    if (companyMSME) {
                        doc.text('MSME: ' + companyMSME, pageW - margin, ryY, { align: 'right' });
                    }
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);

                    // â”€â”€ Divider line â€” double rule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    const lineY = logoY + logoH + 2;
                    doc.setDrawColor(79, 70, 229);
                    doc.setLineWidth(0.6);
                    doc.line(margin, lineY, pageW - margin, lineY);
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(180, 180, 230);
                    doc.line(margin, lineY + 0.8, pageW - margin, lineY + 0.8);
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.2);
                }

                // Footer draws company address + divider at bottom of each page
                function addFooter(doc, isProforma = false) {
                    const pageW  = 210;
                    const margin = 14;
                    const footY  = 285; // near bottom of A4 (297mm)
                    doc.setDrawColor(79, 70, 229);
                    doc.setLineWidth(0.4);
                    doc.line(margin, footY - 3, pageW - margin, footY - 3);
                    doc.setLineWidth(0.2);
                    doc.setDrawColor(0, 0, 0);
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    if (companyAddress) {
                        const addrLine = companyAddress.replace(/\n/g, ' | ');
                        const lines = doc.splitTextToSize(addrLine, 182);
                        doc.text(lines.slice(0,2), 105, footY, { align: 'center' });
                    }
                    // Add disclaimer for Proforma Invoice
                    if (isProforma) {
                        doc.setFontSize(6.5);
                        doc.setTextColor(140, 140, 140);
                        doc.text('This is a Proforma Invoice for estimation purposes only. Not a tax invoice.', 105, 291, { align: 'center' });
                    }
                    doc.setTextColor(0, 0, 0);
                }

                const HEADER_BOTTOM = 32; // mm â€” content starts here

                addHeader(doc, 1);

                // Document title â€” starts below header divider
                let startY = HEADER_BOTTOM + 8;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                const docTitle = txn.txnCategory === 'QUOTATION'         ? 'QUOTATION' :
                                 txn.txnCategory === 'PROFORMA_INVOICE'  ? 'PROFORMA INVOICE' :
                                 txn.txnCategory === 'PO'                ? 'PURCHASE ORDER' :
                                 txn.txnCategory === 'CREDIT_NOTE'       ? 'CREDIT NOTE' : 'INVOICE';
                doc.text(docTitle, 105, startY, { align: 'center' });

                // Transaction meta
                startY += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(docTitle + ' No: ' + txn.txnID,   14, startY);
                doc.text('Date: '   + txn.txnDate,          14, startY + 6);
                if (txn.reference) doc.text('Ref: ' + txn.reference, 14, startY + 12);

                // Party block
                startY += 24;
                doc.setFont(undefined, 'bold');
                doc.text(txn.txnDirection === 'Outgoing' ? 'To:' : 'From:', 14, startY);
                doc.setFont(undefined, 'normal');
                const party = parties.find(p => p.partyName === txn.partyName);
                doc.text(txn.partyName, 14, startY + 6);
                if (party && party.address) {
                    const aLines = doc.splitTextToSize(party.address, 90);
                    doc.text(aLines, 14, startY + 12);
                    startY += aLines.length * 5;
                }
                if (party && party.gstNumber) {
                    doc.text('GST: ' + party.gstNumber, 14, startY + 12);
                }

                // â”€â”€ Line items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                startY += 22;

                // Column widths â€” A4 usable width = 182mm (14mm left margin, 14mm right)
                // Total col widened to 28mm to fit "INR 29,500.00" without overflow
                const COL = {
                    sno:     7,
                    desc:   36,
                    hsn:    13,
                    qty:    11,
                    uom:    10,
                    rate:   18,
                    disc:   10,
                    taxable:20,
                    sgst:    9,
                    cgst:    9,
                    igst:    9,
                    total:  28   // widened from 20 â†’ 28 to fit "INR 29,500.00"
                };
                // Verify total = 182: 7+36+13+11+10+18+10+20+9+9+9+28 = 180 (2mm tolerance OK)

                // Build line-item rows
                let grandSubtotal = 0, grandTax = 0, grandTotal = 0;

                const tableData = txn.items.map((item, idx) => {
                    const base      = item.qty * item.rate;
                    const disc      = (base * (item.discountPct || 0)) / 100;
                    const taxable   = base - disc;
                    const sgstAmt   = (taxable * (item.sgstPct || 0)) / 100;
                    const cgstAmt   = (taxable * (item.cgstPct || 0)) / 100;
                    const igstAmt   = (taxable * (item.igstPct || 0)) / 100;
                    const lineTotal = taxable + sgstAmt + cgstAmt + igstAmt;

                    grandSubtotal += taxable;
                    grandTax      += sgstAmt + cgstAmt + igstAmt;
                    grandTotal    += lineTotal;

                    return [
                        idx + 1,
                        item.description,
                        item.hsnCode || '',
                        fmt(item.qty),
                        item.uom || 'NOS',
                        fmt(item.rate),
                        (item.discountPct || 0) + '%',
                        fmt(taxable),
                        (item.sgstPct || 0) + '%',
                        (item.cgstPct || 0) + '%',
                        (item.igstPct || 0) + '%',
                        fmt(lineTotal)
                    ];
                });

                // Append 3 totals rows directly inside the table
                // Simple 2-column approach: label | amount â€” drawn as a separate table below

                doc.autoTable({
                    startY: startY,
                    head: [['#', 'Description', 'HSN', 'Qty', 'UOM', 'Rate', 'Disc%', 'Taxable Amt', 'SGST%', 'CGST%', 'IGST%', 'Total']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: 255,
                        fontSize: 7,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: { fontSize: 7, textColor: [30, 30, 30] },
                    columnStyles: {
                        0:  { cellWidth: COL.sno,     halign: 'center' },
                        1:  { cellWidth: COL.desc,    halign: 'left'   },
                        2:  { cellWidth: COL.hsn,     halign: 'center' },
                        3:  { cellWidth: COL.qty,     halign: 'right'  },
                        4:  { cellWidth: COL.uom,     halign: 'center' },
                        5:  { cellWidth: COL.rate,    halign: 'right'  },
                        6:  { cellWidth: COL.disc,    halign: 'center' },
                        7:  { cellWidth: COL.taxable, halign: 'right'  },
                        8:  { cellWidth: COL.sgst,    halign: 'center' },
                        9:  { cellWidth: COL.cgst,    halign: 'center' },
                        10: { cellWidth: COL.igst,    halign: 'center' },
                        11: { cellWidth: COL.total,   halign: 'right'  }
                    },
                    didDrawPage: function(data) { addFooter(doc);
                        if (data.pageNumber > 1) addHeader(doc, data.pageNumber);
                    }
                });

                // â”€â”€ Totals table â€” drawn flush below the line-items table â”€â”€
                // Amount column matches the "Total" column width above (28mm)
                const totalTableWidth =
                    COL.sno + COL.desc + COL.hsn + COL.qty + COL.uom +
                    COL.rate + COL.disc + COL.taxable + COL.sgst + COL.cgst +
                    COL.igst + COL.total;

                const amountColW = COL.total;                      // 28 mm â€” same as Total col
                const labelColW  = totalTableWidth - amountColW;   // rest = label

                const amtInWords = numberToWords(grandTotal);
                const totalsTableData = [
                    [ 'Subtotal (Before Tax)',                                              fmtAmt(grandSubtotal)           ],
                    [ 'Total Tax',                                                          fmtAmt(grandTax)                ],
                    [ 'Grand Total (' + (txn.currency || 'INR') + ')',                     '(' + fmtAmt(grandTotal) + ')'  ],
                    [ 'Grand Total (' + (txn.currency || 'INR') + ' ' + amtInWords + ')',  ''                              ]
                ];

                doc.autoTable({
                    startY: doc.lastAutoTable.finalY, // starts exactly where items table ends
                    margin: { left: 14 },
                    tableWidth: totalTableWidth,
                    head: [],
                    body: totalsTableData,
                    theme: 'grid',
                    styles: { fontSize: 8, textColor: [30, 30, 30] },
                    columnStyles: {
                        0: { cellWidth: labelColW,  halign: 'right',
                             fontStyle: 'normal', fillColor: [235, 235, 250] },
                        1: { cellWidth: amountColW, halign: 'right',
                             fontStyle: 'normal', fillColor: [235, 235, 250] }
                    },
                    didParseCell: function(data) {
                        if (data.row.index === 2) {
                            // Grand Total numeric row â€” bold, darker blue
                            data.cell.styles.fontStyle  = 'bold';
                            data.cell.styles.fontSize   = 9;
                            data.cell.styles.fillColor  = [210, 210, 245];
                            data.cell.styles.textColor  = [30, 30, 100];
                        }
                        if (data.row.index === 3) {
                            // Amount in words row â€” italic, full width label, no amount col
                            data.cell.styles.fontStyle  = 'italic';
                            data.cell.styles.fontSize   = 7;
                            data.cell.styles.fillColor  = [225, 225, 250];
                            data.cell.styles.textColor  = [50, 50, 120];
                            if (data.column.index === 0) {
                                data.cell.colSpan = 2;   // span both columns
                                data.cell.styles.halign = 'left';
                            }
                        }
                    },
                    didDrawPage: function(data) { addFooter(doc);
                        if (data.pageNumber > 1) addHeader(doc, data.pageNumber);
                    }
                });

                let finalY = doc.lastAutoTable.finalY + 8;

                // â”€â”€ Bank details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (bankName && txn.txnDirection === 'Outgoing') {
                    if (finalY > 250) {
                        doc.addPage();
                        addHeader(doc, doc.internal.getNumberOfPages());
                        finalY = 50;
                    }
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Bank Details:', 14, finalY);
                    doc.setFont(undefined, 'normal');
                    let bY = finalY + 6;
                    doc.text('Bank: ' + bankName, 14, bY);
                    if (beneficiary)   { bY += 5; doc.text('Beneficiary: ' + beneficiary, 14, bY); }
                    if (accountNo)     { bY += 5; doc.text('Account No: '  + accountNo,   14, bY); }
                    if (ifscCode)      { bY += 5; doc.text('IFSC: '        + ifscCode,    14, bY); }
                    if (branchAddress) { bY += 5; doc.text('Branch: '      + branchAddress, 14, bY); }
                }

                // Footer on every page â€” company address centred + page X of Y right
                const totalPages = doc.internal.getNumberOfPages();
                for (let p = 1; p <= totalPages; p++) {
                    doc.setPage(p);
                    addFooter(doc, txn.txnCategory === 'PROFORMA_INVOICE');   // draws divider line + company address
                    // Page X of Y â€” right-aligned at very bottom
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(130, 130, 130);
                    doc.text('Page ' + p + ' of ' + totalPages, 196, 292, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                }

                doc.save(txn.txnID + '_' + txn.partyName + '.pdf');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF: ' + error.message);
            }
        }

        // Google Sheets Sync with approved transactions and hyperlinks
        // Show in-page sync success modal (no popup blocker, no alert)
        function showSyncSuccess(sheetsUrl, approvedCount, allCount, partiesCount) {
            document.getElementById('syncCountApproved').textContent = approvedCount;
            document.getElementById('syncCountAll').textContent       = allCount;
            document.getElementById('syncCountParties').textContent   = partiesCount;
            document.getElementById('syncModalSheetLink').href        = sheetsUrl;
            document.getElementById('syncSuccessModal').classList.add('show');
        }

        async function syncToGoogleSheets() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;

            try {
                if (!accessToken) { alert('Please sign in first'); return; }

                btn.textContent = 'Syncing...';
                btn.disabled = true;

                const SHEET_NAMES = ['ApprovedTxns', 'AllTransactions', 'ProformaInvoices', 'Parties', 'Settings', 'Expenses'];
                let spreadsheetId = settings.spreadsheetId;

                // Step 1: Verify saved ID still works
                if (spreadsheetId) {
                    const checkRes = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=spreadsheetId`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    if (!checkRes.ok) {
                        console.warn('Saved spreadsheet ID invalid, will search Drive...');
                        spreadsheetId = null;
                        settings.spreadsheetId = null;
                    }
                }

                // Step 2: Search Drive for existing spreadsheet by name
                if (!spreadsheetId) {
                    btn.textContent = 'Searching Drive...';
                    try {
                        // Search inside the app folder first, then anywhere in Drive
                        const folderId = await getOrCreateAppFolder();
                        const queries = [
                            `name='Engineering Services Data' and '${folderId}' in parents and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,
                            `name='Engineering Services Data' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`
                        ];
                        for (const q of queries) {
                            const searchRes = await fetch(
                                `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)&spaces=drive&orderBy=modifiedTime+desc`,
                                { headers: { 'Authorization': `Bearer ${accessToken}` } }
                            );
                            if (searchRes.ok) {
                                const found = await searchRes.json();
                                if (found.files && found.files.length > 0) {
                                    spreadsheetId = found.files[0].id;
                                    settings.spreadsheetId = spreadsheetId;
                                    await saveData('settings', settings);
                                    console.log('Found spreadsheet:', spreadsheetId, found.files[0].name);
                                    // If found in root Drive (not in app folder), move it in
                                    if (q.includes("in parents") === false) {
                                        try {
                                            const fid = await getOrCreateAppFolder();
                                            await fetch(
                                                `https://www.googleapis.com/drive/v3/files/${spreadsheetId}?addParents=${fid}&removeParents=root&fields=id`,
                                                { method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}` } }
                                            );
                                            console.log('Migrated spreadsheet into app folder');
                                        } catch(me) { console.warn('Move skipped:', me); }
                                    }
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Drive search failed:', e);
                    }
                }

                // Step 3: Create new spreadsheet if still not found
                if (!spreadsheetId) {
                    btn.textContent = 'Creating spreadsheet...';
                    const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            properties: { title: 'Engineering Services Data' },
                            sheets: SHEET_NAMES.map((title, i) => ({ properties: { title, sheetId: i } }))
                        })
                    });
                    if (!createRes.ok) {
                        const e = await createRes.json();
                        throw new Error('Could not create spreadsheet: ' + (e.error?.message || createRes.statusText));
                    }
                    const created = await createRes.json();
                    spreadsheetId = created.spreadsheetId;
                    settings.spreadsheetId = spreadsheetId;
                    await saveData('settings', settings);
                    console.log('Created new spreadsheet:', spreadsheetId);

                    // Move spreadsheet into app folder (remove from root, add to app folder)
                    try {
                        const folderId = await getOrCreateAppFolder();
                        await fetch(
                            `https://www.googleapis.com/drive/v3/files/${spreadsheetId}?addParents=${folderId}&removeParents=root&fields=id,parents`,
                            { method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}` } }
                        );
                        console.log('Moved new spreadsheet into app folder:', folderId);
                    } catch (moveErr) {
                        console.warn('Could not move spreadsheet to app folder:', moveErr);
                    }
                }

                // Step 4: Read existing sheet tab titles
                btn.textContent = 'Checking sheet tabs...';
                const metaRes = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                if (!metaRes.ok) throw new Error('Could not read spreadsheet metadata');
                const meta = await metaRes.json();
                const existingSheets = meta.sheets.map(s => ({ title: s.properties.title, sheetId: s.properties.sheetId }));
                console.log('Existing tabs:', existingSheets.map(s => s.title).join(', '));

                // Step 5: Add or rename any missing/wrong-named tabs
                const sheetMap = {};
                existingSheets.forEach(s => { sheetMap[s.title] = s.sheetId; });
                const oldNameMap = { 'ApprovedTxns': 'Approved Transactions', 'AllTransactions': 'All Transactions', 'Parties': 'Parties' };
                const sheetRequests = [];

                SHEET_NAMES.forEach(name => {
                    if (!sheetMap.hasOwnProperty(name)) {
                        const oldSheet = existingSheets.find(s => s.title === oldNameMap[name]);
                        if (oldSheet) {
                            sheetRequests.push({ updateSheetProperties: { properties: { sheetId: oldSheet.sheetId, title: name }, fields: 'title' } });
                            console.log('Renaming tab:', oldNameMap[name], '->', name);
                        } else {
                            sheetRequests.push({ addSheet: { properties: { title: name } } });
                            console.log('Adding tab:', name);
                        }
                    }
                });

                if (sheetRequests.length > 0) {
                    btn.textContent = 'Fixing sheet tabs...';
                    const fixRes = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,
                        {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ requests: sheetRequests })
                        }
                    );
                    if (!fixRes.ok) {
                        const e = await fixRes.json();
                        throw new Error('Could not fix tabs: ' + (e.error?.message || fixRes.statusText));
                    }
                }

                // Step 6: Build data arrays
                btn.textContent = 'Preparing data...';
                const approvedTxns = transactions.filter(t => t.status === 'Approved');
                // Auto-detect current URL â€” works on GitHub Pages AND any custom domain
                const appUrl = window.location.origin + window.location.pathname.replace(/\/+$/, '') + '/';

                const approvedRows = [['Txn ID','Category','Direction','Party','Date','Reference','Currency','Subtotal','Tax','Grand Total','Link']];
                approvedTxns.forEach(txn => {
                    const tot = calculateTotals(txn.items || []);
                    approvedRows.push([txn.txnID, txn.txnCategory, txn.txnDirection, txn.partyName, txn.txnDate,
                        txn.reference || '', txn.currency || 'INR',
                        parseFloat(tot.subtotal), parseFloat(tot.tax), parseFloat(tot.total),
                        `=HYPERLINK("${appUrl}#pdf=${txn.txnID}","View PDF: ${txn.txnID}")`]);
                });

                const allRows = [['Txn ID','Category','Direction','Party','Date','Reference','Status','Currency','Subtotal','Tax','Grand Total']];
                transactions.forEach(txn => {
                    const tot = calculateTotals(txn.items || []);
                    allRows.push([txn.txnID, txn.txnCategory, txn.txnDirection, txn.partyName, txn.txnDate,
                        txn.reference || '', txn.status, txn.currency || 'INR',
                        parseFloat(tot.subtotal), parseFloat(tot.tax), parseFloat(tot.total)]);
                });

                // Proforma Invoices sheet
                const proformaInvoices = transactions.filter(t => t.txnCategory === 'PROFORMA_INVOICE');
                const proformaRows = [['PI ID','Party','Date','Reference','Currency','Subtotal','Tax','Grand Total','Status','Converted to Invoice']];
                proformaInvoices.forEach(txn => {
                    const tot = calculateTotals(txn.items || []);
                    proformaRows.push([
                        txn.txnID, txn.partyName, txn.txnDate, txn.reference || '',
                        txn.currency || 'INR', parseFloat(tot.subtotal), parseFloat(tot.tax), parseFloat(tot.total),
                        txn.status, txn.convertedToInvoice || ''
                    ]);
                });

                const partyRows = [['Party ID','Name','Type','Address','GST','PAN','Contact Person','Email','Mobile']];
                parties.forEach(p => {
                    partyRows.push([p.partyID||'', p.partyName||'', p.partyType||'', p.address||'',
                        p.gstNumber||'', p.panNumber||'', p.contactPerson||'', p.email||'', p.mobile||'']);
                });

                // Expenses sheet data
                const expenseRows = [['Voucher No','Bill No','Bill Date','Company/Vendor','Description','Currency','Exch Rate',
                    'Bill Amt','Bill Amt INR','CGST','SGST','IGST','Credit Note','TDS?','Taxable Amt','TDS%','TDS Amt','Net Amt',
                    'Advance Amt','Advance Date','Balance','Pay Status','Pay Mode','Cheque No','Pay Date','Bank','Remark']];
                expenses.forEach(e => {
                    expenseRows.push([
                        e.voucherNo||'', e.billNo||'', e.billDate||'', e.companyName||'', e.description||'',
                        e.currency||'INR', e.exchRate||1, parseFloat(e.billAmount||0), parseFloat(e.billAmtINR||0),
                        parseFloat(e.cgst||0), parseFloat(e.sgst||0), parseFloat(e.igst||0), parseFloat(e.creditNote||0),
                        e.tdsApplicable?'Y':'N', parseFloat(e.taxableAmt||0), e.tdsPct||0, parseFloat(e.tdsAmt||0),
                        parseFloat(e.netAmt||0), parseFloat(e.advanceAmt||0), e.advanceDate||'',
                        parseFloat(e.balanceAmt||0), e.payStatus||'', e.payMode||'', e.chequeNo||'',
                        e.payDate||'', e.bankName||'', e.remark||''
                    ]);
                });

                // Settings sheet data
                const settingsRows = [
                    ['Field', 'Value'],
                    ['Company Name',    settings.companyName    || ''],
                    ['GST Number',      settings.gstNumber      || ''],
                    ['Company Address', settings.companyAddress || ''],
                    ['Bank Name',       settings.bankName       || ''],
                    ['Beneficiary',     settings.beneficiary    || ''],
                    ['Account No',      settings.accountNo      || ''],
                    ['IFSC Code',       settings.ifscCode       || ''],
                    ['Branch Address',  settings.branchAddress  || ''],
                    ['Last Synced',     new Date().toLocaleString('en-IN')]
                ];

                // Step 7: Clear old data (ignore errors)
                btn.textContent = 'Clearing old data...';
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values:batchClear`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ranges: SHEET_NAMES.map(n => n + '!A:AZ') })  // includes Settings + Expenses
                }).catch(e => console.warn('Clear skipped:', e));

                // Step 8: Write data
                btn.textContent = 'Writing data...';
                const writeRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values:batchUpdate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        valueInputOption: 'USER_ENTERED',
                        data: [
                            { range: 'ApprovedTxns!A1',      values: approvedRows   },
                            { range: 'AllTransactions!A1',   values: allRows        },
                            { range: 'ProformaInvoices!A1',  values: proformaRows   },
                            { range: 'Parties!A1',           values: partyRows      },
                            { range: 'Settings!A1',        values: settingsRows },
                            { range: 'Expenses!A1',        values: expenseRows  }
                        ]
                    })
                });
                if (!writeRes.ok) {
                    const e = await writeRes.json();
                    throw new Error('Write failed: ' + (e.error?.message || writeRes.statusText));
                }
                console.log('Data written successfully');

                // Step 9: Format header rows bold+blue (optional, don't fail if it errors)
                try {
                    const metaRes2 = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    if (metaRes2.ok) {
                        const meta2 = await metaRes2.json();
                        const finalIds = SHEET_NAMES.map(name => {
                            const s = meta2.sheets.find(sh => sh.properties.title === name);
                            return s ? s.properties.sheetId : null;
                        }).filter(id => id !== null);
                        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                requests: finalIds.map(sheetId => ({
                                    repeatCell: {
                                        range: { sheetId, startRowIndex: 0, endRowIndex: 1 },
                                        cell: { userEnteredFormat: {
                                            backgroundColor: { red: 0.31, green: 0.27, blue: 0.9 },
                                            textFormat: { bold: true, foregroundColor: { red: 1, green: 1, blue: 1 } }
                                        }},
                                        fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                    }
                                }))
                            })
                        });
                    }
                } catch (fmtErr) { console.warn('Header formatting skipped:', fmtErr); }

                // Done!
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                const sheetsUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;

                // NO alert(), NO window.open() â€” both cause issues.
                // Show in-page success modal with direct clickable link instead.
                showSyncSuccess(sheetsUrl, approvedTxns.length, transactions.length, parties.length);

                // Also update the persistent banner if visible
                const banner = document.getElementById('syncSuccessBanner');
                const linkEl = document.getElementById('syncSheetLink');
                if (banner && linkEl) {
                    linkEl.href = sheetsUrl;
                    banner.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Sync error:', error);
                alert('Sync failed: ' + (error.message || 'Unknown error'));
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // UI Rendering
        function renderLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <svg class="text-white" width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Engineering Services</h1>
                        <p class="text-gray-600 mb-8">Management System</p>
                        <button onclick="handleSignIn()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl px-6 py-4 hover:bg-gray-50 transition-colors font-medium text-gray-700">
                            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                            Sign in with Google
                        </button>
                        <p class="text-xs text-gray-500 mt-6">Using Modern Google Identity Services</p>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const activeLogo = settings.logoData || DEFAULT_LOGO;
            const logoHtml = `<img src="${activeLogo}" alt="IMSE Logo" class="h-12 w-auto object-contain"/>`;
            document.getElementById('app').innerHTML = `
                <nav class="bg-white shadow-lg border-b">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                ${logoHtml}
                                <div>
                                    <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">${settings.companyName || 'Engineering Services'}</h1>
                                    <p class="text-xs text-gray-600">Management System</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="px-4 py-2 bg-green-100 rounded-lg text-sm">
                                    <span class="text-green-700 font-medium">âœ“ Connected to Google Drive</span>
                                </div>
                                <button onclick="handleSignOut()" class="p-2 hover:bg-gray-100 rounded-lg" title="Sign Out">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="switchView('dashboard')" class="px-4 py-2 rounded-lg ${currentView === 'dashboard' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Dashboard</button>
                            <button onclick="switchView('transactions')" class="px-4 py-2 rounded-lg ${currentView === 'transactions' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Transactions</button>
                            <button onclick="switchView('expenses')" class="px-4 py-2 rounded-lg ${currentView === 'expenses' ? 'bg-orange-100 text-orange-700' : 'text-gray-600 hover:bg-gray-100'}">ðŸ’¸ Expenses</button>
                            <button onclick="switchView('mis')" class="px-4 py-2 rounded-lg ${currentView === 'mis' ? 'bg-green-100 text-green-700' : 'text-gray-600 hover:bg-gray-100'}">ðŸ“Š MIS Report</button>
                            <button onclick="switchView('parties')" class="px-4 py-2 rounded-lg ${currentView === 'parties' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Parties</button>
                            <button onclick="switchView('settings')" class="px-4 py-2 rounded-lg ${currentView === 'settings' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}">Settings</button>
                        </div>
                    </div>
                </nav>
                <main class="max-w-7xl mx-auto px-6 py-8" id="mainContent"></main>
            `;

            renderView();
            handleDeepLink(); // handle #pdf=TXN_ID links from Google Sheets
        }

        function switchView(view) {
            currentView = view;
            // Lock settings when navigating away
            if (view !== 'settings') {
                settingsUnlocked = false;
            }
            renderView();
        }

        function renderView() {
            const content = document.getElementById('mainContent');
            if (!content) {
                console.error('mainContent element not found');
                return;
            }
            
            if (currentView === 'dashboard') renderDashboard(content);
            else if (currentView === 'transactions') renderTransactions(content);
            else if (currentView === 'expenses') renderExpenses(content);
            else if (currentView === 'mis') renderMIS(content);
            else if (currentView === 'parties') renderParties(content);
            else if (currentView === 'settings') renderSettings(content);
        }

        function renderDashboard(content) {
            const outgoingQuotations = transactions.filter(t => t.txnCategory === 'QUOTATION' && t.txnDirection === 'Outgoing');
            const proformaInvoices = transactions.filter(t => t.txnCategory === 'PROFORMA_INVOICE' && t.txnDirection === 'Outgoing');
            const outgoingPOs = transactions.filter(t => t.txnCategory === 'PO' && t.txnDirection === 'Outgoing');
            const outgoingInvoices = transactions.filter(t => t.txnCategory === 'INVOICE' && t.txnDirection === 'Outgoing');
            const creditNotes = transactions.filter(t => t.txnCategory === 'CREDIT_NOTE');
            const incomingPOs = transactions.filter(t => t.txnCategory === 'PO' && t.txnDirection === 'Incoming');

            content.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingQuotations.length}</div>
                        <div class="text-blue-100 text-sm">Quotations Issued</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl p-6 text-white shadow-lg cursor-pointer" onclick="switchView('transactions')">
                        <div class="text-3xl font-bold">${proformaInvoices.length}</div>
                        <div class="text-orange-100 text-sm">ðŸ“‹ Proforma Invoices</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingPOs.length}</div>
                        <div class="text-green-100 text-sm">POs Received</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${outgoingInvoices.length}</div>
                        <div class="text-purple-100 text-sm">Invoices Raised</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${creditNotes.length}</div>
                        <div class="text-red-100 text-sm">Credit Notes</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-3xl font-bold">${incomingPOs.length}</div>
                        <div class="text-orange-100 text-sm">POs to SubContractors</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg cursor-pointer" onclick="switchView('expenses')">
                        <div class="text-3xl font-bold">${expenses.length}</div>
                        <div class="text-yellow-100 text-sm">ðŸ’¸ Expenses / Bills</div>
                    </div>
                    <div class="bg-gradient-to-br from-teal-500 to-green-600 rounded-2xl p-6 text-white shadow-lg cursor-pointer" onclick="switchView('mis')">
                        <div class="text-xl font-bold">
                            ${(() => { const rev = transactions.filter(t=>t.txnCategory==='INVOICE'&&t.txnDirection==='Outgoing'&&['Approved','Sent','Completed','Paid'].includes(t.status)).reduce((s,t)=>{const tot=calculateTotals(t.items||[]);return s+parseFloat(tot.total);},0); const exp=expenses.reduce((s,e)=>s+(parseFloat(e.billAmtINR)||0),0); const gp=rev-exp; return (gp>=0?'â–² ':'â–¼ ')+'â‚¹'+(Math.abs(gp)/100000).toFixed(1)+'L'; })()}
                        </div>
                        <div class="text-teal-100 text-sm">ðŸ“Š Gross Profit</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                    ${transactions.length === 0 ? '<p class="text-gray-500 text-center py-8">No transactions yet. Click "+ New Transaction" to get started!</p>' : 
                        transactions.slice(-5).reverse().map(t => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                                <div>
                                    <div class="font-semibold">${t.txnID}</div>
                                    <div class="text-sm text-gray-600">${t.partyName}</div>
                                </div>
                                <span class="text-xs px-3 py-1 rounded-full ${
                                    t.status === 'Draft' ? 'bg-gray-100' : t.status === 'Sent' ? 'bg-blue-100' : 'bg-green-100'
                                }">${t.status}</span>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        function renderTransactions(content) {
            const sheetsId  = settings.spreadsheetId;
            const sheetsUrl = sheetsId ? `https://docs.google.com/spreadsheets/d/${sheetsId}` : null;

            content.innerHTML = `
                <!-- Header bar -->
                <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                    <h2 class="text-3xl font-bold">Transactions</h2>
                    <div class="flex gap-2 items-center flex-wrap justify-end">
                        ${sheetsUrl ? `<a href="${sheetsUrl}" target="_blank" class="px-4 py-2 bg-emerald-50 border border-emerald-300 text-emerald-700 rounded-xl hover:bg-emerald-100 text-sm font-medium flex items-center gap-2">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M9,17H7v-7h2V17z M13,17h-2V7h2V17z M17,17h-2v-4h2V17z"/></svg>
                            Google Sheet</a>` : ''}
                        <button onclick="syncToGoogleSheets()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 flex items-center gap-2 text-sm">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M9,17H7v-7h2V17z M13,17h-2V7h2V17z M17,17h-2v-4h2V17z"/></svg>
                            Sync to Sheets</button>
                        <button onclick="openTransactionModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm">+ New Transaction</button>
                    </div>
                </div>

                <!-- Sync success banner -->
                <div id="syncSuccessBanner" class="hidden mb-4 bg-green-50 border border-green-300 rounded-xl p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-7 h-7 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg width="14" height="14" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div>
                            <p class="font-semibold text-green-800 text-sm">Synced!</p>
                            <a id="syncSheetLink" href="#" target="_blank" class="text-green-700 underline text-xs">Click to open spreadsheet â†’</a>
                        </div>
                    </div>
                    <button onclick="document.getElementById('syncSuccessBanner').classList.add('hidden')" class="text-green-600 text-lg font-bold px-2">âœ•</button>
                </div>

                <!-- Search + filter bar -->
                <div class="bg-white rounded-2xl shadow-sm p-4 mb-4 flex flex-wrap gap-3 items-center">
                    <div class="flex-1 min-w-48 relative">
                        <svg class="absolute left-3 top-2.5 text-gray-400" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        <input type="text" id="txnSearchInput" placeholder="Search by ID, party, reference..." 
                               class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300"
                               oninput="filterTransactions()"/>
                    </div>
                    <select id="txnFilterStatus" onchange="filterTransactions()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">All Statuses</option>
                        <option>Draft</option><option>Sent</option><option>Approved</option>
                        <option>Completed</option><option>Paid</option>
                    </select>
                </div>

                <!-- Grouped transaction sections -->
                <div id="txnGroupContainer">
                    ${renderGroupedTransactions(transactions)}
                </div>
            `;
        }

        // Status colour badge
        function statusBadge(status) {
            const cls = {
                'Draft':     'bg-gray-100 text-gray-600',
                'Sent':      'bg-blue-100 text-blue-700',
                'Approved':  'bg-green-100 text-green-700',
                'Completed': 'bg-purple-100 text-purple-700',
                'Paid':      'bg-emerald-100 text-emerald-700'
            }[status] || 'bg-gray-100 text-gray-600';
            return `<span class="px-2 py-0.5 rounded-full text-xs font-medium ${cls}">${status}</span>`;
        }

        // Build one transaction row
        function txnRow(t) {
            const locked = (t.txnCategory === 'PO' && t.status === 'Paid') ||
                           (t.txnCategory === 'INVOICE' && t.status === 'Completed');
            const hasAttach = (t.attachments||[]).length > 0;
            const showDocs  = (t.txnCategory === 'INVOICE' || t.txnCategory === 'PO') &&
                              ['Approved','Sent','Completed','Paid'].includes(t.status);
            const tJson = JSON.stringify(t).replace(/'/g,"&apos;");
            return `<tr class="border-b hover:bg-gray-50 text-sm">
                <td class="px-3 py-2 font-medium text-indigo-700 whitespace-nowrap">${t.txnID}</td>
                <td class="px-3 py-2 max-w-xs truncate" title="${t.partyName}">${t.partyName}</td>
                <td class="px-3 py-2 text-gray-500 whitespace-nowrap">${t.txnDate}</td>
                <td class="px-3 py-2 text-gray-500">${t.reference || 'â€”'}</td>
                <td class="px-3 py-2">${statusBadge(t.status)}</td>
                <td class="px-3 py-2 text-right whitespace-nowrap">
                    <button onclick='exportTransactionToPDF(${tJson})' class="text-blue-600 hover:text-blue-800 mr-1" title="PDF">
                        <svg class="inline" width="15" height="15" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                    </button>
                    ${showDocs ? `<button onclick='openAttachmentsViewer(${tJson})' class="mr-1 ${hasAttach ? 'text-green-600' : 'text-gray-400'}" title="Docs (${(t.attachments||[]).length})">
                        <svg class="inline" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                        ${hasAttach ? `<span class="text-xs">(${t.attachments.length})</span>` : ''}
                    </button>` : ''}
                    ${locked
                        ? `<span class="text-xs text-gray-400 italic mr-1" title="Record locked">ðŸ”’</span>
                           <button disabled class="text-gray-300 cursor-not-allowed mr-1 text-xs">Edit</button>
                           <button onclick='requestUnlockDelete(${tJson})' class="text-orange-500 hover:text-red-700 text-xs font-medium" title="Delete with Admin PIN">ðŸ”“ Del</button>`
                        : `${t.txnCategory === 'PROFORMA_INVOICE' && t.status === 'Approved' && !t.convertedToInvoice
                            ? `<button onclick='convertToInvoice(${tJson})' class="text-green-700 hover:text-green-900 mr-2 text-xs font-bold bg-green-50 px-2 py-1 rounded border border-green-300" title="Convert to Final Invoice">âœ“ Convert to Invoice</button>`
                            : ''}
                           ${t.txnCategory === 'PROFORMA_INVOICE' && t.convertedToInvoice
                            ? `<span class="text-xs text-green-700 mr-2 bg-green-50 px-2 py-1 rounded" title="Converted to ${t.convertedToInvoice}">âœ“ Converted â†’ ${t.convertedToInvoice}</span>`
                            : ''}
                           <button onclick='editTransaction(${tJson})' class="text-indigo-600 hover:text-indigo-800 mr-1 text-xs font-medium">Edit</button>
                           <button onclick="deleteTransaction('${t.txnID}')" class="text-red-600 hover:text-red-800 text-xs font-medium">Del</button>`
                    }
                </td>
            </tr>`;
        }

        // Group config: label, category match, direction match, header colour
        const TXN_GROUPS = [
            { label: 'Quotations (Client)',           cat: 'QUOTATION',         dir: 'Outgoing',  color: 'bg-blue-600'   },
            { label: 'Proforma Invoices',              cat: 'PROFORMA_INVOICE',  dir: 'Outgoing',  color: 'bg-orange-500' },
            { label: 'Invoices (Client)',              cat: 'INVOICE',           dir: 'Outgoing',  color: 'bg-purple-600' },
            { label: 'Credit Notes',                  cat: 'CREDIT_NOTE',       dir: null,        color: 'bg-red-600'    },
            { label: 'Purchase Orders (SubCon)',       cat: 'PO',          dir: 'Incoming',  color: 'bg-orange-600' },
            { label: 'Quotations (SubCon / Incoming)',cat: 'QUOTATION',   dir: 'Incoming',  color: 'bg-cyan-600'   },
            { label: 'Outgoing POs',                  cat: 'PO',          dir: 'Outgoing',  color: 'bg-green-700'  },
        ];

        function renderGroupedTransactions(txnList) {
            if (!txnList || txnList.length === 0)
                return '<p class="text-gray-400 text-center py-12">No transactions found.</p>';

            return TXN_GROUPS.map(g => {
                const rows = txnList.filter(t =>
                    t.txnCategory === g.cat && (g.dir === null || t.txnDirection === g.dir)
                );
                if (rows.length === 0) return '';
                return `
                <div class="bg-white rounded-2xl shadow-sm mb-4 overflow-hidden">
                    <div class="${g.color} px-4 py-2 flex justify-between items-center">
                        <span class="text-white font-semibold text-sm">${g.label}</span>
                        <span class="bg-white bg-opacity-20 text-white text-xs px-2 py-0.5 rounded-full">${rows.length}</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="px-3 py-2 text-left">ID</th>
                                    <th class="px-3 py-2 text-left">Party</th>
                                    <th class="px-3 py-2 text-left">Date</th>
                                    <th class="px-3 py-2 text-left">Reference</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                    <th class="px-3 py-2 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>${rows.map(txnRow).join('')}</tbody>
                        </table>
                    </div>
                </div>`;
            }).join('');
        }

        function filterTransactions() {
            const q      = (document.getElementById('txnSearchInput')?.value || '').toLowerCase();
            const status = document.getElementById('txnFilterStatus')?.value || '';
            const filtered = transactions.filter(t => {
                const matchQ = !q ||
                    t.txnID.toLowerCase().includes(q) ||
                    (t.partyName||'').toLowerCase().includes(q) ||
                    (t.reference||'').toLowerCase().includes(q) ||
                    (t.status||'').toLowerCase().includes(q);
                const matchS = !status || t.status === status;
                return matchQ && matchS;
            });
            const container = document.getElementById('txnGroupContainer');
            if (container) container.innerHTML = renderGroupedTransactions(filtered);
        }



        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  BANK ACCOUNTS MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function renderBankAccountsList() {
            if (!bankAccounts || bankAccounts.length === 0) {
                return '<p class="text-gray-400 text-sm py-4">No bank accounts yet. Click "+ Add Account"</p>';
            }
            return bankAccounts.map(ba => {
                const typeColor = ba.type === 'Income' ? 'text-green-700 bg-green-50' : ba.type === 'Expense' ? 'text-orange-700 bg-orange-50' : 'text-blue-700 bg-blue-50';
                const statusBadge = ba.isActive ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Active</span>' : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">Inactive</span>';
                return `<div class="border rounded-lg p-3 hover:bg-gray-50 flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">${ba.accountName}</div>
                        <div class="text-xs text-gray-500 mt-0.5">
                            ${ba.bankName} &nbsp;Â·&nbsp; ${ba.currency} &nbsp;Â·&nbsp;
                            <span class="px-1.5 py-0.5 rounded text-xs ${typeColor}">${ba.type}</span>
                            ${ba.accountNo ? ' &nbsp;Â·&nbsp; Acc: ' + ba.accountNo : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${statusBadge}
                        <button onclick='editBankAccount(${JSON.stringify(ba).replace(/'/g,"&apos;")})' class="text-indigo-600 hover:text-indigo-800 text-xs">Edit</button>
                        <button onclick="deleteBankAccount('${ba.id}')" class="text-red-600 hover:text-red-800 text-xs">Del</button>
                    </div>
                </div>`;
            }).join('');
        }

        let currentBankAccount = null;

        function openBankAccountModal(ba = null) {
            currentBankAccount = ba;
            document.getElementById('bankAccountModalTitle').textContent = ba ? 'Edit Bank Account' : 'Add Bank Account';
            if (ba) {
                document.getElementById('baAccountName').value   = ba.accountName || '';
                document.getElementById('baBankName').value      = ba.bankName || '';
                document.getElementById('baCurrency').value      = ba.currency || 'INR';
                document.getElementById('baType').value          = ba.type || 'Income';
                document.getElementById('baAccountNo').value     = ba.accountNo || '';
                document.getElementById('baIFSC').value          = ba.ifscCode || '';
                document.getElementById('baActive').value        = String(ba.isActive !== false);
                document.getElementById('baBranchAddress').value = ba.branchAddress || '';
            } else {
                document.getElementById('bankAccountForm').reset();
                document.getElementById('baCurrency').value = 'INR';
                document.getElementById('baType').value = 'Income';
                document.getElementById('baActive').value = 'true';
            }
            document.getElementById('bankAccountModal').classList.add('show');
        }

        function closeBankAccountModal() {
            document.getElementById('bankAccountModal').classList.remove('show');
            currentBankAccount = null;
        }

        async function saveBankAccount(e) {
            e.preventDefault();
            const ba = {
                id:             currentBankAccount?.id || 'BA' + String(bankAccounts.length + 1).padStart(3, '0'),
                accountName:    document.getElementById('baAccountName').value,
                bankName:       document.getElementById('baBankName').value,
                currency:       document.getElementById('baCurrency').value,
                type:           document.getElementById('baType').value,
                accountNo:      document.getElementById('baAccountNo').value,
                ifscCode:       document.getElementById('baIFSC').value,
                isActive:       document.getElementById('baActive').value === 'true',
                branchAddress:  document.getElementById('baBranchAddress').value
            };

            if (currentBankAccount) {
                const idx = bankAccounts.findIndex(b => b.id === currentBankAccount.id);
                if (idx >= 0) bankAccounts[idx] = ba;
            } else {
                bankAccounts.push(ba);
            }

            await saveData('bankAccounts', bankAccounts);
            closeBankAccountModal();
            renderView(); // Refresh settings view
        }

        function editBankAccount(ba) { openBankAccountModal(ba); }

        async function deleteBankAccount(id) {
            if (!confirm('Delete this bank account?')) return;
            bankAccounts = bankAccounts.filter(b => b.id !== id);
            await saveData('bankAccounts', bankAccounts);
            renderView();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  EXPENSES & BILLS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function renderExpenses(content) {
            content.innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                    <h2 class="text-3xl font-bold">ðŸ’¸ Expenses & Bills</h2>
                    <button onclick="openExpenseModal()" class="px-5 py-2 bg-orange-600 text-white rounded-xl hover:bg-orange-700 font-medium">+ New Expense</button>
                </div>

                <!-- Search + filter bar -->
                <div class="bg-white rounded-xl shadow-sm p-3 mb-4 flex flex-wrap gap-3 items-center">
                    <div class="flex-1 min-w-48 relative">
                        <svg class="absolute left-3 top-2.5 text-gray-400" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        <input type="text" id="expSearchInput" placeholder="Search by vendor, bill no, description..."
                               class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"
                               oninput="filterExpenses()"/>
                    </div>
                    <select id="expFilterStatus" onchange="filterExpenses()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">All Statuses</option>
                        <option>Pending</option><option>Partial</option><option>Paid</option>
                    </select>
                    <select id="expFilterMonth" onchange="filterExpenses()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">All Months</option>
                        ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
                            .map((m,i) => `<option value="${String(i+1).padStart(2,'0')}">${m}</option>`).join('')}
                    </select>
                </div>

                <!-- Summary cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    ${expSummaryCards(expenses)}
                </div>

                <!-- Table -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden" id="expTableContainer">
                    ${renderExpenseTable(expenses)}
                </div>
            `;
        }

        function expSummaryCards(list) {
            const total   = list.reduce((s,e) => s + (parseFloat(e.billAmtINR)||0), 0);
            const paid    = list.filter(e => e.payStatus === 'Paid').reduce((s,e) => s + (parseFloat(e.billAmtINR)||0), 0);
            const pending = list.filter(e => e.payStatus === 'Pending').reduce((s,e) => s + (parseFloat(e.netPayable)||0), 0);
            const tds     = list.reduce((s,e) => s + (parseFloat(e.tdsAmt)||0), 0);
            const fmt = n => 'â‚¹' + n.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
            return [
                {label:'Total Bills (INR)', val:fmt(total), color:'bg-orange-600'},
                {label:'Paid Amount',       val:fmt(paid),  color:'bg-green-600'},
                {label:'Pending Payment',   val:fmt(pending),color:'bg-red-600'},
                {label:'TDS Deducted',      val:fmt(tds),   color:'bg-yellow-600'},
            ].map(c => `<div class="${c.color} text-white rounded-xl p-4 shadow">
                <div class="text-xs opacity-80 mb-1">${c.label}</div>
                <div class="text-lg font-bold">${c.val}</div>
            </div>`).join('');
        }

        function renderExpenseTable(list) {
            if (!list || list.length === 0)
                return '<p class="text-gray-400 text-center py-12">No expenses yet. Add your first bill!</p>';
            return `<div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-orange-50 text-xs text-gray-500 uppercase">
                        <tr>
                            <th class="px-3 py-2 text-left">Voucher</th>
                            <th class="px-3 py-2 text-left">Bill No</th>
                            <th class="px-3 py-2 text-left">Date</th>
                            <th class="px-3 py-2 text-left">Vendor</th>
                            <th class="px-3 py-2 text-left">Description</th>
                            <th class="px-3 py-2 text-right">Bill Amt (INR)</th>
                            <th class="px-3 py-2 text-right">TDS</th>
                            <th class="px-3 py-2 text-right">Net Payable</th>
                            <th class="px-3 py-2 text-center">Status</th>
                            <th class="px-3 py-2 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${list.map(e => expRow(e)).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        function expRow(e) {
            const statusCls = {Paid:'bg-green-100 text-green-700', Pending:'bg-red-100 text-red-700', Partial:'bg-yellow-100 text-yellow-700'}[e.payStatus] || 'bg-gray-100';
            const fmt = n => n ? 'â‚¹'+parseFloat(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) : 'â€”';
            const eJson = JSON.stringify(e).replace(/'/g,"&apos;");
            return `<tr class="border-b hover:bg-orange-50">
                <td class="px-3 py-2 font-medium text-orange-700">${e.voucherNo||'â€”'}</td>
                <td class="px-3 py-2">${e.billNo||'â€”'}</td>
                <td class="px-3 py-2 whitespace-nowrap">${e.billDate||'â€”'}</td>
                <td class="px-3 py-2 max-w-xs truncate" title="${e.companyName}">${e.companyName||'â€”'}</td>
                <td class="px-3 py-2 max-w-xs truncate" title="${e.description}">${e.description||'â€”'}</td>
                <td class="px-3 py-2 text-right">${fmt(e.billAmtINR)}</td>
                <td class="px-3 py-2 text-right text-yellow-700">${fmt(e.tdsAmt)}</td>
                <td class="px-3 py-2 text-right font-semibold">${fmt(e.netPayable)}</td>
                <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full text-xs ${statusCls}">${e.payStatus}</span></td>
                <td class="px-3 py-2 text-right whitespace-nowrap">
                    ${e.billPhotoData ? `<button onclick='viewExpPhoto("${e.expID}")' class="text-blue-500 hover:text-blue-700 mr-1 text-xs" title="View Bill">ðŸ“·</button>` : ''}
                    <button onclick='editExpense(${eJson})' class="text-indigo-600 hover:text-indigo-800 mr-1 text-xs font-medium">Edit</button>
                    <button onclick="deleteExpense('${e.expID}')" class="text-red-600 hover:text-red-800 text-xs">Del</button>
                </td>
            </tr>`;
        }

        function filterExpenses() {
            const q   = (document.getElementById('expSearchInput')?.value||'').toLowerCase();
            const st  = document.getElementById('expFilterStatus')?.value||'';
            const mo  = document.getElementById('expFilterMonth')?.value||'';
            const filtered = expenses.filter(e => {
                const mq = !q || (e.billNo||'').toLowerCase().includes(q) ||
                           (e.companyName||'').toLowerCase().includes(q) ||
                           (e.description||'').toLowerCase().includes(q) ||
                           (e.voucherNo||'').toLowerCase().includes(q);
                const ms = !st || e.payStatus === st;
                const mm = !mo || (e.billDate||'').substring(5,7) === mo;
                return mq && ms && mm;
            });
            const c = document.getElementById('expTableContainer');
            if (c) c.innerHTML = renderExpenseTable(filtered);
        }

        // â”€â”€ Expense Modal Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentExpense = null;

        function openExpenseModal(exp = null) {
            currentExpense = exp;
            document.getElementById('expenseModalTitle').textContent = exp ? 'Edit Expense / Bill' : 'New Expense / Bill';
            const form = document.getElementById('expenseForm');
            form.reset();
            document.getElementById('expPhotoPreview').classList.add('hidden');
            document.getElementById('expTDSFields').classList.add('hidden');

            // Populate bank account dropdown (expense accounts only)
            const bankSelect = document.getElementById('expBankAccount');
            bankSelect.innerHTML = '<option value="">-- Select Account --</option>' +
                bankAccounts.filter(ba => ba.isActive && (ba.type === 'Expense' || ba.type === 'Both'))
                .map(ba => `<option value="${ba.id}">${ba.accountName} (${ba.currency})</option>`).join('');

            // Auto-generate voucher number
            if (!exp) {
                const fyCode = getFinancialYearCode(new Date());
                const count  = expenses.filter(e => (e.voucherNo||'').includes(fyCode)).length + 1;
                document.getElementById('expVoucherNo').value = 'VCH' + fyCode + String(count).padStart(3,'0');
                document.getElementById('expBillDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('expExchRate').value = '1';
            } else {
                document.getElementById('expVoucherNo').value     = exp.voucherNo||'';
                document.getElementById('expBillNo').value        = exp.billNo||'';
                document.getElementById('expBillDate').value      = exp.billDate||'';
                document.getElementById('expCompanyName').value   = exp.companyName||'';
                document.getElementById('expDescription').value   = exp.description||'';
                document.getElementById('expCurrency').value      = exp.currency||'INR';
                document.getElementById('expExchRate').value      = exp.exchRate||'1';
                document.getElementById('expBillAmount').value    = exp.billAmount||'';
                document.getElementById('expBillAmtINR').value    = exp.billAmtINR||'';
                document.getElementById('expCGST').value          = exp.cgst||'';
                document.getElementById('expSGST').value          = exp.sgst||'';
                document.getElementById('expIGST').value          = exp.igst||'';
                document.getElementById('expCreditNote').value    = exp.creditNote||'';
                document.getElementById('expCreditNoteDetails').value = exp.creditNoteDetails||'';
                document.getElementById('expTDSApplicable').checked   = exp.tdsApplicable||false;
                if (exp.tdsApplicable) {
                    document.getElementById('expTDSFields').classList.remove('hidden');
                    document.getElementById('expTaxableAmt').value = exp.taxableAmt||'';
                    document.getElementById('expTDSPct').value     = exp.tdsPct||'2';
                    document.getElementById('expTDSAmt').value     = exp.tdsAmt||'';
                    document.getElementById('expNetAmt').value     = exp.netAmt||'';
                }
                document.getElementById('expAdvanceAmt').value    = exp.advanceAmt||'';
                document.getElementById('expAdvanceDate').value   = exp.advanceDate||'';
                document.getElementById('expBalanceAmt').value    = exp.balanceAmt||'';
                document.getElementById('expPayStatus').value     = exp.payStatus||'Pending';
                document.getElementById('expPayMode').value       = exp.payMode||'';
                document.getElementById('expChequeNo').value      = exp.chequeNo||'';
                document.getElementById('expPayDate').value       = exp.payDate||'';
                document.getElementById('expBankName').value      = exp.bankName||'';
                document.getElementById('expRemark').value        = exp.remark||'';
                if (exp.billPhotoData) {
                    document.getElementById('expPhotoImg').src = exp.billPhotoData;
                    document.getElementById('expPhotoName').textContent = exp.billPhotoName||'';
                    document.getElementById('expPhotoPreview').classList.remove('hidden');
                }
                calcExpAmounts();
            }
            toggleChequeFields();
            document.getElementById('expenseModal').classList.add('show');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('show');
            currentExpense = null;
        }

        function calcExpAmounts() {
            const bill    = parseFloat(document.getElementById('expBillAmount')?.value)||0;
            const rate    = parseFloat(document.getElementById('expExchRate')?.value)||1;
            const cgst    = parseFloat(document.getElementById('expCGST')?.value)||0;
            const sgst    = parseFloat(document.getElementById('expSGST')?.value)||0;
            const igst    = parseFloat(document.getElementById('expIGST')?.value)||0;
            const cn      = parseFloat(document.getElementById('expCreditNote')?.value)||0;
            const adv     = parseFloat(document.getElementById('expAdvanceAmt')?.value)||0;
            const billINR = bill * rate;
            const totalTax = cgst + sgst + igst;
            const billAmtINREl = document.getElementById('expBillAmtINR');
            if (billAmtINREl) billAmtINREl.value = billINR.toFixed(2);

            // TDS
            let tdsAmt = 0, netAmt = billINR;
            const tdsOn = document.getElementById('expTDSApplicable')?.checked;
            if (tdsOn) {
                const taxableRaw = parseFloat(document.getElementById('expTaxableAmt')?.value)||0;
                const taxable = taxableRaw || billINR;
                if (!taxableRaw) document.getElementById('expTaxableAmt').value = taxable.toFixed(2);
                const tdsPct  = parseFloat(document.getElementById('expTDSPct')?.value)||2;
                tdsAmt = (taxable * tdsPct / 100);
                netAmt = billINR - tdsAmt;
                const tdsEl = document.getElementById('expTDSAmt');
                const netEl = document.getElementById('expNetAmt');
                if (tdsEl) tdsEl.value = tdsAmt.toFixed(2);
                if (netEl) netEl.value = netAmt.toFixed(2);
            }

            // Balance
            const netPayable = netAmt + totalTax - cn;
            const balance    = Math.max(0, netPayable - adv);
            const balEl = document.getElementById('expBalanceAmt');
            if (balEl) balEl.value = balance.toFixed(2);

            // Summary cards
            const fmt = n => 'â‚¹'+n.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
            const s1 = document.getElementById('sumBillINR');
            const s2 = document.getElementById('sumTax');
            const s3 = document.getElementById('sumTDS');
            const s4 = document.getElementById('sumNet');
            if (s1) s1.textContent = fmt(billINR);
            if (s2) s2.textContent = fmt(totalTax);
            if (s3) s3.textContent = fmt(tdsAmt);
            if (s4) s4.textContent = fmt(netPayable);
        }

        function toggleChequeFields() {
            const mode = document.getElementById('expPayMode')?.value||'';
            const el   = document.getElementById('chequeNoField');
            if (el) el.classList.toggle('hidden', mode !== 'Cheque');
        }

        document.getElementById('expTDSApplicable')?.addEventListener('change', function() {
            document.getElementById('expTDSFields').classList.toggle('hidden', !this.checked);
            calcExpAmounts();
        });

        async function saveExpense(e) {
            e.preventDefault();
            const tdsOn = document.getElementById('expTDSApplicable').checked;
            const bill  = parseFloat(document.getElementById('expBillAmount').value)||0;
            const rate  = parseFloat(document.getElementById('expExchRate').value)||1;
            const cgst  = parseFloat(document.getElementById('expCGST').value)||0;
            const sgst  = parseFloat(document.getElementById('expSGST').value)||0;
            const igst  = parseFloat(document.getElementById('expIGST').value)||0;
            const cn    = parseFloat(document.getElementById('expCreditNote').value)||0;
            const adv   = parseFloat(document.getElementById('expAdvanceAmt').value)||0;
            const billINR = bill * rate;
            const tdsAmt  = tdsOn ? (parseFloat(document.getElementById('expTDSAmt').value)||0) : 0;
            const netAmt  = billINR - tdsAmt;
            const netPayable = netAmt + cgst + sgst + igst - cn;
            const balance    = Math.max(0, netPayable - adv);

            // Handle bill photo
            let photoData = currentExpense?.billPhotoData || null;
            let photoName = currentExpense?.billPhotoName || null;
            const photoFile = document.getElementById('expBillPhoto').files[0];
            if (photoFile) {
                if (photoFile.size > 2 * 1024 * 1024) { alert('File too large. Max 2MB.'); return; }
                photoData = await new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = () => rej(new Error('Read failed'));
                    r.readAsDataURL(photoFile);
                });
                photoName = photoFile.name;
            }

            const expObj = {
                expID:             currentExpense?.expID || 'EXP' + getFinancialYearCode(new Date()) + String(expenses.length+1).padStart(3,'0'),
                voucherNo:         document.getElementById('expVoucherNo').value,
                billNo:            document.getElementById('expBillNo').value,
                billDate:          document.getElementById('expBillDate').value,
                companyName:       document.getElementById('expCompanyName').value,
                description:       document.getElementById('expDescription').value,
                currency:          document.getElementById('expCurrency').value,
                exchRate:          rate,
                billAmount:        bill,
                billAmtINR:        billINR,
                cgst, sgst, igst,
                creditNote:        cn,
                creditNoteDetails: document.getElementById('expCreditNoteDetails').value,
                tdsApplicable:     tdsOn,
                taxableAmt:        tdsOn ? (parseFloat(document.getElementById('expTaxableAmt').value)||0) : 0,
                tdsPct:            tdsOn ? document.getElementById('expTDSPct').value : 0,
                tdsAmt,
                netAmt,
                netPayable,
                advanceAmt:        adv,
                advanceDate:       document.getElementById('expAdvanceDate').value,
                balanceAmt:        balance,
                payStatus:         document.getElementById('expPayStatus').value,
                payMode:           document.getElementById('expPayMode').value,
                chequeNo:          document.getElementById('expChequeNo').value,
                payDate:           document.getElementById('expPayDate').value,
                bankAccountId:     document.getElementById('expBankAccount').value,
                bankName:          (() => { const ba = bankAccounts.find(b => b.id === document.getElementById('expBankAccount').value); return ba ? ba.accountName : ''; })(),
                remark:            document.getElementById('expRemark').value,
                billPhotoData:     photoData,
                billPhotoName:     photoName,
                createdAt:         currentExpense?.createdAt || new Date().toISOString()
            };

            if (currentExpense) {
                const idx = expenses.findIndex(x => x.expID === currentExpense.expID);
                if (idx >= 0) expenses[idx] = expObj;
            } else {
                expenses.push(expObj);
            }
            await saveData('expenses', expenses);
            closeExpenseModal();
            renderView();
        }

        function editExpense(exp) { openExpenseModal(exp); }

        async function deleteExpense(expID) {
            if (!confirm('Delete this expense record?')) return;
            expenses = expenses.filter(x => x.expID !== expID);
            await saveData('expenses', expenses);
            renderView();
        }

        function viewExpPhoto(expID) {
            const exp = expenses.find(x => x.expID === expID);
            if (!exp?.billPhotoData) return;
            const w = window.open();
            w.document.write(`<html><body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh">
                <img src="${exp.billPhotoData}" style="max-width:100%;max-height:100vh;object-fit:contain"/>
            </body></html>`);
        }

        // Handle bill photo preview
        document.getElementById('expBillPhoto')?.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('expPhotoImg').src = e.target.result;
                    document.getElementById('expPhotoName').textContent = file.name;
                    document.getElementById('expPhotoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('expPhotoImg').src = '';
                document.getElementById('expPhotoName').textContent = file.name + ' (PDF)';
                document.getElementById('expPhotoPreview').classList.remove('hidden');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  MIS REPORT MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function renderMIS(content) {
            const fy = getFinancialYearCode(new Date());
            const fyLabel = '20' + fy.slice(0,2) + 'â€“' + '20' + fy.slice(2);

            // Revenue: Approved/Completed/Paid outgoing invoices
            const revTxns   = transactions.filter(t => t.txnCategory === 'INVOICE' && t.txnDirection === 'Outgoing' && ['Approved','Sent','Completed','Paid'].includes(t.status));
            const revenue   = revTxns.reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.total); }, 0);
            
            // Proforma Pipeline: pending proformas not yet converted
            const proformaPipeline = transactions.filter(t => t.txnCategory === 'PROFORMA_INVOICE' && !t.convertedToInvoice)
                .reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.total); }, 0);
            const revTax    = revTxns.reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.tax); }, 0);

            // Expenses
            const totalExp  = expenses.reduce((s,e) => s + (parseFloat(e.billAmtINR)||0), 0);
            const expTax    = expenses.reduce((s,e) => s + (parseFloat(e.cgst)||0) + (parseFloat(e.sgst)||0) + (parseFloat(e.igst)||0), 0);
            const tdsTotal  = expenses.reduce((s,e) => s + (parseFloat(e.tdsAmt)||0), 0);
            const pendingPay= expenses.filter(e => e.payStatus !== 'Paid').reduce((s,e) => s + (parseFloat(e.balanceAmt)||0), 0);
            const paidExp   = expenses.filter(e => e.payStatus === 'Paid').reduce((s,e) => s + (parseFloat(e.billAmtINR)||0), 0);

            // PO commitments
            const poTxns    = transactions.filter(t => t.txnCategory === 'PO' && t.txnDirection === 'Incoming');
            const poValue   = poTxns.reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.total); }, 0);

            // Receivables: invoices not yet Paid
            const receivable = transactions.filter(t => t.txnCategory === 'INVOICE' && t.txnDirection === 'Outgoing' && ['Approved','Sent'].includes(t.status))
                .reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.total); }, 0);

            // Quotations pipeline
            const quotesPipeline = transactions.filter(t => t.txnCategory === 'QUOTATION' && t.txnDirection === 'Outgoing' && t.status !== 'Draft')
                .reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s + parseFloat(tot.total); }, 0);

            const grossProfit  = revenue - totalExp;
            const profitMargin = revenue > 0 ? ((grossProfit / revenue) * 100).toFixed(1) : 0;

            const fmt  = n => 'â‚¹' + n.toLocaleString('en-IN', {minimumFractionDigits:2,maximumFractionDigits:2});
            const fmtK = n => n >= 100000 ? 'â‚¹' + (n/100000).toFixed(2) + 'L' : n >= 1000 ? 'â‚¹' + (n/1000).toFixed(1) + 'K' : fmt(n);

            // Month-wise data (last 6 months)
            const monthlyData = buildMonthlyData();

            // Expense breakdown by vendor (top 5)
            const vendorMap = {};
            expenses.forEach(e => {
                const v = e.companyName || 'Unknown';
                vendorMap[v] = (vendorMap[v]||0) + (parseFloat(e.billAmtINR)||0);
            });
            const topVendors = Object.entries(vendorMap).sort((a,b) => b[1]-a[1]).slice(0,5);

            // Payment status breakdown
            const payBreak = {Paid:0,Pending:0,Partial:0};
            expenses.forEach(e => { payBreak[e.payStatus] = (payBreak[e.payStatus]||0) + 1; });

            content.innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                    <div>
                        <h2 class="text-3xl font-bold">ðŸ“Š MIS Report</h2>
                        <p class="text-sm text-gray-500">Financial Year ${fyLabel} &nbsp;Â·&nbsp; As of ${new Date().toLocaleDateString('en-IN')}</p>
                    </div>
                    <button onclick="exportMISReport()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-medium">â¬‡ Export MIS PDF</button>
                </div>

                <!-- P&L Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl p-4 shadow">
                        <div class="text-xs opacity-80 mb-1">Total Revenue (Invoiced)</div>
                        <div class="text-xl font-bold">${fmtK(revenue)}</div>
                        <div class="text-xs opacity-70 mt-1">Tax: ${fmtK(revTax)}</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-red-500 text-white rounded-xl p-4 shadow">
                        <div class="text-xs opacity-80 mb-1">Total Expenses</div>
                        <div class="text-xl font-bold">${fmtK(totalExp)}</div>
                        <div class="text-xs opacity-70 mt-1">Tax paid: ${fmtK(expTax)}</div>
                    </div>
                    <div class="bg-gradient-to-br ${grossProfit >= 0 ? 'from-green-500 to-green-700' : 'from-red-600 to-red-800'} text-white rounded-xl p-4 shadow">
                        <div class="text-xs opacity-80 mb-1">Gross Profit</div>
                        <div class="text-xl font-bold">${fmtK(grossProfit)}</div>
                        <div class="text-xs opacity-70 mt-1">Margin: ${profitMargin}%</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl p-4 shadow">
                        <div class="text-xs opacity-80 mb-1">Receivables</div>
                        <div class="text-xl font-bold">${fmtK(receivable)}</div>
                        <div class="text-xs opacity-70 mt-1">Pipeline: ${fmtK(quotesPipeline)}</div>
                    </div>
                </div>

                <!-- Secondary KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div class="bg-white rounded-xl p-4 border shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">PO Commitments</div>
                        <div class="text-lg font-bold text-indigo-700">${fmtK(poValue)}</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">TDS Deducted (Expenses)</div>
                        <div class="text-lg font-bold text-yellow-700">${fmt(tdsTotal)}</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">Pending Payments (Bills)</div>
                        <div class="text-lg font-bold text-red-600">${fmt(pendingPay)}</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">Bills Paid</div>
                        <div class="text-lg font-bold text-green-600">${fmtK(paidExp)}</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 border shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">Proforma Pipeline</div>
                        <div class="text-lg font-bold text-orange-600">${fmtK(proformaPipeline)}</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Monthly trend table -->
                    <div class="bg-white rounded-2xl shadow-sm p-4">
                        <h3 class="font-bold text-gray-700 mb-3">Monthly Revenue vs Expenses</h3>
                        <table class="w-full text-sm">
                            <thead class="text-xs text-gray-500 uppercase border-b">
                                <tr><th class="py-1 text-left">Month</th><th class="py-1 text-right">Revenue</th><th class="py-1 text-right">Expenses</th><th class="py-1 text-right">Profit</th></tr>
                            </thead>
                            <tbody>
                                ${monthlyData.map(m => `<tr class="border-b hover:bg-gray-50">
                                    <td class="py-1.5 text-gray-700">${m.label}</td>
                                    <td class="py-1.5 text-right text-blue-600">${fmtK(m.rev)}</td>
                                    <td class="py-1.5 text-right text-orange-600">${fmtK(m.exp)}</td>
                                    <td class="py-1.5 text-right font-semibold ${m.rev-m.exp>=0?'text-green-600':'text-red-600'}">${fmtK(m.rev-m.exp)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Top vendors + payment status -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm p-4">
                            <h3 class="font-bold text-gray-700 mb-3">Top Vendors by Expense</h3>
                            ${topVendors.length === 0 ? '<p class="text-gray-400 text-sm">No expenses yet</p>' :
                              topVendors.map(([v,a]) => `<div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-700 truncate max-w-xs">${v}</span>
                                <span class="text-sm font-semibold text-orange-700">${fmtK(a)}</span>
                              </div>`).join('')}
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm p-4">
                            <h3 class="font-bold text-gray-700 mb-3">Bill Payment Status</h3>
                            <div class="flex gap-4">
                                <div class="text-center"><div class="text-2xl font-bold text-green-600">${payBreak.Paid||0}</div><div class="text-xs text-gray-500">Paid</div></div>
                                <div class="text-center"><div class="text-2xl font-bold text-red-600">${payBreak.Pending||0}</div><div class="text-xs text-gray-500">Pending</div></div>
                                <div class="text-center"><div class="text-2xl font-bold text-yellow-600">${payBreak.Partial||0}</div><div class="text-xs text-gray-500">Partial</div></div>
                                <div class="text-center"><div class="text-2xl font-bold text-gray-700">${expenses.length}</div><div class="text-xs text-gray-500">Total Bills</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Outstanding invoices table -->
                <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
                    <h3 class="font-bold text-gray-700 mb-3">Outstanding Receivables (Unpaid Invoices)</h3>
                    ${(() => {
                        const outstanding = transactions.filter(t => t.txnCategory==='INVOICE' && t.txnDirection==='Outgoing' && ['Approved','Sent'].includes(t.status));
                        if (outstanding.length === 0) return '<p class="text-gray-400 text-sm">No outstanding invoices.</p>';
                        return '<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-500 uppercase border-b"><tr><th class="py-1 text-left">Invoice</th><th class="py-1 text-left">Party</th><th class="py-1 text-left">Date</th><th class="py-1 text-right">Amount</th><th class="py-1 text-center">Status</th></tr></thead><tbody>' +
                            outstanding.map(t => { const tot = calculateTotals(t.items||[]); return `<tr class="border-b"><td class="py-1.5 font-medium text-indigo-700">${t.txnID}</td><td class="py-1.5">${t.partyName}</td><td class="py-1.5">${t.txnDate}</td><td class="py-1.5 text-right font-semibold">${fmt(parseFloat(tot.total))}</td><td class="py-1.5 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-700">${t.status}</span></td></tr>`; }).join('') +
                        '</tbody></table></div>';
                    })()}
                </div>

                <!-- Expense detail table -->
                <div class="bg-white rounded-2xl shadow-sm p-4">
                    <h3 class="font-bold text-gray-700 mb-3">All Expenses Summary</h3>
                    ${renderExpenseTable(expenses)}
                </div>
            `;
        }

        function buildMonthlyData() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d   = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const yr  = d.getFullYear();
                const mo  = String(d.getMonth()+1).padStart(2,'0');
                const lbl = d.toLocaleDateString('en-IN', {month:'short', year:'2-digit'});
                const prefix = yr + '-' + mo;

                const rev = transactions
                    .filter(t => t.txnCategory==='INVOICE' && t.txnDirection==='Outgoing' && (t.txnDate||'').startsWith(prefix) && ['Approved','Sent','Completed','Paid'].includes(t.status))
                    .reduce((s,t) => { const tot = calculateTotals(t.items||[]); return s+parseFloat(tot.total); }, 0);

                const exp = expenses
                    .filter(e => (e.billDate||'').startsWith(prefix))
                    .reduce((s,e) => s+(parseFloat(e.billAmtINR)||0), 0);

                months.push({label:lbl, rev, exp});
            }
            return months;
        }

        async function exportMISReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                const fy  = getFinancialYearCode(new Date());
                const fyLabel = '20'+fy.slice(0,2)+'â€“'+'20'+fy.slice(2);
                const pageW = 297, margin = 14;

                // Header
                doc.setFillColor(25, 40, 110);
                doc.rect(0, 0, pageW, 22, 'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(14); doc.setFont('helvetica','bold');
                doc.text((settings.companyName||'Company').toUpperCase(), pageW/2, 10, {align:'center'});
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.text('MIS REPORT  Â·  FY ' + fyLabel + '  Â·  Generated: ' + new Date().toLocaleDateString('en-IN'), pageW/2, 17, {align:'center'});
                doc.setTextColor(0,0,0);

                let y = 30;
                const revTxns   = transactions.filter(t => t.txnCategory==='INVOICE' && t.txnDirection==='Outgoing' && ['Approved','Sent','Completed','Paid'].includes(t.status));
                const revenue   = revTxns.reduce((s,t) => { const tot=calculateTotals(t.items||[]); return s+parseFloat(tot.total); }, 0);
                const totalExp  = expenses.reduce((s,e) => s+(parseFloat(e.billAmtINR)||0), 0);
                const tdsTotal  = expenses.reduce((s,e) => s+(parseFloat(e.tdsAmt)||0), 0);
                const receivable= transactions.filter(t => t.txnCategory==='INVOICE' && t.txnDirection==='Outgoing' && ['Approved','Sent'].includes(t.status))
                                  .reduce((s,t) => { const tot=calculateTotals(t.items||[]); return s+parseFloat(tot.total); }, 0);
                const grossProfit = revenue - totalExp;
                const fmt = n => 'INR ' + n.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});

                // KPI Summary table
                doc.autoTable({
                    startY: y, margin: {left:margin, right:margin},
                    head: [['Metric','Value']],
                    body: [
                        ['Total Revenue (Invoiced)', fmt(revenue)],
                        ['Total Expenses', fmt(totalExp)],
                        ['Gross Profit', fmt(grossProfit)],
                        ['Profit Margin', revenue > 0 ? ((grossProfit/revenue)*100).toFixed(1)+'%' : '0%'],
                        ['Outstanding Receivables', fmt(receivable)],
                        ['TDS Deducted', fmt(tdsTotal)],
                        ['Total Bills', String(expenses.length)],
                    ],
                    styles: {fontSize:9},
                    headStyles: {fillColor:[25,40,110], textColor:255},
                    alternateRowStyles: {fillColor:[245,247,255]},
                    columnStyles: {1: {halign:'right', fontStyle:'bold'}},
                    tableWidth: 100,
                });

                // Monthly table
                const monthly = buildMonthlyData();
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    margin: {left: margin},
                    head: [['Month','Revenue','Expenses','Profit']],
                    body: monthly.map(m => [m.label, fmt(m.rev), fmt(m.exp), fmt(m.rev-m.exp)]),
                    styles: {fontSize:8},
                    headStyles: {fillColor:[79,70,229], textColor:255},
                    tableWidth: 130,
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 3) {
                            const val = monthly[data.row.index]?.rev - monthly[data.row.index]?.exp;
                            data.cell.styles.textColor = val >= 0 ? [0,128,0] : [200,0,0];
                        }
                    }
                });

                // Expenses detail on next page
                if (expenses.length > 0) {
                    doc.addPage();
                    doc.setFillColor(220, 90, 30);
                    doc.rect(0,0,pageW,14,'F');
                    doc.setTextColor(255,255,255); doc.setFontSize(11); doc.setFont('helvetica','bold');
                    doc.text('EXPENSES & BILLS DETAIL', margin, 10);
                    doc.setTextColor(0,0,0);

                    doc.autoTable({
                        startY: 20, margin:{left:margin,right:margin},
                        head: [['Voucher','Bill No','Date','Vendor','Description','Bill Amt INR','CGST','SGST','IGST','TDS','Net Payable','Status','Pay Mode']],
                        body: expenses.map(e => [
                            e.voucherNo||'', e.billNo||'', e.billDate||'', e.companyName||'', e.description||'',
                            parseFloat(e.billAmtINR||0).toFixed(2),
                            parseFloat(e.cgst||0).toFixed(2), parseFloat(e.sgst||0).toFixed(2), parseFloat(e.igst||0).toFixed(2),
                            parseFloat(e.tdsAmt||0).toFixed(2), parseFloat(e.netPayable||0).toFixed(2),
                            e.payStatus||'', e.payMode||''
                        ]),
                        styles: {fontSize:7},
                        headStyles: {fillColor:[220,90,30], textColor:255},
                        alternateRowStyles: {fillColor:[255,245,235]},
                    });
                }

                doc.save('MIS_Report_FY' + fy + '_' + (settings.companyName||'IMSE').replace(/\s+/g,'_') + '.pdf');
            } catch(err) {
                console.error('MIS PDF error:', err);
                alert('Error generating MIS PDF: ' + err.message);
            }
        }

        function renderParties(content) {
            content.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold">Parties</h2>
                    <button onclick="openPartyModal()" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700">+ New Party</button>
                </div>
                <!-- Search -->
                <div class="bg-white rounded-xl shadow-sm p-3 mb-4 flex gap-3">
                    <div class="flex-1 relative">
                        <svg class="absolute left-3 top-2.5 text-gray-400" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        <input type="text" id="partySearchInput" placeholder="Search by name, GST, contact..."
                               class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-300"
                               oninput="filterParties()"/>
                    </div>
                    <select id="partyFilterType" onchange="filterParties()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">All Types</option>
                        <option>Client</option>
                        <option>Sub-Contractor</option>
                    </select>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden" id="partiesTableContainer">
                    ${renderPartiesTable(parties)}
                </div>
            `;
        }

        function renderPartiesTable(list) {
            if (!list || list.length === 0)
                return '<p class="text-gray-500 text-center py-12">No parties found. Click "+ New Party" to add your first client or sub-contractor.</p>';
            
            return `<div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-purple-50 text-xs text-gray-600 uppercase">
                        <tr>
                            <th class="px-4 py-3 text-left">Party Name</th>
                            <th class="px-4 py-3 text-center">Type</th>
                            <th class="px-4 py-3 text-left">Contact Person</th>
                            <th class="px-4 py-3 text-left">Email</th>
                            <th class="px-4 py-3 text-left">Mobile</th>
                            <th class="px-4 py-3 text-left">GST Number</th>
                            <th class="px-4 py-3 text-left">PAN Number</th>
                            <th class="px-4 py-3 text-left">Address</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${list.map(p => renderPartyRow(p)).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        function renderPartyRow(p) {
            const typeClass = p.partyType === 'Client' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700';
            const pJson = JSON.stringify(p).replace(/'/g, "&apos;");
            return `<tr class="border-b hover:bg-purple-50">
                <td class="px-4 py-3">
                    <div class="font-semibold text-gray-800">${p.partyName || 'â€”'}</div>
                    ${p.partyID ? `<div class="text-xs text-gray-400">${p.partyID}</div>` : ''}
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">${p.partyType || 'â€”'}</span>
                </td>
                <td class="px-4 py-3 text-gray-700">${p.contactPerson || 'â€”'}</td>
                <td class="px-4 py-3">
                    ${p.email ? `<a href="mailto:${p.email}" class="text-purple-600 hover:text-purple-800">${p.email}</a>` : 'â€”'}
                </td>
                <td class="px-4 py-3 text-gray-700">${p.mobile || 'â€”'}</td>
                <td class="px-4 py-3">
                    <span class="text-xs font-mono text-gray-600">${p.gstNumber || 'â€”'}</span>
                </td>
                <td class="px-4 py-3">
                    <span class="text-xs font-mono text-gray-600">${p.panNumber || 'â€”'}</span>
                </td>
                <td class="px-4 py-3">
                    <div class="max-w-xs truncate text-gray-600" title="${p.address || ''}">${p.address || 'â€”'}</div>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                    <button onclick='editParty(${pJson})' class="text-purple-600 hover:text-purple-800 mr-2 text-xs font-medium">Edit</button>
                    <button onclick="deleteParty('${p.partyID}')" class="text-red-600 hover:text-red-800 text-xs font-medium">Del</button>
                </td>
            </tr>`;
        }

        function filterParties() {
            const q    = (document.getElementById('partySearchInput')?.value || '').toLowerCase();
            const type = document.getElementById('partyFilterType')?.value || '';
            const filtered = parties.filter(p => {
                const matchQ = !q ||
                    (p.partyName||'').toLowerCase().includes(q) ||
                    (p.gstNumber||'').toLowerCase().includes(q) ||
                    (p.contactPerson||'').toLowerCase().includes(q) ||
                    (p.email||'').toLowerCase().includes(q) ||
                    (p.mobile||'').toLowerCase().includes(q) ||
                    (p.panNumber||'').toLowerCase().includes(q);
                const matchT = !type || p.partyType === type;
                return matchQ && matchT;
            });
            const container = document.getElementById('partiesTableContainer');
            if (container) container.innerHTML = renderPartiesTable(filtered);
        }




        // â”€â”€ Settings Password Protection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderSettingsPasswordPrompt(content) {
            content.innerHTML = `
                <div class="min-h-[60vh] flex items-center justify-center">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <svg width="32" height="32" fill="none" stroke="#4f46e5" stroke-width="2" viewBox="0 0 24 24">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Settings Access</h2>
                            <p class="text-gray-500 text-sm mt-2">Enter password to view and edit settings</p>
                        </div>
                        
                        <form onsubmit="unlockSettings(event)" id="settingsPasswordForm">
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                <input type="password" id="settingsPassword" 
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-center text-xl tracking-wider focus:outline-none focus:border-indigo-400"
                                       placeholder="Enter password" 
                                       autofocus required />
                                <p id="settingsPasswordError" class="text-red-600 text-xs mt-2 hidden">Incorrect password. Try again.</p>
                                <p class="text-xs text-gray-400 mt-2">
                                    ${settings.settingsPassword 
                                        ? 'Password is set in your settings' 
                                        : 'Default password: <strong class="text-gray-700">admin</strong> (change after first login)'}
                                </p>
                            </div>
                            
                            <button type="submit" 
                                    class="w-full px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-semibold transition">
                                ðŸ”“ Unlock Settings
                            </button>
                        </form>
                        
                        <button onclick="switchView('dashboard')" 
                                class="w-full mt-3 px-6 py-2 border border-gray-300 text-gray-600 rounded-xl hover:bg-gray-50">
                            â† Back to Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-focus password field
            setTimeout(() => document.getElementById('settingsPassword')?.focus(), 100);
        }

        function unlockSettings(e) {
            e.preventDefault();
            const entered = document.getElementById('settingsPassword')?.value || '';
            const correct = settings.settingsPassword || 'admin';  // Default password: "admin"
            
            if (entered === correct) {
                settingsUnlocked = true;
                renderView();  // Re-render to show actual settings
            } else {
                // Show error
                const errorEl = document.getElementById('settingsPasswordError');
                if (errorEl) {
                    errorEl.classList.remove('hidden');
                    document.getElementById('settingsPassword').value = '';
                    document.getElementById('settingsPassword').focus();
                }
            }
        }

        function renderSettings(content) {
            // Check if settings are unlocked
            if (!settingsUnlocked) {
                renderSettingsPasswordPrompt(content);
                return;
            }

            // Settings are unlocked - show full settings page
            content.innerHTML = `
                <h2 class="text-3xl font-bold mb-6">Settings</h2>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Company Information</h3>
                    <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Company Name</label>
                            <input type="text" id="companyName" value="${settings.companyName || ''}" class="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">GST Number</label>
                            <input type="text" id="companyGST" value="${settings.gstNumber || ''}" class="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">MSME Registration Number</label>
                            <input type="text" id="msmeNumber" value="${settings.msmeNumber || ''}" placeholder="e.g. UDYAM-MH-00-0000000" class="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold mb-2">Company Address</label>
                            <textarea id="companyAddress" rows="3" class="w-full px-4 py-2 border rounded-lg">${settings.companyAddress || ''}</textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold mb-2">Company Logo</label>
                            <div class="flex items-center gap-4">
                                <img src="${settings.logoData || DEFAULT_LOGO}" alt="Logo" class="h-16 w-auto border rounded-lg object-contain bg-gray-50 p-1"/>
                                <div>
                                    <input type="file" id="logoFileInput" accept="image/png,image/jpeg,image/svg+xml" class="hidden" onchange="handleLogoUpload(event)"/>
                                    <button type="button" onclick="document.getElementById('logoFileInput').click()" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm font-medium">
                                        ${settings.logoData ? 'Change Logo' : 'Replace Default Logo'}
                                    </button>
                                    ${settings.logoData ? '<button type="button" onclick="removeLogo()" class="ml-2 px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Restore Default</button>' : ''}
                                    <p class="text-xs text-gray-400 mt-1">PNG, JPG, SVG â€” Max 1 MB. Shown in app header and all PDFs.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">ðŸ¦ Bank Accounts</h3>
                                <button type="button" onclick="openBankAccountModal()" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ Add Account</button>
                            </div>
                            <div id="bankAccountsList" class="space-y-2">
                                ${renderBankAccountsList()}
                            </div>
                        </div>
                        
                        <!-- Settings Password Section -->
                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-lg font-bold text-indigo-700">ðŸ” Settings Password</h3>
                                    ${settings.settingsPassword && settings.settingsPassword !== 'admin'
                                        ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium">Custom Password Set âœ“</span>'
                                        : '<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-medium">Using Default: admin</span>'
                                    }
                                </div>
                                <button type="button" onclick="toggleSettingsPasswordSection()"
                                        id="settingsPasswordToggleBtn"
                                        class="px-3 py-1.5 text-sm border border-indigo-300 text-indigo-600 rounded-lg hover:bg-indigo-50 font-medium">
                                    ðŸ”‘ Change Password
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Password required to access Settings page. Prevents unauthorized changes.</p>
                            
                            <!-- Password fields â€” hidden by default -->
                            <div id="settingsPasswordSection" class="hidden">
                                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">New Password <span class="text-gray-400 font-normal">(min 4 characters)</span></label>
                                        <input type="password" id="settingsPasswordNew" minlength="4"
                                               placeholder="Enter new password..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">Confirm New Password</label>
                                        <input type="password" id="settingsPasswordConfirm" minlength="4"
                                               placeholder="Re-enter password..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
                                    </div>
                                    <div class="md:col-span-2 flex gap-2 justify-end">
                                        <button type="button" onclick="toggleSettingsPasswordSection()" class="px-4 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-lg font-bold text-red-700">ðŸ”’ Admin Security</h3>
                                    ${settings.adminPin
                                        ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium">PIN is set âœ“</span>'
                                        : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full">No PIN set</span>'
                                    }
                                </div>
                                <button type="button" onclick="toggleAdminPinSection()"
                                        id="adminPinToggleBtn"
                                        class="px-3 py-1.5 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50 font-medium">
                                    ${settings.adminPin ? 'ðŸ”‘ Change PIN' : 'ï¼‹ Set PIN'}
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">PIN is required to delete Paid POs or Completed Invoices.</p>
                        </div>

                        <!-- PIN fields â€” hidden by default, revealed on button click -->
                        <div id="adminPinSection" class="md:col-span-2 hidden">
                            <div class="bg-red-50 border border-red-200 rounded-xl p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">New PIN <span class="text-gray-400 font-normal">(4â€“8 digits)</span></label>
                                    <input type="password" id="adminPin" maxlength="8"
                                           placeholder="Enter new PIN..." class="w-full px-4 py-2 border rounded-lg tracking-widest text-center text-xl focus:outline-none focus:ring-2 focus:ring-red-300" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Confirm New PIN</label>
                                    <input type="password" id="adminPinConfirm" maxlength="8"
                                           placeholder="Confirm PIN..." class="w-full px-4 py-2 border rounded-lg tracking-widest text-center text-xl focus:outline-none focus:ring-2 focus:ring-red-300" />
                                </div>
                                <div class="md:col-span-2 flex gap-2 items-center">
                                    <p class="text-xs text-gray-500 flex-1">Save Settings below to apply the new PIN. The fields will close automatically after saving.</p>
                                    <button type="button" onclick="toggleAdminPinSection()" class="text-xs text-gray-500 hover:text-gray-700 underline">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Settings</button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Modal Functions
        // â”€â”€ Supporting Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // Show/hide the supporting docs section based on category + status
        function toggleSupportingDocs() {
            const cat    = document.getElementById('txnCategory')?.value || '';
            const status = document.getElementById('txnStatus')?.value   || '';
            const section = document.getElementById('supportingDocsSection');
            const badge   = document.getElementById('docEligibilityBadge');
            if (!section) return;

            const eligible =
                (cat === 'INVOICE' || cat === 'PO') &&
                (status === 'Approved' || status === 'Sent' || status === 'Completed' || status === 'Paid');

            if (eligible) {
                section.classList.remove('hidden');
                badge.textContent = cat === 'INVOICE' ? 'Invoice Documents' : 'PO Documents';
                // Auto-populate transaction details in attachment window
                const summary = document.getElementById('docTxnSummary');
                if (summary && currentTransaction?.txnID) {
                    document.getElementById('docSummaryID').textContent     = currentTransaction.txnID   || 'â€”';
                    document.getElementById('docSummaryParty').textContent  = currentTransaction.partyName || 'â€”';
                    document.getElementById('docSummaryDate').textContent   = currentTransaction.txnDate  || 'â€”';
                    document.getElementById('docSummaryStatus').textContent = currentTransaction.status   || 'â€”';
                    summary.classList.remove('hidden');
                }
                renderAttachedDocsList();
            } else {
                section.classList.add('hidden');
                document.getElementById('docTxnSummary')?.classList.add('hidden');
            }
        }

        // Render the list of already-attached documents
        function renderAttachedDocsList() {
            const list = document.getElementById('attachedDocsList');
            if (!list) return;
            const docs = currentTransaction?.attachments || [];
            if (docs.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">No documents attached yet.</p>';
                return;
            }
            list.innerHTML = docs.map((doc, idx) => `
                <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 mb-2">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0 ${getDocIconBg(doc.mimeType)}">
                            ${getDocIconSVG(doc.mimeType)}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-800 truncate">${doc.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(doc.size)} &bull; ${doc.uploadedAt}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0 ml-3">
                        <a href="https://drive.google.com/file/d/${doc.fileId}/view" target="_blank"
                           class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium">
                           View
                        </a>
                        <button type="button" onclick="removeAttachment(${idx})"
                                class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getDocIconBg(mime) {
            if (!mime) return 'bg-gray-100';
            if (mime.includes('pdf'))   return 'bg-red-100';
            if (mime.includes('word') || mime.includes('document')) return 'bg-blue-100';
            if (mime.includes('sheet') || mime.includes('excel'))   return 'bg-green-100';
            if (mime.includes('image')) return 'bg-yellow-100';
            return 'bg-gray-100';
        }

        function getDocIconSVG(mime) {
            if (!mime) mime = '';
            if (mime.includes('pdf'))
                return `<svg width="18" height="18" fill="#ef4444" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM8 17h8v1H8zm0-3h8v1H8zm0-3h5v1H8z"/></svg>`;
            if (mime.includes('word') || mime.includes('document'))
                return `<svg width="18" height="18" fill="#2563eb" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM8 17h8v1H8zm0-3h8v1H8zm0-3h8v1H8z"/></svg>`;
            if (mime.includes('sheet') || mime.includes('excel'))
                return `<svg width="18" height="18" fill="#16a34a" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM8 17h8v1H8zm0-3h8v1H8zm0-3h8v1H8z"/></svg>`;
            if (mime.includes('image'))
                return `<svg width="18" height="18" fill="#d97706" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`;
            return `<svg width="18" height="18" fill="#6b7280" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/></svg>`;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Handle drag-drop
        function handleDocDrop(event) {
            event.preventDefault();
            document.getElementById('uploadDropZone').classList.remove('bg-indigo-50');
            const files = Array.from(event.dataTransfer.files);
            uploadDocFiles(files);
        }

        // Handle file input select
        function handleDocFileSelect(event) {
            const files = Array.from(event.target.files);
            uploadDocFiles(files);
            event.target.value = ''; // reset so same file can be re-selected
        }

        // Upload files to Google Drive and attach to current transaction
        async function uploadDocFiles(files) {
            if (!accessToken) { alert('Please sign in first.'); return; }
            if (!files || files.length === 0) return;

            // Validate size
            const oversized = files.filter(f => f.size > 10 * 1024 * 1024);
            if (oversized.length > 0) {
                alert('The following files exceed 10 MB and will be skipped:\n' + oversized.map(f => f.name).join('\n'));
                files = files.filter(f => f.size <= 10 * 1024 * 1024);
            }
            if (files.length === 0) return;

            const progress     = document.getElementById('uploadProgress');
            const progressText = document.getElementById('uploadProgressText');
            const progressBar  = document.getElementById('uploadProgressBar');
            progress.classList.remove('hidden');

            // Ensure we have a subfolder for this transaction
            const txnID = currentTransaction?.txnID ||
                          document.getElementById('txnCategory').value + '_pending';
            const folderName = 'Docs_' + txnID;

            let docFolderId;
            try {
                docFolderId = await getOrCreateSubFolder(folderName);
            } catch (err) {
                alert('Could not create Drive folder: ' + err.message);
                progress.classList.add('hidden');
                return;
            }

            if (!currentTransaction) {
                currentTransaction = {};
            }
            if (!currentTransaction.attachments) currentTransaction.attachments = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                progressText.textContent = `Uploading ${i + 1} of ${files.length}: ${file.name}`;
                progressBar.style.width  = Math.round(((i) / files.length) * 100) + '%';

                try {
                    const fileId = await uploadFileToDriveFolder(file, docFolderId);
                    currentTransaction.attachments.push({
                        fileId:     fileId,
                        name:       file.name,
                        mimeType:   file.type,
                        size:       file.size,
                        uploadedAt: new Date().toLocaleDateString('en-IN')
                    });
                } catch (err) {
                    console.error('Upload failed for', file.name, err);
                    alert('Failed to upload: ' + file.name + '\n' + err.message);
                }
            }

            progressBar.style.width = '100%';
            progressText.textContent = 'Upload complete!';
            setTimeout(() => progress.classList.add('hidden'), 1500);

            renderAttachedDocsList();
        }

        // Create or reuse a named subfolder inside the main app folder
        async function getOrCreateSubFolder(folderName) {
            const parentId = await getOrCreateAppFolder();
            const search = await gapi.client.drive.files.list({
                q: `name='${folderName}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            if (search.result.files.length > 0) return search.result.files[0].id;

            const res = await gapi.client.drive.files.create({
                resource: { name: folderName, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] },
                fields: 'id'
            });
            return res.result.id;
        }

        // Upload a single File object to a specific Drive folder, return file ID
        async function uploadFileToDriveFolder(file, folderId) {
            const metadata = { name: file.name, parents: [folderId] };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method:  'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body:    form
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || response.statusText);
            }
            const data = await response.json();
            return data.id;
        }

        // Remove an attachment (deletes from Drive + removes from list)
        async function removeAttachment(idx) {
            if (!currentTransaction?.attachments) return;
            const doc = currentTransaction.attachments[idx];
            if (!confirm('Remove "' + doc.name + '" from this transaction?')) return;

            // Delete from Drive
            try {
                await fetch('https://www.googleapis.com/drive/v3/files/' + doc.fileId, {
                    method:  'DELETE',
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
            } catch (err) {
                console.warn('Could not delete file from Drive:', err);
            }

            currentTransaction.attachments.splice(idx, 1);
            renderAttachedDocsList();
        }

        // Standalone viewer opened from the transactions list (without opening the edit modal)
        function openAttachmentsViewer(txn) {
            currentTransaction = JSON.parse(JSON.stringify(txn)); // deep clone

            // Populate modal header with read-only info
            document.getElementById('modalTitle').textContent = 'Documents â€” ' + txn.txnID;

            // Pre-fill hidden fields so the modal state is consistent
            document.getElementById('txnCategory').value  = txn.txnCategory;
            document.getElementById('txnStatus').value    = txn.status;
            document.getElementById('lineItems').innerHTML = '';
            document.getElementById('totalSection').classList.add('hidden');

            toggleSupportingDocs();
            document.getElementById('transactionModal').classList.add('show');
        }

        // â”€â”€ END Supporting Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


        function updateTxnBankSection() {
            const cat = document.getElementById('txnCategory')?.value || '';
            const dir = document.getElementById('txnDirection')?.value || '';
            const section = document.getElementById('txnBankSection');
            const select = document.getElementById('txnBankAccount');
            
            if (!section || !select) return;

            // Show bank selection for outgoing Invoices and Proforma Invoices
            const showBank = (cat === 'INVOICE' || cat === 'PROFORMA_INVOICE') && dir === 'Outgoing';
            
            if (showBank) {
                section.classList.remove('hidden');
                // Populate with active income bank accounts
                select.innerHTML = '<option value="">-- Select Income Account --</option>' +
                    bankAccounts.filter(ba => ba.isActive && (ba.type === 'Income' || ba.type === 'Both'))
                    .map(ba => `<option value="${ba.id}">${ba.accountName} (${ba.currency})</option>`).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        function openTransactionModal(txn = null) {
            currentTransaction = txn ? JSON.parse(JSON.stringify(txn)) : null;
            lineItemCounter = 0;
            document.getElementById('modalTitle').textContent = txn ? 'Edit Transaction' : 'New Transaction';
            document.getElementById('lineItems').innerHTML = '';
            document.getElementById('totalSection').classList.add('hidden');
            document.getElementById('supportingDocsSection').classList.add('hidden');

            updatePartyDropdown();

            if (txn) {
                document.getElementById('txnCategory').value  = txn.txnCategory;
                document.getElementById('txnDirection').value = txn.txnDirection;
                document.getElementById('txnParty').value     = txn.partyName;
                document.getElementById('txnCurrency').value  = txn.currency || 'INR';
                document.getElementById('txnStatus').value    = txn.status;
                (txn.items || []).forEach(item => addLineItem(item));
                // Set reference AFTER updateReferenceField populates the dropdown
            } else {
                // New transaction defaults
                document.getElementById('txnCategory').value  = 'QUOTATION';
                document.getElementById('txnDirection').value = 'Outgoing';
                document.getElementById('txnStatus').value    = 'Draft';
            }

            // Wire change listeners (remove old ones by cloning elements)
            ['txnCategory','txnDirection','txnStatus'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const clone = el.cloneNode(true);
                el.parentNode.replaceChild(clone, el);
            });
            document.getElementById('txnCategory').addEventListener('change', () => { toggleSupportingDocs(); updateReferenceField(); updateTxnBankSection(); });
            document.getElementById('txnDirection').addEventListener('change', () => { updatePartyDropdown(); updateReferenceField(); updateTxnBankSection(); });
            document.getElementById('txnStatus').addEventListener('change', toggleSupportingDocs);

            // Populate reference dropdown first, THEN set saved value
            updateReferenceField();
            if (txn && txn.reference) {
                document.getElementById('txnReference').value = txn.reference;
                // Try to match reference type from saved text
                const sel = document.getElementById('txnReferenceType');
                const key = txn.txnCategory + '_' + txn.txnDirection;
                const opts = REFERENCE_OPTIONS[key] || [];
                const match = opts.find(o => txn.reference.startsWith(o));
                if (match) sel.value = match;
            }

            // Load bank account if exists
            if (txn && txn.bankAccountId) {
                document.getElementById('txnBankAccount').value = txn.bankAccountId;
            }

            toggleSupportingDocs();
            updateTxnBankSection();  // Show/hide and populate bank dropdown
            document.getElementById('transactionModal').classList.add('show');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('show');
            document.getElementById('transactionForm').reset();
            lineItemCounter = 0;
        }

        function updatePartyDropdown() {
            const direction = document.getElementById('txnDirection').value;
            const partySelect = document.getElementById('txnParty');
            const filteredParties = parties.filter(p => 
                direction === 'Outgoing' ? p.partyType === 'Client' : p.partyType === 'SubContractor'
            );
            
            partySelect.innerHTML = '<option value="">Select Party</option>' + 
                filteredParties.map(p => `<option value="${p.partyName}">${p.partyName}</option>`).join('');
        }

        // Enhanced addLineItem with smart GST calculation
        function addLineItem(item = null) {
            lineItemCounter++;
            const id = item?.itemID || `item-${lineItemCounter}`;
            const rowNum = document.getElementById('lineItems').children.length + 1;
            
            // Determine default GST based on party and company GST
            const partyName = document.getElementById('txnParty').value;
            const party = parties.find(p => p.partyName === partyName);
            const useIGST = shouldUseIGST(settings.gstNumber, party?.gstNumber);
            
            const defaultSGST = useIGST ? 0 : (item?.sgstPct || 9);
            const defaultCGST = useIGST ? 0 : (item?.cgstPct || 9);
            const defaultIGST = useIGST ? (item?.igstPct || 18) : 0;
            
            const tr = document.createElement('tr');
            tr.id = `line-${id}`;
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="border px-2 py-2 text-center">${rowNum}</td>
                <td class="border px-2 py-2">
                    <input type="text" placeholder="Description" value="${item?.description || ''}" 
                        class="item-desc w-full px-2 py-1 border rounded text-sm" required />
                </td>
                <td class="border px-2 py-2">
                    <input type="text" placeholder="HSN" value="${item?.hsnCode || ''}" 
                        class="item-hsn w-full px-2 py-1 border rounded text-sm" />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.qty || 1}" 
                        class="item-qty w-full px-2 py-1 border rounded text-sm" min="0" step="0.01" required />
                </td>
                <td class="border px-2 py-2">
                    <select class="item-uom w-full px-2 py-1 border rounded text-sm">
                        <option value="NOS" ${item?.uom === 'NOS' ? 'selected' : ''}>NOS</option>
                        <option value="KG" ${item?.uom === 'KG' ? 'selected' : ''}>KG</option>
                        <option value="MTR" ${item?.uom === 'MTR' ? 'selected' : ''}>MTR</option>
                        <option value="LTR" ${item?.uom === 'LTR' ? 'selected' : ''}>LTR</option>
                        <option value="BOX" ${item?.uom === 'BOX' ? 'selected' : ''}>BOX</option>
                        <option value="SET" ${item?.uom === 'SET' ? 'selected' : ''}>SET</option>
                        <option value="PKT" ${item?.uom === 'PKT' ? 'selected' : ''}>PKT</option>
                        <option value="HRS" ${item?.uom === 'HRS' ? 'selected' : ''}>HRS</option>
                        <option value="DAY" ${item?.uom === 'DAY' ? 'selected' : ''}>DAY</option>
                        <option value="WKS" ${item?.uom === 'WKS' ? 'selected' : ''}>WKS</option>
                        <option value="MTH" ${item?.uom === 'MTH' ? 'selected' : ''}>MTH</option>
                        <option value="JOB" ${item?.uom === 'JOB' ? 'selected' : ''}>JOB</option>
                    </select>
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0.00" value="${item?.rate || 0}" 
                        class="item-rate w-full px-2 py-1 border rounded text-sm" min="0" step="0.01" required />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${item?.discountPct || 0}" 
                        class="item-discount w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" />
                </td>
                <td class="border px-2 py-2 text-right">
                    <span class="item-taxable font-medium text-sm">0.00</span>
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${defaultSGST}" 
                        class="item-sgst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" ${useIGST ? 'readonly style="background:#f3f4f6"' : ''} />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${defaultCGST}" 
                        class="item-cgst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" ${useIGST ? 'readonly style="background:#f3f4f6"' : ''} />
                </td>
                <td class="border px-2 py-2">
                    <input type="number" placeholder="0" value="${defaultIGST}" 
                        class="item-igst w-full px-2 py-1 border rounded text-sm" min="0" max="100" step="0.01" ${!useIGST ? 'readonly style="background:#f3f4f6"' : ''} />
                </td>
                <td class="border px-2 py-2 text-right">
                    <span class="item-total font-bold text-sm">0.00</span>
                </td>
                <td class="border px-2 py-2 text-center">
                    <button type="button" onclick="removeLineItem('${id}')" 
                        class="text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>
                </td>
            `;
            
            document.getElementById('lineItems').appendChild(tr);
            document.getElementById('totalSection').classList.remove('hidden');
            
            tr.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', updateTotals);
                input.addEventListener('change', updateTotals);
            });
            
            updateTotals();
        }

        function removeLineItem(id) {
            document.getElementById(`line-${id}`).remove();
            if (document.getElementById('lineItems').children.length === 0) {
                document.getElementById('totalSection').classList.add('hidden');
            }
            updateTotals();
        }

        function updateTotals() {
            const rows = Array.from(document.getElementById('lineItems').children);
            const currSymbol = getCurrencySymbol();
            let grandSubtotal = 0;
            let grandTax = 0;
            let grandTotal = 0;
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate')?.value) || 0;
                const discountPct = parseFloat(row.querySelector('.item-discount')?.value) || 0;
                const sgstPct = parseFloat(row.querySelector('.item-sgst')?.value) || 0;
                const cgstPct = parseFloat(row.querySelector('.item-cgst')?.value) || 0;
                const igstPct = parseFloat(row.querySelector('.item-igst')?.value) || 0;
                
                const itemTotal = qty * rate;
                const discountAmount = (itemTotal * discountPct) / 100;
                const taxableAmount = itemTotal - discountAmount;
                
                const sgst = (taxableAmount * sgstPct) / 100;
                const cgst = (taxableAmount * cgstPct) / 100;
                const igst = (taxableAmount * igstPct) / 100;
                const totalTax = sgst + cgst + igst;
                const lineTotal = taxableAmount + totalTax;
                
                const taxableSpan = row.querySelector('.item-taxable');
                const totalSpan = row.querySelector('.item-total');
                if (taxableSpan) taxableSpan.textContent = formatNumber(taxableAmount);
                if (totalSpan) totalSpan.textContent = formatNumber(lineTotal);
                
                grandSubtotal += taxableAmount;
                grandTax += totalTax;
                grandTotal += lineTotal;
            });
            
            document.getElementById('subtotalAmount').textContent = `${currSymbol}${formatNumber(grandSubtotal)}`;
            document.getElementById('taxAmount').textContent = `${currSymbol}${formatNumber(grandTax)}`;
            const wordsLabel = numberToWords(grandTotal);
            document.getElementById('totalAmount').textContent = `${currSymbol}${formatNumber(grandTotal)}`;
            // Update words display if element exists
            const wordsEl = document.getElementById('totalAmountWords');
            const currCode = document.getElementById('txnCurrency')?.value || 'INR';
            if (wordsEl) wordsEl.textContent = `(${currCode} ${wordsLabel})`;
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const items = Array.from(document.getElementById('lineItems').children).map((row, idx) => ({
                    itemID: `item-${idx + 1}`,
                    description: row.querySelector('.item-desc').value,
                    hsnCode: row.querySelector('.item-hsn').value,
                    qty: parseFloat(row.querySelector('.item-qty').value) || 0,
                    uom: row.querySelector('.item-uom').value,
                    rate: parseFloat(row.querySelector('.item-rate').value) || 0,
                    discountPct: parseFloat(row.querySelector('.item-discount').value) || 0,
                    sgstPct: parseFloat(row.querySelector('.item-sgst').value) || 0,
                    cgstPct: parseFloat(row.querySelector('.item-cgst').value) || 0,
                    igstPct: parseFloat(row.querySelector('.item-igst').value) || 0
                }));
                
                const txnData = {
                    txnID: currentTransaction?.txnID || generateTxnID(document.getElementById('txnCategory').value),
                    txnCategory: document.getElementById('txnCategory').value,
                    txnDirection: document.getElementById('txnDirection').value,
                    partyName: document.getElementById('txnParty').value,
                    reference: document.getElementById('txnReference').value,
                    status: document.getElementById('txnStatus').value,
                    currency: document.getElementById('txnCurrency').value,
                    bankAccountId: document.getElementById('txnBankAccount')?.value || '',
                    txnDate: currentTransaction?.txnDate || new Date().toISOString().split('T')[0],
                    attachments: currentTransaction?.attachments || [],
                    items: items,
                    convertedToInvoice: currentTransaction?.convertedToInvoice,
                    convertedFromProforma: currentTransaction?.convertedFromProforma
                };
                
                if (currentTransaction) {
                    const index = transactions.findIndex(t => t.txnID === currentTransaction.txnID);
                    transactions[index] = txnData;
                } else {
                    transactions.push(txnData);
                }
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
                
                await saveData('transactions', transactions);
                
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                closeTransactionModal();
                renderView();
            } catch (error) {
                console.error('Error in form submission:', error);
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Save';
                    submitBtn.disabled = false;
                }
            }
        });

        function editTransaction(txn) {
            openTransactionModal(txn);
        }


        // â”€â”€ Admin Unlock / Override Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _unlockTargetTxnID = null;

        function requestUnlockDelete(txn) {
            // If no PIN is set, just confirm and delete directly
            if (!settings.adminPin) {
                if (confirm(`No Admin PIN is set.\nDelete ${txn.txnID} (${txn.status}) permanently?`)) {
                    forceDeleteTransaction(txn.txnID);
                }
                return;
            }
            _unlockTargetTxnID = txn.txnID;
            // Show transaction info in modal
            document.getElementById('unlockTxnInfo').innerHTML =
                `<strong>${txn.txnID}</strong> &nbsp;Â·&nbsp; ${txn.partyName} &nbsp;Â·&nbsp;
                 <span class="font-semibold">${txn.status}</span><br/>
                 <span class="text-orange-600 text-xs">âš  This action cannot be undone.</span>`;
            document.getElementById('unlockPinInput').value = '';
            document.getElementById('unlockError').classList.add('hidden');
            document.getElementById('unlockModal').classList.add('show');
            setTimeout(() => document.getElementById('unlockPinInput').focus(), 150);
        }

        function closeUnlockModal() {
            _unlockTargetTxnID = null;
            document.getElementById('unlockModal').classList.remove('show');
            document.getElementById('unlockPinInput').value = '';
            document.getElementById('unlockError').classList.add('hidden');
        }

        function clearUnlockError() {
            document.getElementById('unlockError').classList.add('hidden');
        }

        async function confirmUnlock() {
            const entered = document.getElementById('unlockPinInput').value;
            if (entered !== settings.adminPin) {
                document.getElementById('unlockError').classList.remove('hidden');
                document.getElementById('unlockPinInput').value = '';
                document.getElementById('unlockPinInput').focus();
                return;
            }
            // PIN correct â€” delete the record
            closeUnlockModal();
            await forceDeleteTransaction(_unlockTargetTxnID);
        }

        async function forceDeleteTransaction(txnID) {
            transactions = transactions.filter(t => t.txnID !== txnID);
            await saveData('transactions', transactions);
            renderView();
        }
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


        // â”€â”€ Convert Proforma Invoice to Final Invoice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function convertToInvoice(proforma) {
            if (!confirm(`Convert Proforma ${proforma.txnID} to Final Invoice?\n\nThis will create a new Invoice with the same details.`)) return;

            // Create new Invoice with same data
            const newInvoice = {
                ...proforma,
                txnID: generateTxnID('INVOICE'),  // New Invoice ID
                txnCategory: 'INVOICE',
                status: 'Draft',
                reference: `Ref: Proforma ${proforma.txnID}` + (proforma.reference ? ' | ' + proforma.reference : ''),
                convertedFromProforma: proforma.txnID,
                createdAt: new Date().toISOString()
            };

            // Mark original Proforma as converted
            const proformaIdx = transactions.findIndex(t => t.txnID === proforma.txnID);
            if (proformaIdx >= 0) {
                transactions[proformaIdx].convertedToInvoice = newInvoice.txnID;
                transactions[proformaIdx].status = 'Converted';
            }

            // Add new Invoice
            transactions.push(newInvoice);
            await saveData('transactions', transactions);

            // Show success message
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium z-50 flex items-center gap-2';
            toast.innerHTML = `<svg width="16" height="16" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Converted to Invoice ${newInvoice.txnID}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);

            renderView();
        }

        async function deleteTransaction(txnID) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.txnID !== txnID);
                await saveData('transactions', transactions);
                renderView();
            }
        }

        // Party Modal
        function openPartyModal(party = null) {
            currentParty = party;
            document.getElementById('partyModalTitle').textContent = party ? 'Edit Party' : 'New Party';
            
            if (party) {
                document.getElementById('partyName').value = party.partyName;
                document.getElementById('partyType').value = party.partyType;
                document.getElementById('partyAddress').value = party.address || '';
                document.getElementById('partyGST').value = party.gstNumber || '';
                document.getElementById('partyPAN').value = party.panNumber || '';
                document.getElementById('partyContact').value = party.contactPerson || '';
                document.getElementById('partyEmail').value = party.email || '';
                document.getElementById('partyMobile').value = party.mobile || '';
            }
            
            document.getElementById('partyModal').classList.add('show');
        }

        function closePartyModal() {
            document.getElementById('partyModal').classList.remove('show');
            document.getElementById('partyForm').reset();
        }

        document.getElementById('partyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const partyData = {
                partyID: currentParty?.partyID || Date.now().toString(36),
                partyName: document.getElementById('partyName').value,
                partyType: document.getElementById('partyType').value,
                address: document.getElementById('partyAddress').value,
                gstNumber: document.getElementById('partyGST').value,
                panNumber: document.getElementById('partyPAN').value,
                contactPerson: document.getElementById('partyContact').value,
                email: document.getElementById('partyEmail').value,
                mobile: document.getElementById('partyMobile').value
            };
            
            if (currentParty) {
                const index = parties.findIndex(p => p.partyID === currentParty.partyID);
                parties[index] = partyData;
            } else {
                parties.push(partyData);
            }
            
            await saveData('parties', parties);
            closePartyModal();
            renderView();
        });

        function editParty(party) {
            openPartyModal(party);
        }

        async function deleteParty(partyID) {
            if (confirm('Delete this party?')) {
                parties = parties.filter(p => p.partyID !== partyID);
                await saveData('parties', parties);
                renderView();
            }
        }



        // Reference dropdown options based on category + direction
        const REFERENCE_OPTIONS = {
            'QUOTATION_Outgoing':   ['Ref Email Dated', 'Ref Meeting Dated', 'Ref Enquiry Dated'],
            'INVOICE_Outgoing':     ['Ref PO and Quotation', 'Ref PO No', 'Ref Quotation No'],
            'CREDIT_NOTE_Outgoing': ['Ref Invoice No', 'Ref Invoice Dated'],
            'PO_Incoming':          ['Ref Email and Quotation', 'Ref Email Dated', 'Ref Quotation No'],
            'INVOICE_Incoming':     ['Ref PO No', 'Ref Work Order'],
            'CREDIT_NOTE_Incoming': ['Ref Invoice No'],
            'QUOTATION_Incoming':   ['Ref RFQ No', 'Ref Email Dated'],
            'PO_Outgoing':          ['Ref Email and Quotation', 'Ref Quotation No']
        };

        function updateReferenceField() {
            const cat  = document.getElementById('txnCategory')?.value  || '';
            const dir  = document.getElementById('txnDirection')?.value || '';
            const sel  = document.getElementById('txnReferenceType');
            if (!sel) return;
            const key  = cat + '_' + dir;
            const opts = REFERENCE_OPTIONS[key] || [];
            const currentRef = document.getElementById('txnReference')?.value || '';

            sel.innerHTML = '<option value="">-- Select Reference Type --</option>' +
                opts.map(o => `<option value="${o}">${o}</option>`).join('');

            // If editing existing txn, try to match saved reference type
            if (currentRef) {
                const match = opts.find(o => currentRef.startsWith(o));
                if (match) sel.value = match;
            }
        }


        // Toggle Admin PIN change section in Settings

        function toggleSettingsPasswordSection() {
            const section = document.getElementById('settingsPasswordSection');
            const btn = document.getElementById('settingsPasswordToggleBtn');
            if (!section || !btn) return;

            const isHidden = section.classList.contains('hidden');
            if (isHidden) {
                section.classList.remove('hidden');
                btn.textContent = 'âœ• Cancel';
            } else {
                section.classList.add('hidden');
                btn.textContent = 'ðŸ”‘ Change Password';
                // Clear fields
                document.getElementById('settingsPasswordNew').value = '';
                document.getElementById('settingsPasswordConfirm').value = '';
            }
        }

        function toggleAdminPinSection() {
            const sec = document.getElementById('adminPinSection');
            if (!sec) return;
            const isHidden = sec.classList.contains('hidden');
            sec.classList.toggle('hidden');
            if (isHidden) {
                // Focus first field when opening
                setTimeout(() => document.getElementById('adminPin')?.focus(), 100);
            } else {
                // Clear fields when closing
                const p1 = document.getElementById('adminPin');
                const p2 = document.getElementById('adminPinConfirm');
                if (p1) p1.value = '';
                if (p2) p2.value = '';
            }
        }

        // Logo upload handlers
        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) { alert('Logo must be under 1 MB'); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                settings.logoData = e.target.result;
                await saveData('settings', settings);
                renderView(); // refresh settings page to show new logo
            };
            reader.readAsDataURL(file);
        }
        async function removeLogo() {
            if (!confirm('Remove company logo?')) return;
            settings.logoData = null;
            await saveData('settings', settings);
            renderView();
        }

        async function saveSettings(e) {
            e.preventDefault();
            
            try {
                settings = {
                    companyName: document.getElementById('companyName').value,
                    gstNumber: document.getElementById('companyGST').value,
                    companyAddress: document.getElementById('companyAddress').value,
                    msmeNumber: document.getElementById('msmeNumber')?.value || settings.msmeNumber || '',
                    spreadsheetId: settings.spreadsheetId, // Preserve spreadsheet ID
                    logoData: settings.logoData || null,   // Preserve logo
                    // Preserve old bank fields if they exist (for backward compatibility with old PDFs)
                    bankName: settings.bankName || '',
                    beneficiary: settings.beneficiary || '',
                    accountNo: settings.accountNo || '',
                    ifscCode: settings.ifscCode || '',
                    branchAddress: settings.branchAddress || '',
                    settingsPassword: (() => {
                                        const sec = document.getElementById('settingsPasswordSection');
                                        // If password section is hidden, preserve existing password
                                        if (!sec || sec.classList.contains('hidden')) return settings.settingsPassword || 'admin';
                                        const p1 = document.getElementById('settingsPasswordNew')?.value || '';
                                        const p2 = document.getElementById('settingsPasswordConfirm')?.value || '';
                                        if (p1 && p1 !== p2) { alert('Passwords do not match â€” password not changed.'); return settings.settingsPassword || 'admin'; }
                                        if (p1 && p1.length < 4) { alert('Password must be at least 4 characters.'); return settings.settingsPassword || 'admin'; }
                                        return p1 || settings.settingsPassword || 'admin';
                                    })(),
                    adminPin:   (() => {
                                    const sec = document.getElementById('adminPinSection');
                                    // If the PIN section is hidden, fields were not edited â€” preserve existing PIN
                                    if (!sec || sec.classList.contains('hidden')) return settings.adminPin || '';
                                    const p1 = document.getElementById('adminPin')?.value || '';
                                    const p2 = document.getElementById('adminPinConfirm')?.value || '';
                                    if (p1 && p1 !== p2) { alert('PINs do not match â€” PIN not changed.'); return settings.adminPin || ''; }
                                    if (p1 && p1.length < 4) { alert('PIN must be at least 4 digits.'); return settings.adminPin || ''; }
                                    return p1 || settings.adminPin || '';
                                })()
                };
                
                console.log('Saving settings:', settings);
                await saveData('settings', settings);

                // Re-render Settings so password/PIN status badges update and sections are closed
                renderView();

                // Show brief success toast (no alert popup)
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-6 right-6 bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium z-50 flex items-center gap-2';
                toast.innerHTML = '<svg width="16" height="16" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Settings saved successfully';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2800);
            } catch (error) {
                console.error('Error in saveSettings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }
                                    return p1 || settings.adminPin || '';
                                })()
                };
                
                console.log('Saving settings:', settings);
                await saveData('settings', settings);

                // Re-render Settings so password/PIN status badges update and sections are closed
                renderView();

                // Show brief success toast (no alert popup)
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-6 right-6 bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium z-50 flex items-center gap-2';
                toast.innerHTML = '<svg width="16" height="16" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Settings saved successfully';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2800);
            } catch (error) {
                console.error('Error in saveSettings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }

        // Deep-link handler: #pdf=TXN_ID triggers immediate PDF export
        function handleDeepLink() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#pdf=')) {
                const txnID = decodeURIComponent(hash.slice(5));
                // Wait for data to load then export
                const tryExport = () => {
                    const txn = transactions.find(t => t.txnID === txnID);
                    if (txn) {
                        window.location.hash = ''; // clear hash
                        exportTransactionToPDF(txn);
                    } else if (transactions.length === 0) {
                        setTimeout(tryExport, 500); // wait for data load
                    }
                };
                setTimeout(tryExport, 1000);
            }
        }

        // Initialize
        window.onload = () => {
            gapiLoaded();
            gisLoaded();
        };
        
        // Update party dropdown when direction changes
        document.addEventListener('DOMContentLoaded', () => {
            const directionSelect = document.getElementById('txnDirection');
            if (directionSelect) {
                directionSelect.addEventListener('change', updatePartyDropdown);
            }
            
            const currencySelect = document.getElementById('txnCurrency');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateTotals);
            }
        });
    </script>
</body>
</html>
