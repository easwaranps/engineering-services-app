<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engineering Services Management</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<div id="app"></div>

<script>
const CLIENT_ID = "807569986194-feca4li2k0t96tbbutlpu2ko64obe95k.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const APP_FOLDER_NAME = "EngineeringServicesApp";

let tokenClient;
let accessToken = null;
let appFolderId = null;
let transactions = [];

/* ---------- INIT ---------- */

function gapiLoaded(){
  gapi.load("client", async ()=>{
    await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
    renderLogin();
  });
}

function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback:(resp)=>{
      accessToken = resp.access_token;
      gapi.client.setToken({access_token:accessToken});
      renderApp();
    }
  });
}

window.onload = ()=>{
  gapiLoaded();
  gisLoaded();
};

/* ---------- LOGIN UI ---------- */

function renderLogin(){
  document.getElementById("app").innerHTML = `
  <div class="flex justify-center items-center h-screen">
    <button onclick="tokenClient.requestAccessToken()"
      class="px-6 py-3 bg-blue-600 text-white rounded">
      Sign in with Google
    </button>
  </div>`;
}

function renderApp(){
  document.getElementById("app").innerHTML = `
  <div class="p-10">
    <h1 class="text-2xl mb-4">Engineering App</h1>
    <button onclick="testSave()"
      class="px-6 py-3 bg-green-600 text-white rounded">
      Test Save to Drive
    </button>
  </div>`;
}

/* ---------- DRIVE ---------- */

async function getOrCreateFolder(){
  if(appFolderId) return appFolderId;

  const res = await gapi.client.drive.files.list({
    q:`name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    fields:"files(id)"
  });

  if(res.result.files.length){
    appFolderId = res.result.files[0].id;
    return appFolderId;
  }

  const folder = await gapi.client.drive.files.create({
    resource:{name:APP_FOLDER_NAME,mimeType:"application/vnd.google-apps.folder"},
    fields:"id"
  });

  appFolderId = folder.result.id;
  return appFolderId;
}

async function saveFileToDrive(fileName,data){

  const folderId = await getOrCreateFolder();

  const search = await gapi.client.drive.files.list({
    q:`name='${fileName}' and '${folderId}' in parents and trashed=false`,
    fields:"files(id)"
  });

  const boundary="foo_bar";
  const delimiter=`\r\n--${boundary}\r\n`;
  const close=`\r\n--${boundary}--`;

  let metadata={name:fileName,mimeType:"application/json"};

  /* ---------- UPDATE ---------- */
  if(search.result.files.length){

    const fileId=search.result.files[0].id;

    const body =
      delimiter+"Content-Type: application/json\r\n\r\n"+
      JSON.stringify(metadata)+
      delimiter+"Content-Type: application/json\r\n\r\n"+
      JSON.stringify(data)+
      close;

    await gapi.client.request({
      path:`/upload/drive/v3/files/${fileId}`,
      method:"PATCH",
      params:{uploadType:"multipart"},
      headers:{'Content-Type':`multipart/related; boundary=${boundary}`},
      body:body
    });

  } else {

    /* ---------- CREATE ---------- */
    metadata.parents=[folderId];

    const body =
      delimiter+"Content-Type: application/json\r\n\r\n"+
      JSON.stringify(metadata)+
      delimiter+"Content-Type: application/json\r\n\r\n"+
      JSON.stringify(data)+
      close;

    await gapi.client.request({
      path:"/upload/drive/v3/files",
      method:"POST",
      params:{uploadType:"multipart"},
      headers:{'Content-Type':`multipart/related; boundary=${boundary}`},
      body:body
    });
  }

  alert("Saved to Drive!");
}

/* ---------- TEST ---------- */

async function testSave(){
  const sample={time:new Date(),note:"Test OK"};
  await saveFileToDrive("transactions.json",sample);
}
</script>

</body>
</html>
