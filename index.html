<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engineering Services Management System</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<!-- ✅ ADDED: jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.modal{display:none;position:fixed;z-index:50;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
.modal.show{display:flex;align-items:center;justify-content:center;}
</style>
</head>

<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">

<div id="app"></div>

<!-- Transaction Modal -->
<div id="transactionModal" class="modal">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl m-4">
<div class="bg-indigo-600 p-6 text-white">
<h2 class="text-2xl font-bold" id="modalTitle">New Transaction</h2>
</div>

<form id="transactionForm" class="p-6">

<select id="txnCategory" class="border p-2 mb-2">
<option value="QUOTATION">Quotation</option>
<option value="PO">Purchase Order</option>
<option value="INVOICE">Invoice</option>
</select>

<select id="txnDirection" class="border p-2 mb-2">
<option value="Outgoing">Outgoing</option>
<option value="Incoming">Incoming</option>
</select>

<select id="txnParty" class="border p-2 mb-2"></select>

<input id="txnReference" placeholder="Reference" class="border p-2 mb-2">

<select id="txnStatus" class="border p-2 mb-4">
<option>Draft</option><option>Sent</option>
<option>Approved</option><option>Paid</option>
</select>

<div id="lineItems"></div>

<button type="button" onclick="addLineItem()" class="bg-indigo-600 text-white px-4 py-2 rounded">
+ Add Item
</button>

<div class="mt-4">
Subtotal ₹<span id="subtotalAmount">0</span><br>
Tax ₹<span id="taxAmount">0</span><br>
Total ₹<span id="totalAmount">0</span>
</div>

<div class="mt-4">
<button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Save</button>
<button type="button" onclick="closeTransactionModal()" class="ml-2 border px-4 py-2">Cancel</button>
</div>

</form>
</div>
</div>

<script>
const CLIENT_ID='807569986194-feca4li2k0t96tbbutlpu2ko64obe95k.apps.googleusercontent.com';
const DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES='https://www.googleapis.com/auth/drive.file';

let tokenClient,accessToken=null;
let transactions=[],parties=[],settings={};
let currentView='dashboard',currentTransaction=null;
let lineItemCounter=0;

/* Google Init */
function gapiLoaded(){
gapi.load('client',async()=>{await gapi.client.init({discoveryDocs:DISCOVERY_DOCS});renderLoginScreen();});
}
function gisLoaded(){
tokenClient=google.accounts.oauth2.initTokenClient({
client_id:CLIENT_ID,
scope:SCOPES,
callback:(r)=>{accessToken=r.access_token;gapi.client.setToken({access_token:accessToken});loadData();}
});
}
function handleSignIn(){tokenClient.requestAccessToken({prompt:'consent'});}

/* UI */
function renderLoginScreen(){
document.getElementById('app').innerHTML=
`<div class="p-10 text-center">
<button onclick="handleSignIn()" class="bg-blue-600 text-white px-6 py-3 rounded">
Sign in with Google
</button></div>`;
}

function renderApp(){
document.getElementById('app').innerHTML=
`<button onclick="openTransactionModal()" class="bg-indigo-600 text-white px-4 py-2">New Transaction</button>
<div id="mainContent"></div>`;
renderTransactions(document.getElementById('mainContent'));
}

function renderTransactions(content){
content.innerHTML=
`<table class="w-full mt-4 border">
<tr><th>ID</th><th>Party</th><th>Status</th><th>Action</th></tr>
${transactions.map(t=>`
<tr>
<td>${t.txnID}</td>
<td>${t.partyName}</td>
<td>${t.status}</td>
<td>
<button onclick='generateInvoicePDF(${JSON.stringify(t)})' class="text-green-600">PDF</button>
</td>
</tr>`).join('')}
</table>`;
}

/* Line Items */
function addLineItem(){
lineItemCounter++;
let d=document.createElement('div');
d.innerHTML=
`<input class="desc border p-1" placeholder="Desc">
<input type="number" class="qty border p-1" value="1">
<input type="number" class="rate border p-1" value="0">
<input type="number" class="sgst border p-1" value="9">`;
document.getElementById('lineItems').appendChild(d);
}

/* Save */
document.getElementById('transactionForm').onsubmit=(e)=>{
e.preventDefault();
let txn={txnID:'INV'+Date.now(),partyName:'Client',status:'Draft',items:[]};
transactions.push(txn);
renderApp();
closeTransactionModal();
};

function openTransactionModal(){document.getElementById('transactionModal').classList.add('show');}
function closeTransactionModal(){document.getElementById('transactionModal').classList.remove('show');}

/* ===== PDF FUNCTION ===== */
async function generateInvoicePDF(txn){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();

let y=20;

doc.setFontSize(18);
doc.text(settings.companyName||"Engineering Services",14,y);
doc.setFontSize(10);
doc.text("GSTIN: "+(settings.gstNumber||""),14,y+=6);

doc.setFontSize(16);
doc.text("TAX INVOICE",150,20);

y+=15;
doc.text("Invoice No: "+txn.txnID,14,y);
doc.text("Date: "+new Date().toLocaleDateString(),140,y);

doc.text("Bill To:",14,y+=10);
doc.text(txn.partyName||"",14,y+=6);

y+=10;
doc.text("SNo",14,y);
doc.text("Description",25,y);
doc.text("Total",170,y);

let total=0;
(txn.items||[]).forEach((it,i)=>{
doc.text(String(i+1),14,y+=8);
doc.text(it.description||"",25,y);
doc.text("0",170,y);
});

y+=15;
doc.text("Grand Total: ₹"+total.toFixed(2),140,y);

y+=20;
doc.text("Bank Details:",14,y);
doc.text("Bank: ____________",14,y+=6);
doc.text("A/C: ____________",14,y+=6);
doc.text("IFSC: ____________",14,y+=6);

doc.text("Authorized Signatory",140,y+=20);
doc.save(txn.txnID+".pdf");
}

/* Init */
window.onload=()=>{gapiLoaded();gisLoaded();}
</script>

</body>
</html>
